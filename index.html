<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EBP Case Vignette Randomizer & Note Builder</title>
  <style>
    :root{
      --bg:#f6f7fb;--card:#ffffff;--ink:#1f2937;--muted:#6b7280;--primary:#6d28d9;--primary-ink:#fff;--ring:#c4b5fd;--ok:#059669;--warn:#b45309;--err:#b91c1c;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";color:var(--ink);background:var(--bg)}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .title{font-weight:800;font-size:20px;letter-spacing:.2px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px}
    button{appearance:none;border:1px solid transparent;background:var(--primary);color:var(--primary-ink);padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
    button.ghost{background:transparent;color:var(--ink);border-color:#e5e7eb}
    button.secondary{background:#111827;color:#fff}
    button:disabled{opacity:.55;cursor:not-allowed}
    .grid{display:grid;grid-template-columns:1fr 1.3fr;gap:16px}
    @media (max-width: 960px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:16px}
    .card h2{margin:0 0 8px 0;font-size:18px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    label{font-size:12px;color:#374151;font-weight:600}
    input, textarea, select{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;color:var(--ink);font:inherit}
    textarea{min-height:110px;resize:vertical}
    .kvs{display:grid;grid-template-columns:160px 1fr;gap:8px}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;font-size:12px}
    .list{display:flex;flex-direction:column;gap:10px}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px dashed #d1d5db;border-radius:999px;padding:6px 10px;font-size:12px}
    .hr{height:1px;background:#eef0f4;margin:12px 0}
    .monospace{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .right{margin-left:auto}
    .warn{color:var(--warn)}
    .ok{color:var(--ok)}
    .err{color:var(--err)}
    .chip{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;font-size:12px}
    .study{border:1px solid #e5e7eb;border-radius:12px;padding:12px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid #f0f2f7;padding:8px;text-align:left}
    .inline{display:inline}
    .counter{font-size:12px;color:var(--muted)}
    .status{font-size:12px}
    .footer{margin-top:14px;font-size:12px;color:var(--muted);display:flex;gap:8px;align-items:center}
    .focus-ring:focus{outline:3px solid var(--ring);outline-offset:2px}
    .spin{animation:spin 1s linear infinite;display:inline-block}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="row">
        <div class="title">EBP Case Vignette Randomizer & Note Builder</div>
        <span class="badge">No login ‚Ä¢ Works offline ‚Ä¢ Exports Markdown</span>
      </div>
      <div class="toolbar" role="toolbar" aria-label="Main">
        <button id="btnRandom" class="focus-ring" title="Randomize a case (R)">üé≤ Randomize</button>
        <button id="btnLock" class="ghost focus-ring" title="Lock/unlock the current case (L)">üîí Lock</button>
        <button id="btnNew" class="ghost focus-ring" title="Start a fresh note (N)">üßº New</button>
        <button id="btnSave" class="ghost focus-ring" title="Save to this browser (S)">üíæ Save</button>
        <button id="btnLoad" class="ghost focus-ring" title="Load last (O)">üìÇ Load</button>
        <button id="btnExport" class="secondary focus-ring" title="Export to Markdown (E)">‚¨áÔ∏è Export MD</button>
        <button id="btnCopy" class="ghost focus-ring" title="Copy Markdown">üìã Copy MD</button>
        <button id="btnPrint" class="ghost focus-ring" title="Print (P)">üñ®Ô∏è Print</button>
      </div>
    </header>

    <div class="grid" id="app">
      <section class="card" aria-labelledby="caseTitle">
        <h2 id="caseTitle">Case Vignette</h2>
        <div id="caseEmpty" class="muted">Click <strong>Randomize</strong> to draw a client vignette. Lock to begin the EBP note.</div>
        <div id="caseWrap" hidden>
          <div class="row" style="justify-content:space-between;align-items:flex-start">
            <div>
              <div class="badge" id="caseId">ID</div>
            </div>
            <div class="status" id="lockStatus"></div>
          </div>
          <div class="hr"></div>
          <div class="kvs">
            <div class="muted">Client</div><div id="vClient"></div>
            <div class="muted">Identities & Culture</div><div id="vIdent"></div>
            <div class="muted">Context</div><div id="vContext"></div>
            <div class="muted">Presenting Problem</div><div id="vProblem"></div>
            <div class="muted">Goals/Preferences</div><div id="vGoals"></div>
            <div class="muted">Constraints</div><div id="vConstraints"></div>
            <div class="muted">Risks/Ethics</div><div id="vRisks"></div>
            <div class="muted">Consent Note</div><div id="vConsent"></div>
          </div>
          <div class="hr"></div>
          <div class="list">
            <div class="pill">Equity signal: ensure voice, autonomy, and representation in evidence.</div>
            <div class="pill">Tip: your question should reflect the client's goals, not just symptoms.</div>
          </div>
        </div>
      </section>

      <section class="card" aria-labelledby="builderTitle">
        <h2 id="builderTitle">EBP Process Note Builder</h2>
        <div id="lockGate" class="muted">Lock a case to enable editing.</div>
        <div id="builder" hidden>
          <!-- (1) Client & Context -->
          <div class="field">
            <label for="fContext">1) Client & Practice Context</label>
            <textarea id="fContext" placeholder="Describe the client, identities, setting, constraints, goals, and why this matters for ethical practice."></textarea>
            <div class="row"><span class="counter" id="cntContext">0 words</span></div>
          </div>

          <!-- (2) PICO(T) -->
          <div class="field">
            <label>PICO(T) Question Builder</label>
            <div class="row">
              <div class="field" style="flex:1;min-width:160px"><label for="pPop">Population</label><input id="pPop" placeholder="e.g., Latinx adolescents with mild depression"/></div>
              <div class="field" style="flex:1;min-width:160px"><label for="pInt">Intervention</label><input id="pInt" placeholder="e.g., culturally adapted CBT"/></div>
            </div>
            <div class="row">
              <div class="field" style="flex:1;min-width:160px"><label for="pComp">Comparison (optional)</label><input id="pComp" placeholder="e.g., treatment as usual"/></div>
              <div class="field" style="flex:1;min-width:160px"><label for="pOut">Outcome</label><input id="pOut" placeholder="e.g., reduction in PHQ-9"/></div>
              <div class="field" style="width:160px"><label for="pTime">Timeframe</label><input id="pTime" placeholder="e.g., 12 weeks"/></div>
            </div>
            <div class="badge monospace" id="picoPreview">PICO(T) preview‚Ä¶</div>
          </div>

          <!-- (3) Search Strategy -->
          <div class="field">
            <label for="fSearch">3) Search Strategy & Selection</label>
            <textarea id="fSearch" placeholder="Databases, keywords/MeSH, filters, inclusion/exclusion, equity/representation considerations."></textarea>
            <div class="row"><span class="counter" id="cntSearch">0 words</span></div>
          </div>

          <!-- (4) Studies -->
          <div class="field">
            <label>4) Studies: What they did and found</label>
            <div id="studyList" class="list"></div>
            <details>
              <summary class="badge">‚ûï Add a study</summary>
              <div class="study" style="margin-top:10px">
                <div class="row">
                  <div class="field" style="flex:2"><label for="sTitle">Title</label><input id="sTitle"/></div>
                  <div class="field" style="width:120px"><label for="sYear">Year</label><input id="sYear" inputmode="numeric"/></div>
                  <div class="field" style="flex:1"><label for="sDesign">Design</label><input id="sDesign" placeholder="RCT, cohort, qual, etc."/></div>
                </div>
                <div class="row">
                  <div class="field" style="flex:1"><label for="sSample">Population / sample</label><input id="sSample" placeholder="n, demographics, setting"/></div>
                  <div class="field" style="flex:1"><label for="sMethods">Methods</label><input id="sMethods" placeholder="measures, procedures"/></div>
                </div>
                <div class="field"><label for="sFindings">Key findings (your words)</label><textarea id="sFindings"></textarea></div>
                <div class="row">
                  <div class="field" style="flex:1"><label for="sLimits">Limitations</label><input id="sLimits"/></div>
                  <div class="field" style="flex:1"><label for="sEquity">Equity/representation</label><input id="sEquity" placeholder="representation, cultural fit"/></div>
                </div>
                <div class="row">
                  <div class="field" style="flex:1"><label for="sUrl">DOI/URL</label><input id="sUrl" placeholder="https://‚Ä¶ or doi:‚Ä¶"/></div>
                  <button id="btnAddStudy" class="right">Add Study</button>
                </div>
              </div>
            </details>
          </div>

          <!-- (5) Critical Appraisal -->
          <div class="field">
            <label for="fAppraise">5) Critical Appraisal</label>
            <textarea id="fAppraise" placeholder="Internal validity, external validity, bias risks, cultural responsiveness, harms/benefits, power/representation, funding/conflicts."></textarea>
            <div class="row"><span class="counter" id="cntAppraise">0 words</span></div>
          </div>

          <!-- (6) Application -->
          <div class="field">
            <label for="fApply">6) Application for this client & delivery plan</label>
            <textarea id="fApply" placeholder="What the evidence suggests for THIS client, adaptations, shared decision-making language, monitoring plan, consent, ethics."></textarea>
            <div class="row"><span class="counter" id="cntApply">0 words</span></div>
          </div>

          <!-- Rubric -->
          <div class="hr"></div>
          <div class="row" style="justify-content:space-between">
            <div class="badge">Rubric checklist</div>
            <div id="progress" class="status">0/6 sections with 100+ words</div>
          </div>
          <ul id="rubric" class="list" style="margin:8px 0 0 18px">
            <li>Client/context clearly described with equity/ethics lens</li>
            <li>Focused, researchable PICO(T) reflects client goals</li>
            <li>Transparent search & selection, includes equity considerations</li>
            <li>Accurate study summaries in your own words</li>
            <li>Critical appraisal of strength, bias, and representation</li>
            <li>Practice application & shared decision-making plan</li>
          </ul>
        </div>
      </section>
    </div>

    <div class="footer">
      <span>Autosave:</span><span id="saveStatus">idle</span>
      <span class="muted">‚Ä¢</span><span>Tip: press <span class="monospace">R</span> to randomize, <span class="monospace">L</span> to lock.</span>
    </div>
  </div>

  <script>
    // ---------- Data ----------
    const VIGNETTES = [
      { id:"A01", client:"A 16-year-old Black high school student (she/her)", identities:"Black, first-gen American; works part-time; practicing Christian; lives with grandmother",
        context:"Public school counseling office; limited private space; 20-min drop-in slots",
        problem:"Reports sleep issues and low mood after a recent suspension for a dress-code violation; distrusts staff",
        goals:"Wants to graduate on time, avoid further discipline, and feel less exhausted",
        constraints:"Irregular schedule, phone shared with family, limited transport",
        risks:"Power dynamics with school, risk of over-pathologizing responses to discrimination",
        consent:"Grandmother aware of counseling; youth consents to brief intervention" },
      { id:"A02", client:"A 34-year-old undocumented father (he/him)", identities:"Latino, Spanish-dominant; day-laborer; remits money to family abroad",
        context:"Community health center social work; interpreter available limited hours",
        problem:"Panic episodes triggered by police presence and workplace raids; avoids clinics",
        goals:"Wants to keep working and sleep through the night; avoid meds if possible",
        constraints:"No insurance; fear of systems; variable phone number",
        risks:"Legal risk, trauma exposure, potential financial exploitation",
        consent:"Verbal consent for counseling and referrals" },
      { id:"A03", client:"A 72-year-old transgender woman (she/her)", identities:"White; retired teacher; limited local LGBTQ+ community",
        context:"Rural primary care clinic linked to hospital",
        problem:"Recent fall; chronic pain; voices anxiety about disrespect in healthcare settings",
        goals:"Wants pain relief without heavy sedation; maintain independence",
        constraints:"Limited transport; scarce gender-affirming providers",
        risks:"Misgendering, disparate pain management, polypharmacy risks",
        consent:"Consents to integrated behavioral health consult" },
      { id:"A04", client:"A 27-year-old autistic college student (they/them)", identities:"Nonbinary; sensory sensitivities; international student",
        context:"University counseling; midterms period; short-term model",
        problem:"Overwhelm, shutdowns, and avoidance of group work; professor threatening grade penalties",
        goals:"Wants practical strategies to complete coursework and communicate needs",
        constraints:"Insurance caps; housing with noisy roommates",
        risks:"Ableism in accommodation process; academic dismissal risk",
        consent:"Signed consent for release to disability services" },
      { id:"A05", client:"A 9-year-old child (she/they)", identities:"Mixed Native/White; in kinship care; strong ties to tribal traditions",
        context:"Outpatient child behavioral health; caregiver attends sessions",
        problem:"Nightmares and clinginess after parental overdose; school behavior notes",
        goals:"Wants fewer nightmares; caregiver wants school to understand context",
        constraints:"Caregiver works nights; clinic waitlists",
        risks:"Intergenerational trauma; surveillance by systems",
        consent:"Caregiver provides consent; child assents" },
      { id:"A06", client:"A 45-year-old man (he/him) in recovery", identities:"Formerly incarcerated; Black; union carpenter; co-parents a 6-year-old",
        context:"Hospital ED social work after nonfatal overdose; warm handoff to MOUD clinic",
        problem:"Ambivalence about buprenorphine; pain from old injury; housing instability",
        goals:"Wants to keep custody time and keep working; reduce cravings",
        constraints:"Probation check-ins; clinic hours conflict with shifts",
        risks:"Opioid overdose recurrence; stigma from providers",
        consent:"Agrees to contact by peer recovery coach" },
      { id:"A07", client:"A 31-year-old Somali refugee (she/her)", identities:"Hijabi; speaks Somali; widowed; two children",
        context:"Resettlement agency; ESL class attached",
        problem:"Night terrors, hypervigilance, avoidance; limited trust of institutions",
        goals:"Wants to sleep, attend ESL, and feel safe taking the bus",
        constraints:"Interpreter scheduling; childcare; Islamophobic harassment",
        risks:"Re-traumatization; cultural mismatch in therapy",
        consent:"Informed consent with interpreter present" },
      { id:"A08", client:"A 60-year-old farmworker (he/him)", identities:"Mixtec-speaking; limited Spanish/English; seasonal migrant",
        context:"Mobile clinic; pesticide exposure monitoring program",
        problem:"Rash and dizziness after recent spraying; fear of job loss if reporting",
        goals:"Wants symptoms to stop; continue working; protect crew",
        constraints:"Language access; employer retaliation risk",
        risks:"Occupational hazards; immigration-related fear",
        consent:"Agrees to anonymous reporting if possible" },
      { id:"A09", client:"A 24-year-old queer woman (she/her)", identities:"Chinese American; first-gen college grad; hourly service worker",
        context:"Community mental health; sliding scale; telehealth possible",
        problem:"Panic in crowded transit; conflict with parents about sexuality",
        goals:"Wants to ride subway comfortably and maintain family ties",
        constraints:"Shift work; shared apartment; privacy limits",
        risks:"Family rejection; financial precarity",
        consent:"Consents to telehealth and safety planning" },
      { id:"A10", client:"A 53-year-old veteran (he/him)", identities:"Puerto Rican; bilingual; service-connected disability; faith community leader",
        context:"VA-affiliated outpatient clinic",
        problem:"Chronic pain, insomnia, and irritability; conflicts at home",
        goals:"Wants to improve sleep and be more patient with family",
        constraints:"Transportation, past negative experiences with providers",
        risks:"Risk of alcohol overuse; moral injury themes",
        consent:"Consents to include spouse in some sessions" }
    ];

    // ---------- State ----------
    const $ = (sel)=>document.querySelector(sel);
    let current = null; // current vignette
    let locked = false;
    let studies = []; // {id,title,year,design,sample,methods,findings,limits,equity,url}

    const F = {
      context: $('#fContext'), search: $('#fSearch'), appraise: $('#fAppraise'), apply: $('#fApply')
    };
    const PICO = { pop: $('#pPop'), int: $('#pInt'), comp: $('#pComp'), out: $('#pOut'), time: $('#pTime'), preview: $('#picoPreview') };

    const els = {
      caseEmpty: $('#caseEmpty'), caseWrap: $('#caseWrap'), caseId: $('#caseId'), lockStatus: $('#lockStatus'),
      vClient: $('#vClient'), vIdent: $('#vIdent'), vContext: $('#vContext'), vProblem: $('#vProblem'), vGoals: $('#vGoals'), vConstraints: $('#vConstraints'), vRisks: $('#vRisks'), vConsent: $('#vConsent'),
      lockGate: $('#lockGate'), builder: $('#builder'),
      studyList: $('#studyList'), saveStatus: $('#saveStatus'), progress: $('#progress')
    };

    // ---------- Utils ----------
    const uid = ()=>Math.random().toString(36).slice(2,9);
    const nowISO = ()=>new Date().toISOString();
    const wordCount = (s)=> (s||"").trim().split(/\s+/).filter(Boolean).length;
    const sanitize = (s)=> (s||"").toString().replace(/[\t\r]/g,' ').trim();
    const debounce = (fn, ms=800)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(null,a), ms); }; };

    const autoKey = ()=> current ? `EBP_NOTE_${current.id}` : 'EBP_NOTE_UNSET';

    function picoPreview(){
      const p = [PICO.pop.value, PICO.int.value, PICO.comp.value, PICO.out.value, PICO.time.value].map(sanitize);
      const [pop,intv,comp,out,time] = p;
      let q = `In ${pop||'__'}, does ${intv||'__'} ${comp?(' compared to '+comp):''} improve ${out||'__'}${time?(' over '+time):''}?`;
      PICO.preview.textContent = q;
    }

    function updateCounters(){
      $('#cntContext').textContent = `${wordCount(F.context.value)} words`;
      $('#cntSearch').textContent = `${wordCount(F.search.value)} words`;
      $('#cntAppraise').textContent = `${wordCount(F.appraise.value)} words`;
      $('#cntApply').textContent = `${wordCount(F.apply.value)} words`;
      const hits = [F.context,F.search,F.appraise,F.apply].filter(x=>wordCount(x.value)>=100).length;
      els.progress.textContent = `${hits}/6 sections with 100+ words`;
    }

    function renderCase(){
      if(!current){ els.caseWrap.hidden=true; els.caseEmpty.hidden=false; return; }
      els.caseEmpty.hidden=true; els.caseWrap.hidden=false;
      els.caseId.textContent = `Case ${current.id}`;
      els.vClient.textContent = current.client;
      els.vIdent.textContent = current.identities;
      els.vContext.textContent = current.context;
      els.vProblem.textContent = current.problem;
      els.vGoals.textContent = current.goals;
      els.vConstraints.textContent = current.constraints;
      els.vRisks.textContent = current.risks;
      els.vConsent.textContent = current.consent;
      updateLockUi();
    }

    function updateLockUi(){
      els.lockStatus.innerHTML = locked ? '<span class="ok">Locked for editing</span>' : '<span class="warn">Unlocked</span>';
      $('#btnLock').textContent = locked ? 'üîì Unlock' : 'üîí Lock';
      els.lockGate.hidden = locked;
      els.builder.hidden = !locked;
    }

    function randomize(){
      const b = $('#btnRandom');
      b.disabled = true; b.innerHTML = '<span class="spin">üé≤</span> Rolling‚Ä¶';
      setTimeout(()=>{
        current = VIGNETTES[Math.floor(Math.random()*VIGNETTES.length)];
        locked = false; studies = [];
        clearAllFields();
        renderCase(); renderStudies();
        b.disabled=false; b.textContent='üé≤ Randomize';
        toast('New case drawn. Review and lock to start.');
      }, 650);
    }

    function clearAllFields(){
      for(const el of Object.values(F)) el.value='';
      for(const el of [PICO.pop,PICO.int,PICO.comp,PICO.out,PICO.time]) el.value='';
      picoPreview(); updateCounters();
    }

    function toggleLock(){
      if(!current){ toast('Draw a case first.'); return; }
      locked = !locked; updateLockUi();
      if(locked){ loadDraft(); }
    }

    function addStudy(){
      const s = {
        id: uid(),
        title: sanitize($('#sTitle').value),
        year: sanitize($('#sYear').value),
        design: sanitize($('#sDesign').value),
        sample: sanitize($('#sSample').value),
        methods: sanitize($('#sMethods').value),
        findings: sanitize($('#sFindings').value),
        limits: sanitize($('#sLimits').value),
        equity: sanitize($('#sEquity').value),
        url: sanitize($('#sUrl').value)
      };
      if(!s.title || !s.findings){ toast('Title and findings are required for a study.'); return; }
      if(s.year && !/^\d{4}$/.test(s.year)){ toast('Year must be 4 digits.'); return; }
      studies.push(s); renderStudies();
      ['#sTitle','#sYear','#sDesign','#sSample','#sMethods','#sFindings','#sLimits','#sEquity','#sUrl'].forEach(sel=>$(sel).value='');
      autosave();
    }

    function removeStudy(id){
      studies = studies.filter(x=>x.id!==id); renderStudies(); autosave();
    }

    function renderStudies(){
      const wrap = els.studyList; wrap.innerHTML = '';
      if(studies.length===0){
        const p = document.createElement('div'); p.className='muted'; p.textContent='No studies yet. Add at least 2‚Äì3 relevant peer‚Äëreviewed sources.'; wrap.appendChild(p); return;
      }
      for(const s of studies){
        const div = document.createElement('div'); div.className='study';
        div.innerHTML = `
          <div class="row"><strong>${escapeHtml(s.title)}</strong> <span class="chip">${s.design||'Design n/a'}</span> <span class="chip">${s.year||'Year n/a'}</span> <button class="ghost right" data-id="${s.id}">Remove</button></div>
          <div class="kvs" style="margin-top:6px">
            <div class="muted">Population</div><div>${escapeHtml(s.sample||'‚Äî')}</div>
            <div class="muted">Methods</div><div>${escapeHtml(s.methods||'‚Äî')}</div>
            <div class="muted">Findings</div><div>${escapeHtml(s.findings||'‚Äî')}</div>
            <div class="muted">Limitations</div><div>${escapeHtml(s.limits||'‚Äî')}</div>
            <div class="muted">Equity</div><div>${escapeHtml(s.equity||'‚Äî')}</div>
            <div class="muted">DOI/URL</div><div>${linkify(s.url)||'‚Äî'}</div>
          </div>`;
        div.querySelector('button[data-id]').addEventListener('click',()=>removeStudy(s.id));
        wrap.appendChild(div);
      }
    }

    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
    function linkify(u){ if(!u) return ''; const safe = escapeHtml(u); return `<a href="${safe}" target="_blank" rel="noopener">${safe}</a>`; }

    // ---------- Autosave ----------
    const autosave = debounce(()=>{
      if(!current || !locked) return;
      const data = {
        case: current, locked, studies,
        fields: { context:F.context.value, search:F.search.value, appraise:F.appraise.value, apply:F.apply.value },
        pico: { pop:PICO.pop.value, int:PICO.int.value, comp:PICO.comp.value, out:PICO.out.value, time:PICO.time.value },
        ts: nowISO()
      };
      try{ localStorage.setItem(autoKey(), JSON.stringify(data)); els.saveStatus.textContent = `saved ${new Date().toLocaleTimeString()}`; }
      catch(e){ els.saveStatus.textContent = 'save failed'; }
    }, 1200);

    function loadDraft(){
      const raw = localStorage.getItem(autoKey());
      if(!raw) { els.saveStatus.textContent='no draft'; return; }
      try{
        const d = JSON.parse(raw);
        studies = Array.isArray(d.studies)? d.studies : [];
        F.context.value = d.fields?.context||'';
        F.search.value = d.fields?.search||'';
        F.appraise.value = d.fields?.appraise||'';
        F.apply.value = d.fields?.apply||'';
        PICO.pop.value = d.pico?.pop||'';
        PICO.int.value = d.pico?.int||'';
        PICO.comp.value = d.pico?.comp||'';
        PICO.out.value = d.pico?.out||'';
        PICO.time.value = d.pico?.time||'';
        picoPreview(); updateCounters(); renderStudies();
        els.saveStatus.textContent = `loaded draft (${new Date(d.ts).toLocaleString()})`;
      }catch(e){ els.saveStatus.textContent='load failed'; }
    }

    // ---------- Export / Print ----------
    function buildMarkdown(){
      if(!current) return '# EBP Process Note\n\n_No case selected._\n';
      const mdEsc = (s)=>sanitize(s).replace(/\u00A0/g,' ');
      const picoQ = PICO.preview.textContent;
      const lines = [];
      lines.push(`# EBP Process Note ‚Äî Case ${current.id}`);
      lines.push('');
      lines.push('## Case Vignette');
      lines.push(`- **Client:** ${current.client}`);
      lines.push(`- **Identities & Culture:** ${current.identities}`);
      lines.push(`- **Context:** ${current.context}`);
      lines.push(`- **Presenting Problem:** ${current.problem}`);
      lines.push(`- **Goals/Preferences:** ${current.goals}`);
      lines.push(`- **Constraints:** ${current.constraints}`);
      lines.push(`- **Risks/Ethics:** ${current.risks}`);
      lines.push('');
      lines.push('## 1) Client & Practice Context');
      lines.push(mdEsc(F.context.value));
      lines.push('');
      lines.push('## 2) PICO(T) Question');
      lines.push(`**Question:** ${picoQ}`);
      lines.push('');
      lines.push('## 3) Search Strategy & Selection');
      lines.push(mdEsc(F.search.value));
      lines.push('');
      lines.push('## 4) Studies ‚Äî Summaries');
      if(studies.length===0){ lines.push('_No studies added yet._'); }
      else{
        studies.forEach((s,i)=>{
          lines.push(`### Study ${i+1}: ${s.title}${s.year?` (${s.year})`:''}`);
          if(s.design) lines.push(`- **Design:** ${s.design}`);
          if(s.sample) lines.push(`- **Population/Sample:** ${s.sample}`);
          if(s.methods) lines.push(`- **Methods:** ${s.methods}`);
          if(s.findings) lines.push(`- **Key Findings (own words):** ${s.findings}`);
          if(s.limits) lines.push(`- **Limitations:** ${s.limits}`);
          if(s.equity) lines.push(`- **Equity/Representation:** ${s.equity}`);
          if(s.url) lines.push(`- **DOI/URL:** ${s.url}`);
          lines.push('');
        });
      }
      lines.push('## 5) Critical Appraisal');
      lines.push(mdEsc(F.appraise.value));
      lines.push('');
      lines.push('## 6) Application & Shared Decision-Making');
      lines.push(mdEsc(F.apply.value));
      lines.push('');
      lines.push('---');
      lines.push(`_Generated: ${new Date().toLocaleString()}_`);
      return lines.join('\n');
    }

    function downloadMarkdown(){
      const md = buildMarkdown();
      const blob = new Blob([md], {type:'text/markdown'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const name = current?`EBP_Note_${current.id}.md`:'EBP_Note.md';
      a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url);
      toast('Markdown downloaded.');
    }

    async function copyMarkdown(){
      const md = buildMarkdown();
      try{ await navigator.clipboard.writeText(md); toast('Markdown copied to clipboard.'); }
      catch{ toast('Copy failed. Select All and copy manually.'); }
    }

    function printPage(){ window.print(); }

    // ---------- Save / Load buttons (manual) ----------
    function manualSave(){ autosave.flush?autosave.flush():autosave(); }
    function manualLoad(){ if(!current){ toast('Select and lock a case first.'); return;} loadDraft(); }

    // Attach a flush to debounce for manual immediate save
    autosave.flush = function(){
      const fn = autosave; fn(); // immediate schedule
      // also attempt immediate write
      if(!current || !locked) return;
      const data = {
        case: current, locked, studies,
        fields: { context:F.context.value, search:F.search.value, appraise:F.appraise.value, apply:F.apply.value },
        pico: { pop:PICO.pop.value, int:PICO.int.value, comp:PICO.comp.value, out:PICO.out.value, time:PICO.time.value },
        ts: nowISO()
      };
      try{ localStorage.setItem(autoKey(), JSON.stringify(data)); els.saveStatus.textContent = `saved ${new Date().toLocaleTimeString()}`; }
      catch(e){ els.saveStatus.textContent = 'save failed'; }
    }

    // ---------- Toast ----------
    let toastTimer=null; const toastDiv = document.createElement('div');
    toastDiv.style.position='fixed'; toastDiv.style.bottom='16px'; toastDiv.style.left='50%'; toastDiv.style.transform='translateX(-50%)'; toastDiv.style.background='#111827'; toastDiv.style.color='#fff'; toastDiv.style.padding='10px 14px'; toastDiv.style.borderRadius='10px'; toastDiv.style.boxShadow='0 6px 20px rgba(0,0,0,.15)'; toastDiv.style.zIndex='9999'; toastDiv.style.display='none'; document.body.appendChild(toastDiv);
    function toast(msg){ clearTimeout(toastTimer); toastDiv.textContent=msg; toastDiv.style.display='block'; toastTimer=setTimeout(()=>toastDiv.style.display='none',1900); }

    // ---------- Events ----------
    $('#btnRandom').addEventListener('click', randomize);
    $('#btnLock').addEventListener('click', toggleLock);
    $('#btnNew').addEventListener('click', ()=>{ if(confirm('Clear current note?')){ clearAllFields(); studies=[]; renderStudies(); autosave(); }});
    $('#btnSave').addEventListener('click', manualSave);
    $('#btnLoad').addEventListener('click', manualLoad);
    $('#btnExport').addEventListener('click', downloadMarkdown);
    $('#btnCopy').addEventListener('click', copyMarkdown);
    $('#btnPrint').addEventListener('click', printPage);

    $('#btnAddStudy').addEventListener('click', addStudy);

    ;[F.context,F.search,F.appraise,F.apply].forEach(el=>{
      el.addEventListener('input', ()=>{ updateCounters(); autosave(); });
    });
    ;[PICO.pop,PICO.int,PICO.comp,PICO.out,PICO.time].forEach(el=>{
      el.addEventListener('input', ()=>{ picoPreview(); autosave(); });
    });

    // Keyboard shortcuts
    window.addEventListener('keydown', (e)=>{
      if(['INPUT','TEXTAREA'].includes(document.activeElement.tagName) && (e.ctrlKey||e.metaKey)) return; // don't interfere with editing
      if(e.key==='r' || e.key==='R'){ e.preventDefault(); randomize(); }
      if(e.key==='l' || e.key==='L'){ e.preventDefault(); toggleLock(); }
      if(e.key==='p' || e.key==='P'){ e.preventDefault(); printPage(); }
      if((e.key==='e'||e.key==='E') && locked){ e.preventDefault(); downloadMarkdown(); }
    });

    // Initial
    picoPreview(); updateCounters(); renderCase(); renderStudies();
  </script>
</body>
</html>
