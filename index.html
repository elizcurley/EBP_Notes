<script>
// --- Ctrl/Cmd+S immediate save (EBP page) ---
function saveNowEBP() {
  // Require a locked case (so they don't overwrite while browsing).
  if (!current || !locked) { toast('Lock a case to save.'); return; }
  const studyTexts = [...document.querySelectorAll('#studies textarea')].map(t => t.value);

  const data = {
    caseTitle: current.title,
    fields: {
      context: document.getElementById('fContext').value,
      search: document.getElementById('fSearch').value,
      appraise: document.getElementById('fAppraise').value,
      apply: document.getElementById('fApply').value,
      assumptions: document.getElementById('fAssumptions').value,
      pico: {
        P: document.getElementById('picoP').value,
        I: document.getElementById('picoI').value,
        C: document.getElementById('picoC').value,
        O: document.getElementById('picoO').value
      },
      studies: studyTexts
    },
    ts: new Date().toISOString()
  };

  try {
    localStorage.setItem(saveKey(), JSON.stringify(data));
    document.getElementById('saveStatus').textContent = `saved ${new Date().toLocaleTimeString()}`;
    toast('Draft saved');
  } catch {
    document.getElementById('saveStatus').textContent = 'save failed';
    toast('Save failed');
  }
}

// Add the keyboard listener (keeps your Alt+R/L/E/P too)
window.addEventListener('keydown', (e) => {
  // Ctrl+S / Cmd+S should work anywhere, even while typing.
  if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
    e.preventDefault();
    saveNowEBP();
    return;
  }
});

// Update the footer hint text
(function updateTipForSave(){
  const tip = document.getElementById('tip');
  if (!tip) return;
  if (!/Ctrl\+S/i.test(tip.textContent)) {
    tip.textContent = `${tip.textContent}  â€¢  Ctrl+S = Save Draft`;
  }
})();
</script>
