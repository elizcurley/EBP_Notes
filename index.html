<!doctype html>
<!-- =========================================================
Repo: elizcurley/EBP_Notes
File: /index.html
EBP Case Randomizer & Note Builder — single-file, offline, no deps
========================================================= -->
<html lang="en">
<head>
<meta charset="utf-8">
<title>EBP Assignment | Case Randomizer & Note Builder</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root{
    --bg:linear-gradient(135deg,#f6f7fb 0%,#eef2ff 35%,#f8fafc 100%);
    --card:#ffffff;--ink:#0f172a;--muted:#6b7280;--line:#e5e7eb;--accent:#2563eb;
    --accent-2:#7c3aed;--ok:#0a7f3f;--warn:#c2410c;--shadow:0 6px 30px rgba(15,23,42,.08)
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial,sans-serif;color:var(--ink);background:var(--bg);line-height:1.5}
  header{background:transparent;border-bottom:1px solid transparent}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .titlebar{display:flex;flex-direction:column;gap:12px;align-items:stretch}
  .course{font-size:14px;color:var(--muted)}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px}
  .toolbar.floating{position:absolute;top:14px;right:14px;justify-content:flex-end;max-width:520px;align-items:flex-start;background:rgba(255,255,255,.92);padding:8px 10px;border-radius:14px;box-shadow:0 10px 30px rgba(15,23,42,.1)}
  .hero.has-floating{padding-right:clamp(220px,34vw,520px)}
  button{border:1px solid var(--line);background:#fff;border-radius:10px;padding:9px 12px;font:inherit;cursor:pointer;box-shadow:0 1px 0 rgba(0,0,0,.02);transition:.15s ease transform,box-shadow,border-color}
  button:hover{border-color:#cbd5e1}
  button:active{transform:translateY(1px)}
  button.primary{background:linear-gradient(120deg,var(--accent),var(--accent-2));border-color:var(--accent);color:#fff;box-shadow:0 10px 30px rgba(37,99,235,.25)}
  button.ghost{background:#f8fafc;border-color:#d9e2ec}
  .status{font-size:12px;border:1px solid var(--line);padding:4px 10px;border-radius:999px;background:#fafafa}
  .status.locked{border-color:#cce9d8;background:#f0fdf4;color:var(--ok)}
  .status.unlocked{border-color:#ffe2c7;background:#fff7ed;color:var(--warn)}
  .layout{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
  @media(max-width:1024px){.layout{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid #e2e8f0;border-radius:16px;box-shadow:var(--shadow)}
  .card h2{margin:0;padding:16px;border-bottom:1px solid var(--line);font-size:18px}
  .card .body{padding:16px}
  @media(min-width:768px){
    .card.fill{min-height:calc(100vh - 210px);height:100%;display:flex;flex-direction:column}
    .card.fill .body{flex:1;overflow:auto;padding:16px}
  }
  @media(max-width:1080px){
    .toolbar.floating{position:static;max-width:none;justify-content:flex-start;background:transparent;box-shadow:none;padding:0}
    .hero.has-floating{padding-right:18px;padding-top:18px;gap:10px}
  }
  .banner{margin-top:8px;background:#eef2ff;border:1px dashed #cbd5e1;border-radius:12px;padding:10px 12px;color:#312e81;font-size:13px}
  .banner strong{color:#1e3a8a}
  .hero{position:relative;padding:18px;border-radius:14px;background:linear-gradient(115deg,rgba(37,99,235,.1),rgba(124,58,237,.12));border:1px solid #dbeafe;box-shadow:0 10px 30px rgba(37,99,235,.08)}
  .hero-title{font-size:22px;font-weight:800;color:#111827;margin:0}
  .hero-sub{margin:4px 0 0;color:#475569}
  .grid{display:grid;grid-template-columns:220px 1fr;border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .row{display:contents}
  .key{padding:10px 12px;background:#f8fafc;border-bottom:1px solid var(--line);border-right:1px solid var(--line);font-weight:600}
  .val{padding:10px 12px;border-bottom:1px solid var(--line);white-space:pre-wrap}
  .val p{margin:0 0 10px}
  h3{margin:16px 0 8px}
  input[type="text"],textarea{width:100%;border:1px solid var(--line);border-radius:10px;padding:10px 12px;background:#fff;font:inherit}
  textarea{min-height:120px;resize:vertical}
  .pill{font-size:11px;border:1px solid var(--line);padding:3px 8px;border-radius:999px;background:#fbfdff;color:#0f172a}
  .pill.accent{background:linear-gradient(120deg,rgba(37,99,235,.18),rgba(124,58,237,.2));border-color:rgba(37,99,235,.35);color:#1e3a8a;font-weight:700;letter-spacing:.01em}
  .sidecol{display:flex;flex-direction:column;gap:16px}
  .hr{height:1px;background:var(--line);margin:12px 0}
  .toast{position:fixed;bottom:12px;right:12px;background:#111;color:#fff;padding:10px 12px;border-radius:10px;opacity:0;transform:translateY(8px);transition:.2s;pointer-events:none}
  .toast.show{opacity:1;transform:translateY(0)}
  @media print{
    header,.toast,.toolbar{display:none !important}
    body{background:#fff}
    .card{box-shadow:none;border-color:#ddd}
    .layout{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<header>
  <div class="wrap titlebar">
    <div class="hero has-floating">
      <div class="toolbar floating">
        <button id="btnRandom" title="Randomize case (Alt+R)">Randomize</button>
        <button id="btnLock" class="primary" title="Lock or Unlock for writing (Alt+L)">Lock</button>
        <button id="btnNew" class="ghost" title="Clear note fields">New</button>
        <button id="btnSave" title="Save draft (Ctrl+S / Cmd+S)">Save</button>
        <button id="btnLoad" title="Load saved draft">Load</button>
        <button id="btnCopyScenario" title="Copy case details as plain text">Copy Scenario</button>
        <button id="btnCopyAll" title="Copy case + notes as plain text">Copy All</button>
        <button id="btnExport" title="Export to Word (.docx) (Alt+E)">Export Word</button>
        <button id="btnPrint" title="Print (Alt+P)">Print</button>
        <span id="statusChip" class="status unlocked">Unlocked</span>
      </div>
      <div style="display:flex;align-items:flex-start;gap:12px;flex-wrap:wrap;justify-content:space-between">
        <div style="flex:1;min-width:260px">
          <div class="hero-title">Evidence-Based Practice (EBP) Case Randomizer & Note Builder</div>
          <div class="hero-sub">Built for the SOW5404 Evidence-Based Practice assignment. Use the separate Program Development site for that course.</div>
        </div>
        <div class="pill accent" aria-label="Assignment tag">EBP Assignment</div>
      </div>
      <div class="course" id="courseTag">SOW5404 • Spring 2026</div>
      <div class="banner">Editing is enabled only when <strong>Locked</strong>. While locked, a draft autosaves to your browser every few seconds. <em>Always</em> click <strong>Save</strong> before leaving the page.</div>
      <div class="banner" role="alert">Word export notice: When opening the downloaded file, Microsoft Word may show an "unreadable content" warning. Choose <strong>Yes</strong> to recover and the document will open normally.</div>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="layout">
    <!-- LEFT: Case panel -->
    <div class="sidecol">
      <div class="card fill">
        <h2>Case Panel</h2>
        <div class="body">
          <h3 id="caseTitle">No case selected</h3>
          <div id="intakeGrid" class="grid" aria-live="polite"></div>
          <h3>Narrative</h3>
          <div id="narrative" class="val" style="min-height:140px;border:1px solid var(--line);border-radius:10px"></div>
        </div>
      </div>
    </div>

    <!-- RIGHT: EBP Builder -->
    <div class="sidecol">
      <div class="card" id="builderCard">
        <h2>EBP Note Builder</h2>
        <div class="body">
          <div class="pill" style="margin-bottom:8px">PICO + 5 sections</div>

          <h3>PICO Builder</h3>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div><label>P - Population/Problem</label><input id="picoP" type="text" disabled></div>
            <div><label>I - Intervention</label><input id="picoI" type="text" disabled></div>
            <div><label>C - Comparison</label><input id="picoC" type="text" disabled></div>
            <div><label>O - Outcome</label><input id="picoO" type="text" disabled></div>
          </div>
          <div style="margin-top:8px;color:var(--muted)">EBP question: <span id="picoPreview" style="font-weight:600">—</span></div>

          <div class="hr"></div>

          <div style="display:grid;gap:12px">
            <div>
              <label>Client & Practice Context</label>
              <textarea id="f_context" disabled></textarea>
            </div>
            <div>
              <label>Search Strategy & Study Selection</label>
              <textarea id="f_search" disabled></textarea>
            </div>
            <div id="studiesBlock">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <label>Study Summaries (3–5 items)</label>
                <div style="display:flex;gap:8px">
                  <button id="btnAddStudy" class="ghost" title="Add study summary">Add</button>
                  <button id="btnRemoveStudy" class="ghost" title="Remove last study">Remove</button>
                </div>
              </div>
              <div id="studiesList" style="display:grid;gap:10px"></div>
            </div>
            <div>
              <label>Critical Appraisal (incl. equity/representation)</label>
              <textarea id="f_appraisal" disabled></textarea>
            </div>
            <div>
              <label>Application & Delivery Plan</label>
              <textarea id="f_application" disabled></textarea>
            </div>
            <div>
              <label>Assumptions (optional)</label>
              <textarea id="f_assumptions" disabled></textarea>
            </div>
          </div>

        </div>
      </div>
    </div>
    <!-- /RIGHT -->
  </div>
</main>

<div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true"></div>



<script>
/* ======================== CONFIG ======================== */
const CONFIG={ COURSE_TAG:'SOW5404 • Spring 2026', APPKEY_PREFIX:'EBP_APP_APPKEY_', DEFAULT_EXPORT_NAME:'EBP_Note.docx' };

/* ==================== DATA — CASES ====================== */
/* Full text embedded, with your exact wording. */
const CASES=[
/* Marcos */
{title:"Marcos: Missed Shifts, Rising Panic, and the Weight of Being the Provider",
client_profile:`Name: Marcos (he or him)
Age: 28
Identities: Mexican American Latine man
Language: English preferred, fluent Spanish
Family: Lives with partner and two children, ages 3 and 7
Employment: Line cook at a busy restaurant`,
setting:`Community mental health walk-in clinic. Appointments are 30 minutes and follow up scheduling is inconsistent due to long waitlists. Sessions occur in a shared office with minimal sound privacy. The referring provider asked for support after Marcos reported panic-like episodes and trouble working full shifts.`,
presenting_problem:`Over the past month Marcos has had intense episodes of shortness of breath, dizziness, and sweating. These occur at least twice per week, sometimes more. He has left three work shifts early and missed two entirely. His supervisor has warned him that his hours will be reduced if this continues. He is sleeping about four hours per night and reports frequent irritability at home.`,
relevant_history:`He had similar but milder episodes a few years ago under significant stress. No prior therapy. No substance use. He recently took on extra shifts after his partner’s hours were cut. He reports tension with his partner about finances and parenting roles. He describes long standing pressure to appear calm and capable in front of family. A medical exam two weeks ago found no cardiac concerns. He remains worried something might be physically wrong.`,
goals_and_preferences:`He wants the episodes to stop, wants to keep his job, and wants to be more patient with his children. He feels ashamed about missing work and does not want extended therapy commitments. He prefers strategies he can use privately, but he is unsure what that would look like.`,
strengths_and_resources:`Strong work ethic, reliable employee until recently, close relationship with his children and brother, strong cultural values around providing for family, good problem solving skills in fast paced environments.`,
contextual_factors_and_barriers:`His schedule changes weekly and sometimes daily. The family has limited childcare and struggles to cover rent. He worries about being judged by family if he shares what is happening. The apartment is small with little space for privacy. His restaurant does not offer paid sick leave. Attendance at outside appointments is challenging because of transportation and work demands.`,
risks_and_ethics:`Physical symptoms need to be monitored because he fears something medical is being overlooked. Work pressure may influence how much distress he discloses. If family tension is explored, it must be done in a way that respects cultural values around responsibility and privacy.`,
equity_signal:`Marcos is managing distress within a context shaped by unstable hourly labor conditions, economic precarity, restricted access to flexible mental health care, and cultural norms that discourage discussing emotional struggle.`,
ebp_decision_point:`What patterns or stressors appear most connected to changes in Marcos’s functioning. Which outcomes matter most for him, his family, and his ability to work. How do cultural, financial, and workplace factors shape what support is realistic. What aspects of his current symptoms would be most important to track or reduce.`,
target_outcomes:`Reduced frequency and intensity of episodes; improved shift completion; better sleep and patience at home.`,
narrative:`Marcos sits forward in the chair, elbows on his knees, rubbing his palms together as he talks. He says he feels embarrassed even being here, but he also feels scared. He describes the first recent episode happening during a crowded dinner rush. The kitchen had been short staffed and he had been working for nearly eight hours without a break. Suddenly his chest tightened and his vision blurred. He grabbed the counter to steady himself and thought he might pass out. He told his supervisor he needed air and went outside, where he sat on a crate until the dizziness passed.

Since then the episodes have struck in other places, including at home when helping his daughter with math homework. He reports feeling "on edge all day" because he never knows when the next one will happen. He presses a hand to his forehead and says he hates that his children have started watching him closely, as if they sense something is wrong.

He worries constantly about money. With his partner’s reduced hours, he has been picking up as many shifts as possible. Missing work feels like a failure, but he also feels terrified of having an episode in front of customers. He has begun having trouble focusing at home. His partner has told him he seems distracted and distant. He says he does not know how to explain what is happening without sounding dramatic.

He avoids discussing these episodes with his parents because he does not want them to think he cannot handle stress. He was raised with the idea that personal problems should be handled privately. He laughs weakly and says that in his family everyone is supposed to be tough.

He mentions he barely sleeps. He lies awake doing mental math about rent and groceries. When he does fall asleep, he wakes up sweating. He had a medical evaluation recently that found no cardiac issues, but the reassurance has not fully settled him. He is unsure whether the problem is emotional, physical, or something else entirely.

Near the end of the session he looks up and asks if people ever get completely better from something like this. The question hangs in the air, full of hope and fear. He says he wants to feel like himself again, but he does not know where to begin.

Referral Note from Primary Care Provider:
Client reports three episodes of chest tightness in the past two weeks. ECG normal. Provider suspects anxiety related symptoms. Recommended behavioral health consult due to work impairment.`},
/* Shawn */
{title:"Shawn: Headaches, Exhaustion, and Everyone Counting on Him",
client_profile:`Age 32. He and him. Black. Works full-time in a warehouse distribution center. Primary caregiver for his mother who has mobility limitations. Lives with his mother and younger sister. Limited health insurance coverage.`,
setting:`Emergency Department social work consult in a busy urban hospital. Brief, private space but significant time pressure. Social worker has 15 minutes before Shawn is discharged.`,
presenting_problem:`Shawn arrived with severe headaches, dizziness, and a feeling that he might pass out. He has visited the Emergency Department three times in the last two months with similar symptoms. Medical tests are normal, and clinicians suspect stress-related contributors but have not ruled out other causes. Shawn appears embarrassed, saying he "must be wasting everyone’s time."`,
relevant_history:`Shawn works early morning shifts with heavy lifting. He often skips breaks to leave on time to take care of his mother’s needs. He has not seen a primary care provider in over a year because scheduling conflicts make it difficult. He reports worsening sleep, increased irritability, and sometimes feeling "on edge" without knowing why. He denies any diagnosis of anxiety or depression. He frequently feels responsible for keeping his family stable after his father’s death.`,
goals_and_preferences:`Shawn wants the headaches and dizziness to stop. He wants to "get back to normal" and keep his job performance strong. He prefers not to take medications without clear need. He also says he "doesn’t have time" for therapy appointments but is open to learning strategies he can do between shifts. He wants to avoid anything that would require rearranging caregiving responsibilities.`,
strengths_and_resources:`Reliable worker. Deeply committed to family. Strong problem-solving skills. Has one close friend at work he trusts. Engaged in his church community when able.`,
contextual_factors_and_barriers:`Erratic work schedule, transportation challenges, limited access to primary care, caregiver responsibilities, financial strain, internalized expectations to be "strong."`,
risks_and_ethics:`Risk of minimizing symptoms that could have a medical basis. Must avoid implying blame. Power dynamics around expectations for Black men to "push through" distress.`,
equity_signal:`Shawn’s experience is influenced by racialized labor expectations, limited access to flexible healthcare, and caregiving responsibilities shaped by economic and structural conditions.`,
ebp_decision_point:`The social worker must consider how to support Shawn in understanding and managing his symptoms in a way that fits his barriers and values.`,
target_outcomes:`Reduced frequency or severity of headaches; improved daily functioning; consistent follow-up with appropriate supports.`,
narrative:`Shawn sits on the edge of the Emergency Department stretcher, shoulders rounded, his work uniform still covered in dust. The bright lights make him wince. He keeps apologizing for "being back again," as though he owes the staff an explanation for his pain. When he shifts, he massages the back of his neck, wincing like the movement itself reminds him of something he’s been trying to ignore.

He describes waking that morning with a pounding headache that spread behind his eyes. At work, he started feeling lightheaded. He thought the sensation would pass, but it grew worse when he reached for a heavy box. His supervisor insisted he go to the Emergency Department "just to be safe." Instead of relief, Shawn says he feels like a burden.

When you ask about stress, he shrugs. "I mean, everyone’s stressed. That’s life." Slowly, details surface: the early shifts with mandatory overtime, the small kitchen paycheck that keeps the household just stable, his mother’s increased mobility challenges, and his fear that if he slows down, everything will fall apart. He laughs softly when you ask about rest. "Rest is for people with backup plans."

Shawn admits he has been snapping at his sister more often, which makes him feel guilty. Sleep is inconsistent. He often lies awake, thinking through bills or replaying moments when he could have "done better." The more you gently explore, the more he admits the symptoms have been building for months.

Still, he insists he cannot change his routine. Appointments feel impossible. Asking for help feels disrespectful to everything his parents sacrificed. He says he doesn’t want medication unless absolutely necessary but is open to "tools or tips" that won’t require more time off or additional costs.

As the discharge process begins, Shawn watches the clock anxiously. He needs to get home to help his mother with lunch and prepare for his next shift. He looks exhausted but determined, like someone who cannot imagine putting his own needs first without something else falling apart.

Client Records for Shawn
Record 1: ED Nursing Note Excerpt
"Patient reports increasing headache frequency for 8 weeks. Describes symptoms as pressure behind eyes, intermittent dizziness. No loss of consciousness. Vital signs stable. Patient states stress at work and caregiving demands but reluctant to discuss further."
Record 2: Employer Attendance Printout (Summary)
Past 60 days:
• Left early 3 times due to symptoms
• Used 1 sick day
• Supervisor note: "Strong worker. Concerned about fatigue."`},
/* Iliana */
{title:"Iliana: A Mother in a New Country Trying Not to Fall Apart",
client_profile:`Age 27. She and her. Recently immigrated from Guatemala. Speaks Spanish; understands some English but prefers Spanish. Lives with her two young children in a family shelter.`,
setting:`Family shelter social work intake room. Limited privacy; frequent interruptions. Shelter requires brief, goal-oriented assessments due to high demand.`,
presenting_problem:`Iliana reports persistent feelings of overwhelm, difficulty sleeping, and episodes of sudden crying. She worries she is "not being a good mother" because the children "see her sad." Staff observed her appearing distressed during nightly check-in and suggested meeting with the social worker.`,
relevant_history:`Iliana left Guatemala after escalating threats from a former partner. She traveled with her children through multiple regions before arriving in the United States. Since arrival, she has focused entirely on survival: securing shelter, food, and school enrollment for her children. She has no local family. She has applied for asylum but has not yet received updates.`,
goals_and_preferences:`She wants to be calm enough to care for her children, sleep better, and stop crying suddenly. She says talking helps but becomes nervous when asked about past experiences. She prefers methods that do not require leaving the shelter until she feels more settled. She does not want to "take pills that will make her tired."`,
strengths_and_resources:`Loving parent. Deep cultural and spiritual resilience. Strong connection to her children. Participates in informal mutual aid networks among other Spanish-speaking mothers.`,
contextual_factors_and_barriers:`Uncertain immigration status, limited English, lack of transportation, shared living space, limited childcare, minimal phone data, high emotional load, and ongoing fear that her former partner may find her.`,
risks_and_ethics:`Trauma risk; avoiding coercive disclosure; ensuring safety without triggering re-traumatization; cultural humility in navigating spiritual coping.`,
equity_signal:`Migration trauma, gender-based violence, language access barriers, and structural vulnerability shape Iliana’s experience and limit service options.`,
ebp_decision_point:`How to support Iliana in stabilizing distress within limited privacy and non-medication preferences.`,
target_outcomes:`Improved emotional regulation; reduced distress episodes; improved sleep or functioning during caregiving routines.`,
narrative:`The intake room is cramped, and the hum of shelter activity seeps through the thin door. Iliana sits with her hands folded tightly, as if holding herself together. She smiles politely at first, but as she begins describing her last few weeks, tears gather at the edges of her eyes. She apologizes repeatedly for crying, explaining that she "never used to be like this."

She describes waking in the middle of the night with her heart pounding. She tries to be quiet so she does not wake the children sleeping beside her. During the day, she becomes overwhelmed by simple tasks: filling out paperwork, remembering appointments, managing the shelter schedule. She sometimes feels her vision narrow when both children need her attention at the same time. She says the sadness comes "like a wave," fast and unpredictable.

She is careful about the details she shares. When you ask gently about her journey to the United States, she hesitates, saying the memories are difficult. She shifts to talking about her children instead. They love school, she says. They are learning English quickly. She wants to be strong for them. She smiles again, briefly, before her face collapses into worry.

Iliana says she is afraid to leave the shelter alone. She worries her former partner may somehow find them. She has avoided taking buses because she does not understand the routes. She has one friend in the shelter she trusts, another mother who shares snacks and watches her children during showers. Sometimes Iliana joins the mothers in the hallway for quiet evening conversations, which she says helps.

When asked what she hopes will change, she sighs: she wants to feel calm enough to sleep and patient enough to support her children without feeling like she is failing. She does not want medication "unless there is no other way." She says talking helps but she does not want to talk about "the dangerous things" yet. Her hands tremble slightly as she rubs her palms together.

There is a sense that she is holding a very heavy story, but she is not ready to open it. She wants help, but on her terms, slowly, gently.

Client Records for Iliana
Record 1: Shelter Nightly Log Entry
"Resident tearful during check-in. Reported difficulty sleeping. Children appeared well and engaged. Encouraged to meet with social worker."
Record 2: School Social Worker Voicemail Transcript Excerpt
"Hi, this is the school social worker for Iliana’s children. She seems very committed to their education, but she missed our last meeting. She may need support coordinating appointments."`},
/* Morgan */
{title:"Morgan: Executive Overload, Missed Deadlines, and the Fear of Letting People Down",
client_profile:`Age 24. They and them. White, nonbinary. Works part-time as a graphic design contractor. Lives with two roommates. No formal diagnoses reported. Mild sensory sensitivities and chronic trouble organizing tasks.`,
setting:`Community mental health drop-in center. Brief counseling session with 20 minutes available. Semi-private room with occasional hallway noise and interruptions.`,
presenting_problem:`Morgan reports "meltdowns" related to missed deadlines and overwhelm. Their contractor work has become unstable because they submit projects late or forget steps. They describe periods of hyperfocus followed by "crashes" in which simple tasks feel impossible. They feel ashamed and terrified of disappointing clients.`,
relevant_history:`Morgan did well academically in creative subjects but struggled with organization and time management throughout school. They have always needed reminders and structure. They recently moved and lost their previous social routine. They tried planning apps but became overwhelmed by notifications. They have not been able to maintain consistent therapy due to fluctuating income.`,
goals_and_preferences:`Morgan wants to manage work tasks without spiraling. They want to "stop freezing" when deadlines are approaching. They prefer supports that fit their creative workflow, not highly structured systems. They dislike feeling monitored. They are open to learning strategies that help them regulate emotions and start tasks more easily.`,
strengths_and_resources:`Strong creative skills. Supportive roommates. Good insight into patterns. Engaged in online creative communities. Curious and reflective.`,
contextual_factors_and_barriers:`Irregular income, unpredictable work hours, self-employed pressure, fear of losing clients, crowded living environment, sensory overload in shared spaces, inconsistent sleep.`,
risks_and_ethics:`Risk of pathologizing neurodivergence; ensuring autonomy in choosing strategies; avoiding overwhelming Morgan with rigid systems.`,
equity_signal:`Morgan’s difficulties intersect with labor instability, self-employed precarity, neurodivergent needs, and gender identity in systems that often dismiss or misunderstand them.`,
ebp_decision_point:`How to help Morgan manage overwhelm and task initiation difficulties in a way that fits values and flexible work life.`,
target_outcomes:`Improved task follow-through; reduced distress during deadlines; improved daily functioning.`,
narrative:`Morgan sits curled forward, both hands wrapped around a large insulated cup they forgot to fill before the appointment. Their eyes flick from the window to the notebooks scattered across the table, as though each one holds a reminder of something undone. They apologize three times before you can tell them they have nothing to apologize for.

They describe a pattern they cannot break. They accept a design assignment, feel excited, and spend hours sketching. But when it is time to finalize the piece or send drafts, their body seems to shut down. "It’s like my brain hits a wall," they say. They stare at the screen, unable to begin. Their chest tightens, their thoughts race, and suddenly they are cleaning the kitchen or scrolling for hours. By the time they return to the project, they are embarrassed, behind, or both.

They explain that these shutdowns make them feel like a fraud. Their clients think they are talented, but Morgan fears they will eventually realize "how broken" they are. When you ask what they do during overwhelm, Morgan says they try breathing exercises they saw online, but sometimes the exercises make them feel more aware of how "bad at life skills" they are.

Morgan moved to the city hoping for independence. They love their roommates but feel guilty when they overhear them reminding Morgan of overdue tasks. At times, they avoid opening emails entirely. "If I don’t look, I can pretend I’m not disappointing anyone," they say, picking at the sleeve of their sweater.

When asked about supports that have worked in the past, Morgan brightens slightly. They loved a structured mentorship in college but felt overwhelmed by the weekly assignments. They enjoy working in cafés but find them overstimulating. They are open to strategies that start small and respect their creative process.

As the meeting ends, Morgan says quietly, "I just want to feel like I can trust myself again." There is exhaustion in their voice, but also a spark of hope that things might feel more manageable with the right approach.

Client Records for Morgan
Record 1: Email Excerpt From Client
"Hi Morgan, checking in again. We haven’t received the revised draft. Please confirm timeline. Thanks."
Record 2: Self-Report Note on Phone
"To do today: finish banner, send invoice, wash bedding. Feeling stuck. Maybe try starting with one small thing?"`},
/* Sofia */
{title:"Sofia: School Refusal, Sensory Overload, and a Family Caught in the Middle",
client_profile:`Age 15. She and her. White, autistic student at a specialized public school. Lives with mother and younger brother. Receives school-based support services.`,
setting:`School social work office in a specialized education program. Social worker has a scheduled 30-minute session. Moderate privacy but frequent school announcements interrupt.`,
presenting_problem:`Sofia has missed nine days of school in the past month. Her mother reports that Sofia becomes overwhelmed each morning and refuses to leave the house. Sofia describes intense sensory discomfort in crowded hallways and a "buzzing" sensation that builds until she feels she must escape.`,
relevant_history:`Diagnosed in early childhood. Sensory sensitivities include sound, fluorescent lighting, and unexpected touch. Historically enjoyed school when routines were stable. Changes to school staff and schedules this year disrupted predictability. Sofia has experienced teasing in the past but does not want to discuss details. She has never had difficulty with academic content.`,
goals_and_preferences:`Sofia wants the sensory environment to feel manageable. She wants to "not feel sick" walking into the building. She prefers strategies she can use privately and dislikes approaches that draw attention. She does not want to talk about social stressors. Her mother wants improved attendance and fewer morning conflicts. The school wants consistency to support learning and planning.`,
strengths_and_resources:`High academic abilities. Insight into sensory triggers. Supportive mother. Strong artistic interests. One teacher who understands her communication style.`,
contextual_factors_and_barriers:`Long commute on noisy bus, limited quiet spaces at school, unpredictable hallway transitions, parent work schedule, insurance limits for external services.`,
risks_and_ethics:`Avoiding forced compliance. Ensuring student voice is central. Balancing school demands with sensory access needs. Protecting Sofia from retraumatization or stigma.`,
equity_signal:`Autistic students often face environments built without sensory access in mind. School refusal risks disciplinary responses shaped by systemic misunderstandings of disability.`,
ebp_decision_point:`How to support Sofia’s attendance and sensory management while honoring preferences and environment realities.`,
target_outcomes:`Reduced school refusal; increased attendance; reduced sensory distress.`,
narrative:`Sofia sits at the small round table with her knees pulled to her chest, her hoodie drawn up around her face. The fluorescent overhead lights flicker slightly. She glances up each time they buzz, then looks back down. Her mother sighs softly, rubbing her temples in exhaustion.

Sofia explains that mornings have become unbearable. She wakes up already tense, anticipating the hallway noise. She describes the cafeteria as "a hundred radios playing different static." Even in class, she finds herself bracing for the bell. When she cannot predict sounds or movements, her heartbeat speeds up, and her hands shake. Some days she makes it to the car before crying; other days she refuses to put on her shoes.

Her mother speaks with equal parts frustration and worry. She is afraid that missed days will affect Sofia’s progress. She also fears losing her job when she is late because of morning meltdowns. She feels caught between advocating for her daughter and wanting the school to understand the situation more fully.

Sofia avoids discussing peers. When asked about this year’s changes, she shrugs and looks away. She says she does not want to "make a big deal" but does not feel comfortable in some spaces anymore. She has one teacher she trusts, who lets her work quietly in a corner when the room gets too loud.

As you explore her hopes, Sofia quietly says she wants to come to school, but she wants it to feel "less like drowning." She is unsure what would help but says she likes drawing because it feels grounding. She is open to trying small things but fears they will not make a difference.

As the session ends, her mother asks for guidance, torn between pushing Sofia and protecting her. The tension in the room is palpable: Sofia wants relief, her mother wants stability, and the school wants structure. The path forward is not yet clear.

Client Records for Sofia
Record 1: Attendance Summary
Absences this month: 9
Tardies: 4
Parent notes: "Overwhelmed. Could not get on bus."
Record 2: Teacher Email Excerpt
"Sofia is very capable academically. When she is present and comfortable, she participates fully. Major challenge is sensory overload in transitions."`},
/* Mateo */
{title:"Mateo: Trying to Stay Sober in a Workplace Built Around Alcohol",
client_profile:`Age 29. He and him. Mexican American. Works full-time as a server and bar-back at a popular restaurant. Lives with two cousins. Bilingual Spanish and English; prefers English in professional settings. No formal mental health diagnoses reported.`,
setting:`Community behavioral health walk-in clinic. Semi-private cubicle with limited soundproofing. Social worker has approximately 25 minutes before the next scheduled client.`,
presenting_problem:`Mateo reports increasing difficulty staying sober while working in an environment where alcohol is constantly present. He says he has been "trying to cut back" for months but feels the work culture makes it nearly impossible. He states he is not drinking every day but admits to "slipping" more often, especially after stressful shifts. He feels ashamed and confused about what to do.`,
relevant_history:`Mateo began drinking more heavily two years ago during a stressful breakup. He has had periods of sobriety lasting several weeks. He has never participated in a formal program but has attended a few online support meetings anonymously. His father struggled with alcohol use, and Mateo worries he "has the same problem." His job performance remains strong, but he has been late twice recently after nights of drinking.`,
goals_and_preferences:`Mateo wants to avoid drinking after work and avoid "snowballing" into old patterns. He does not want to stop working at the restaurant because the income is reliable and he enjoys the customers. He prefers supports that respect his privacy; he does not want coworkers or cousins to know he is seeking help. He is unsure about long-term therapy due to scheduling but is open to strategies he can use before or after shifts.`,
strengths_and_resources:`Strong interpersonal skills, good work ethic, supportive cousins, pride in his professionalism. Insightful about patterns. Motivated to change. Has access to stable housing.`,
contextual_factors_and_barriers:`Restaurant culture normalizes heavy drinking. Coworkers often invite him out after shifts. He feels pressure to join to maintain relationships. Evening work schedules, limited transportation late at night, and fear of stigma also play roles. Family history complicates emotional triggers.`,
risks_and_ethics:`Respect for autonomy; avoiding moralizing language; cultural humility around drinking norms; ensuring no strategy jeopardizes employment or safety.`,
equity_signal:`Mateo’s experience is shaped by labor conditions in the service industry, cultural norms around social drinking, stigma tied to masculinity and alcohol, and financial pressures common among workers in tipped positions.`,
ebp_decision_point:`How to support Mateo in reducing alcohol use while preserving financial stability and privacy.`,
target_outcomes:`Reduced frequency of after-shift drinking; increased ability to manage urges; improved sense of control.`,
narrative:`Mateo arrives wearing his restaurant uniform, smelling faintly of citrus cleaner and fryer oil. He apologizes for the wait even though he is early. His leg bounces as he sits, and he keeps adjusting his baseball cap as though he is trying to settle into his own body.

He explains that last night he drank more than planned after a chaotic dinner rush. A coworker bought a round "to celebrate surviving Friday," and he felt awkward refusing. Once he started drinking, he found himself staying longer than intended. He woke up groggy, ashamed, and terrified he might be "heading down the same road" as his father. He emphasizes that he does not drink every day, but the pattern feels familiar and frightening.

When you ask what he wants, he says he wants to feel "in control again." He likes his job and the social nature of the work. He does not want to be the person who says no to everything. At the same time, he hates waking up worried he messed up again. He describes a tug-of-war inside himself: the part that enjoys relaxing with coworkers and the part that feels sick afterward. He worries he is disappointing himself and the people he loves.

He mentions two cousins he lives with who "party sometimes" but do not pressure him. He has thought about attending more online meetings but feels embarrassed turning his camera on and anxious about being seen in person. He does not want to quit drinking entirely, at least not right now, but he does want to stop crossing the line he keeps crossing.

During quieter moments, he admits he feels lonely after work and finds it easier to join his coworkers than go home to an empty apartment. He wonders if he drinks partly to delay sitting with certain emotions. His eyes well when he says this, but he quickly looks away.

Mateo says he needs tools that work when he is exhausted, overstimulated, and surrounded by coworkers who see drinking as bonding. He does not know what those tools might be, but he knows he cannot keep doing things the same way.

Client Records for Mateo
Record 1: Shift Manager Note (Informal Text Message)
"Hey man, everything ok? You were a little off today. Let me know if you need to swap a shift or something."
Record 2: Self-Monitoring Screenshot (Notes App)
"Days without drinking: 4 … Then 0. Need a plan. I can do better."`},
/* Linh */
{title:"Linh: Parenting Through Behaviors That Feel Bigger Than She Can Hold",
client_profile:`Age 34. She and her. Vietnamese American. Lives in a small apartment with her 8-year-old son, Bao. Works evenings at a restaurant. Co-parents informally with Bao’s father, who is inconsistently involved.`,
setting:`Pediatric primary care clinic. Short social work appointment following a recent teacher concern form. Limited privacy because of thin walls and occasional staff interruptions. Time-limited session with about 20 minutes available.`,
presenting_problem:`Linh reports that Bao has been more active, unfocused, and argumentative at home and at school. She feels overwhelmed by his behaviors and unsure how to respond effectively. The school has described him as "disruptive" and "off-task." Linh fears the school views her as a failing parent and worries Bao is being singled out.`,
relevant_history:`Bao started third grade two months ago. His previous school years were smoother, though he always had high energy. The evening work schedule means Linh is often tired when supervising homework, and arguments have increased. Bao becomes frustrated quickly, sometimes crying or shutting down when he cannot focus. Linh reports that she grew up in a context where children were expected to sit still and comply, and she feels confused about how to interpret Bao’s behavior.`,
goals_and_preferences:`Linh wants home life to feel calmer and wants Bao to feel supported, not punished. She does not want him to feel "broken." She prefers practical tools she can use at home, especially in the evenings. She is open to learning strategies but worries about language misunderstandings when speaking with school staff. She wants to avoid long weekly programs because of her work schedule.`,
strengths_and_resources:`Warm relationship with Bao. Strong family values and resilience. Engaged in a Vietnamese community church. Bao is imaginative, curious, and affectionate. Linh is highly motivated to support him.`,
contextual_factors_and_barriers:`Evening work shifts; limited childcare; language nuance in school communications; cultural expectations around obedience; limited transportation; financial stress; inconsistent father involvement.`,
risks_and_ethics:`Avoiding culturally insensitive assumptions. Ensuring Linh is not blamed for systemic or developmental factors. Avoiding stigmatizing language. Clarifying that exploring supports does not mean labeling her child prematurely.`,
equity_signal:`Immigrant parents often encounter school systems that assume shared cultural beliefs about discipline. Language nuance, socioeconomic constraints, and cultural expectations shape both school interpretations and parent confidence in advocating for their child.`,
ebp_decision_point:`How to support Linh in understanding and responding to Bao’s behaviors within time, cultural values, and emotional needs.`,
target_outcomes:`Improved homework routines; decreased conflict at home; improved caregiver confidence.`,
narrative:`Linh sits upright in the small clinic office chair, smoothing Bao’s jacket on her lap even though he is not present. Her expression is a mix of worry and exhaustion. She explains that she received a note from the school yesterday describing Bao as "disruptive" and "unusually emotional." She did not sleep well because she kept rereading the phrasing, wondering if the teachers blame her.

She describes Bao as bright and enthusiastic. At home he loves showing her drawings, asking endless questions, and helping in the kitchen. But lately homework has turned into a fight almost every evening. He rushes through math problems, makes mistakes, then becomes upset when she asks him to slow down. Sometimes he cries and says his brain "feels too busy." Linh feels pulled between comforting him and insisting he finish his work.

She explains that she works long evening shifts at a restaurant, often coming home tired and stressed. She tries to create structure for Bao but feels her energy is limited. In her own childhood, children were expected to sit calmly and complete tasks without negotiation. She feels confused when traditional methods do not seem to work for Bao. "I tell him to focus, but he cannot," she says, her voice breaking slightly. "I do not understand what he needs from me."

As she talks, her fears come to light. She is worried the school is labeling him too quickly. She is worried teachers will think her parenting is inadequate. She is worried that if she pushes too hard, she will harm his confidence, but if she does not push enough, he will fall behind. She wonders whether other children struggle like this or whether something is wrong.

When asked what she hopes will change, Linh says she wants home to feel peaceful again. She wants Bao to succeed without feeling overwhelmed. She wants to understand how to support him in ways that match her values, her schedule, and his needs. She knows she cannot change the pressures of work or school, but she hopes there are tools that can make their evenings less painful.

Client Records for Linh
Record 1: Teacher Concern Form Excerpt
"Bao frequently leaves his seat, appears distracted, and sometimes refuses directions. Strengths include creativity and verbal engagement. Needs support staying on task."
Record 2: School Voicemail Transcript
"Hello Ms. Nguyen. We would like to schedule a meeting to talk about some supports we think may help. Please call us back when you can."`},
/* Farah */
{title:"Farah: Grief, Insomnia, and a Body That Will Not Rest",
client_profile:`Age 26. She and her. Afghan American. Works part-time at a bakery. Lives with extended family. English is her preferred language but she sometimes switches to Dari during emotional moments. No formal mental health diagnoses documented.`,
setting:`Primary care social work consultation in a busy outpatient clinic. Ten minutes of privacy before the physician returns with discharge instructions. Thin walls, frequent interruptions.`,
presenting_problem:`Farah reports severe insomnia, loss of appetite, and persistent stomach tightness. She sometimes feels lightheaded and detached. She came today because her family urged her to "get checked" after noticing she has not been sleeping. The physician referred her to the social worker to explore stress-related factors.`,
relevant_history:`Farah’s father died unexpectedly seven weeks ago. She helped coordinate religious and cultural grieving rituals with her family but has not shared many of her own feelings. She avoids discussing her father at work and says she feels "numb until nighttime." Since the loss, she has taken on additional household responsibilities. She has also been supporting her younger siblings emotionally.`,
goals_and_preferences:`Farah wants to sleep again. She wants her stomach to stop hurting and wants mornings to feel bearable. She prefers approaches that respect her cultural mourning practices and does not want to feel pushed to "move on." She does not want medication unless necessary and prefers strategies she can try privately, without disrupting family expectations.`,
strengths_and_resources:`Strong family ties. Deep spiritual grounding. Thoughtful, introspective. Supportive workplace supervisor. Strong community connections through her mosque.`,
contextual_factors_and_barriers:`Crowded multigenerational home; nighttime responsibilities; cultural expectations around emotional privacy; limited finances; part-time work instability; immigration stress affecting other family members.`,
risks_and_ethics:`Avoiding pathologizing healthy grief; honoring spiritual frameworks; ensuring cultural humility; recognizing power differentials in cross-cultural healthcare encounters.`,
equity_signal:`Farah’s distress is shaped by immigration-related stress, cultural expectations surrounding mourning, economic precarity, and healthcare systems that may not recognize culturally congruent ways of expressing grief.`,
ebp_decision_point:`How best to support insomnia and somatic distress during acute grief aligned with cultural values and privacy.`,
target_outcomes:`Improved sleep quality; reduced somatic tension; restored daily functioning.`,
narrative:`Farah sits quietly, hands folded neatly over her purse. She has dark circles beneath her eyes. When she speaks, her voice is soft, as if she is choosing every word carefully. She says she has not slept more than two hours a night for weeks. She lies awake long after everyone has gone to bed, waiting for her body to settle, but instead she feels waves of tightness rolling through her stomach.

She explains that since her father’s death, she has been holding the family together. Her mother relies on her for translation, paperwork, and emotional encouragement. Her siblings gravitate toward her room at night, seeking comfort. She says she feels honored to care for her family but also overwhelmed. She has not cried in front of them, because she fears it will make them feel even worse.

Farah says she cannot rest because the house is full, and privacy is limited. She describes lying awake listening to relatives snore, cough, whisper in other rooms. When she finally begins to drift, she is startled awake by anxious thoughts that she cannot quite explain. She says it feels like her body is "running a race without permission."

At work, she keeps her head down and focuses on repetitive tasks. Coworkers ask how she is doing, and she answers politely, but she feels "hollow." When you ask what she needs most, she hesitates, then says she wants the nights to feel less frightening. She wants her mind to slow down enough to breathe. She is open to ideas but not ready for anything that feels too emotionally demanding.

Client Records for Farah
Record 1: Primary Care Vitals Summary
Blood pressure: slightly elevated
Sleep reported: 1–2 hours per night
Appetite: decreased
Record 2: Brief Note From Mother (Translated Summary)
"Farah works hard and does not sleep. She keeps everything inside. We are worried."`},
/* Riley */
{title:"Riley: Navigating Gender, Safety, and Shutdowns at Home",
client_profile:`Age 16. They and them. White. Transgender nonbinary teen. Lives with mother and stepfather. Currently enrolled in high school. No documented mental health diagnoses, though school counselor notes emotional shutdowns.`,
setting:`School counseling office. Privacy is moderate until class change noise begins. Time-limited session scheduled for 25 minutes.`,
presenting_problem:`Riley experiences episodes of shutting down during conflict at home. They become silent, freeze physically, and sometimes retreat to their room for hours. Their mother requested counseling support after a recent argument triggered a shutdown that lasted most of an evening. Riley reports feeling overwhelmed, unsafe, and "disconnected from everything" during those moments.`,
relevant_history:`Riley came out as nonbinary last year. Their mother is trying to be affirming but is often unsure about language and boundaries. Their stepfather avoids the topic entirely. The household became more tense after repeated disagreements about clothing, curfews, and school performance. Riley has one close friend and an online art community where they feel understood.`,
goals_and_preferences:`Riley wants to feel safe expressing frustration without shutting down. They do not want approaches that require family disclosure unless they choose it. They prefer private strategies they can use during escalating moments. They want to avoid anything that feels like "forcing emotions out."`,
strengths_and_resources:`Creative, thoughtful, strong insight into emotions after the fact. One supportive peer. Access to school counseling. Strong online community.`,
contextual_factors_and_barriers:`Home environment with inconsistent emotional support; gender identity misunderstandings; limited transportation; stepfather’s discomfort with LGBTQ topics; academic pressure; internalized stress around safety.`,
risks_and_ethics:`Protecting autonomy around gender identity; avoiding involuntary family involvement; ensuring no strategy increases conflict or exposure to harm; avoiding assumptions about family acceptance.`,
equity_signal:`Transgender and nonbinary teens often navigate homes and schools not structured around their safety or identity needs. Emotional shutdowns can reflect chronic stress, microaggressions, and identity invalidation.`,
ebp_decision_point:`How to support emotional regulation and safety during shutdown episodes while honoring privacy and identity.`,
target_outcomes:`Reduced frequency/intensity of shutdowns; earlier trigger identification; improved sense of safety.`,
narrative:`Riley sits cross-legged in the counseling chair, sleeves pulled over their hands. Their voice is quiet but steady. They explain that when conflict happens at home, something inside "switches off." They describe feeling heat rise in their face, then a cold sensation spreading through their arms, followed by silence. They say they can hear people talking, but it feels like they cannot move.

Last night’s shutdown began after a small argument about homework. Their mother raised her voice slightly, and Riley felt a surge of panic. They describe it as "everything getting too loud, too close." They retreated to their room, stared at the wall, and lost track of time. When their mother checked in hours later, Riley could not find words to explain what happened.

They say their mother is trying, but the household feels complicated. Their stepfather does not address their gender at all. Riley says silence from him feels "heavier than yelling." They feel safest online, where friends use their correct name and affirm their identity. At school, they keep their head down but enjoy art class.

When asked what they want to be different, Riley thinks for a long time. They say they want a way to stay present during tense moments without going numb. They want to feel like they have tools before shutting down completely. They are open to ideas but want them to feel private, manageable, and not overly emotional.

Client Records for Riley
Record 1: Teacher Email Excerpt
"Riley is capable but often appears withdrawn after weekends. They participate more in creative activities."
Record 2: Parent Message to School Counselor
"I want to support Riley but do not always know how. When they shut down, they do not talk at all. I need guidance."`},
/* Mr. Thompson */
{title:"Mr. Thompson: Low Mood, Chronic Pain, and Days That Feel Too Quiet",
client_profile:`Age 72. He and him. Black. Retired bus mechanic. Lives alone in subsidized senior housing. Limited mobility due to osteoarthritis. Widower. Fixed monthly income.`,
setting:`Federally Qualified Health Center primary care social work visit. Scheduled for 20 minutes. Limited privacy because curtains separate exam areas. Social worker is consulted after Mr. Thompson screened positive for low mood and fatigue.`,
presenting_problem:`Mr. Thompson reports worsening knee and back pain, low energy, and "a kind of sadness" he cannot shake. He says he spends most days sitting in his recliner watching television or staring out the window. He came in today because his daughter insisted after noticing he was "not himself" during a recent phone call.`,
relevant_history:`Mr. Thompson’s wife died last year after a long illness. He was her primary caregiver. After her death, he remained socially engaged for a few months but slowly withdrew as his mobility worsened. He used to enjoy weekly breakfasts with friends from church but now declines invitations because walking long distances causes pain. He does not drive. His daughter lives two hours away and visits once a month.`,
goals_and_preferences:`He wants to feel "a little lighter." He wants to move with less pain and regain energy to enjoy small daily activities. He prefers approaches that respect his independence. He is skeptical of medications for mood, saying he does not want to "walk around numb." He is open to trying things "that fit my age and my knees."`,
strengths_and_resources:`Deep pride in self-reliance. Strong relationship with daughter. Longstanding church connections. Resilient coping history. Compassionate personality.`,
contextual_factors_and_barriers:`Mobility limitations; transportation challenges; fixed income; grief; social isolation; fear of burdening others; historically negative experiences with dismissive healthcare providers.`,
risks_and_ethics:`Avoiding ageist assumptions; respecting autonomy; ensuring interventions do not increase fall risk; recognizing grief as a meaningful emotional context.`,
equity_signal:`Race, aging, socioeconomic precarity, and mobility limitations intersect to shape Mr. Thompson’s access to support and likelihood of being overlooked by systems.`,
ebp_decision_point:`How best to support low mood and isolation within mobility, finance, and transport limits.`,
target_outcomes:`Improved daily functioning; increased engagement in meaningful activities; reduced perceived loneliness.`,
narrative:`Mr. Thompson settles slowly into the exam chair, gripping the armrest for balance. He jokes that the clinic chairs "were not made for old knees," but the humor lands softly, almost like a memory of how he used to sound. He explains that the pain has been worse since winter started. On cold mornings, he wakes feeling stiff and exhausted before the day even begins.

He says he spends most days in his recliner because moving around the apartment takes effort. He tries to distract himself with movies, but he often loses focus. Meals have become simpler too, usually canned soup or toast because standing in the kitchen hurts. When you ask about friends or social routines, he shrugs. Most people live across town, and the bus stop is too far to walk reliably. He says it feels embarrassing to cancel plans when his body "refuses to cooperate."

When asked about mood, he describes days that blur together. "I keep thinking about my wife," he says quietly. "The house is too quiet without her." He says he talks to her sometimes, just to hear his own voice. He adds that the loneliness sneaks up on him, especially at night. His daughter calls when she can, but he hates worrying her.

He wants to feel useful again, even in small ways. He misses tinkering with tools or chatting with neighbors. He says he is not sure what would help but knows he cannot continue like this. He does not want to feel numb or dependent but is open to trying "something that gives me a little push forward."

Client Records for Mr. Thompson
Record 1: Primary Care Screening Summary
PHQ-9 score: Moderately elevated
Pain scale: 7 out of 10
Mobility: Uses cane indoors, walker for longer distances
Record 2: Daughter’s Phone Message
"Dad seems down. He says he is fine, but he is not himself. Please check on him."`},
/* Jae */
{title:"Jae: Returning Home After Incarceration and Holding Too Much at Once",
client_profile:`Age 31. He and him. Korean American. Released from state prison six weeks ago after serving a two-year sentence. Lives temporarily with his older sister. On community supervision. Part-time warehouse job.`,
setting:`Reentry services intake at a community-based nonprofit. Private office with a 30-minute appointment. Case manager requested a clinical consult because Jae appears tense and overwhelmed.`,
presenting_problem:`Jae reports difficulty controlling worry, irritability, and emotional flooding during daily stress. He has trouble sleeping and experiences intense physical tension when he feels criticized or startled. He says he wants to "stay on track" but feels exhausted and overstimulated. He fears any mistake could send him back to prison.`,
relevant_history:`During incarceration, Jae kept to himself and focused on rule compliance. He witnessed several frightening incidents and describes the environment as "loud, unpredictable, and always on alert." Since release, he feels overstimulated by noise, crowds, and open space. He has had two arguments with his sister about house rules. He denies substance use. Community supervision requires strict curfews, weekly check-ins, and consistent employment.`,
goals_and_preferences:`Jae wants to remain stably housed, keep his job, and avoid conflict. He wants to handle criticism without feeling overwhelmed. He prefers strategies he can use discreetly at work or at home. He fears opening up too much because he does not want anything documented that could affect his supervision status.`,
strengths_and_resources:`Highly motivated. Strong work ethic. Insightful about triggers. Supports from reentry program. Caring sister despite conflict. Desire to rebuild his life.`,
contextual_factors_and_barriers:`Strict supervision requirements; fear of legal consequences; stigma; limited autonomy; financial strain; family tension; sensory overstimulation after release; hypervigilance shaped by incarceration.`,
risks_and_ethics:`Confidentiality limits; avoiding pathologizing trauma responses; respecting autonomy while ensuring safety; navigating documentation carefully.`,
equity_signal:`Incarceration, racialized surveillance, and collateral consequences create structural barriers to reentry. Emotional distress is shaped by systemic injustice, not only individual factors.`,
ebp_decision_point:`How to support regulation and functioning while navigating supervision constraints and privacy concerns.`,
target_outcomes:`Reduced emotional flooding; improved functioning at work and home; increased confidence navigating supervision.`,
narrative:`Jae sits on the edge of the chair, posture rigid. He watches every movement in the room, as though measuring safety. When you greet him, he gives a polite nod but keeps his eyes lowered. He explains that since coming home, everything feels "too big." The grocery store aisles, the early-morning buses, even the sky. He says he spent two years indoors with controlled routines, and now the world feels unpredictable.

He describes waking at 4 a.m. from dreams he cannot fully remember. His chest feels tight, and his heart pounds. At work, he tries to follow instructions carefully, but when tasks shift suddenly or someone raises their voice, he freezes. He fears looking incompetent. He worries that if he loses the job, he will violate supervision requirements.

At home, the tension is different. He is grateful to live with his sister, but her expectations feel strict. She wants him to relax, but noise from her children overwhelms him. When she asks him questions too quickly, he feels cornered. Last week, after a misunderstanding about chores, he shut down completely and spent hours sitting on the floor of his room, breathing through panic he did not know how to stop.

He says he keeps thinking about mistakes, even small ones, and imagining terrible consequences. He tries to shake the thoughts off but cannot. He wants tools that do not draw attention, especially at work. He also wants to avoid anything that would lead to disclosures he fears might be misinterpreted by his supervision officer.

He leans forward near the end of the session and says quietly, "I want to do this right. I want a life that feels like mine again."

Client Records for Jae
Record 1: Supervision Compliance Log
Week 1: On time
Week 2: On time
Week 3: On time
Note: Client appears tense during appointments.
Record 2: Warehouse Supervisor Comment
"Works hard. Gets overwhelmed with sudden task changes. Needs clear instructions."`}
];

/* =============== HELPERS =============== */
function $(id){return document.getElementById(id)}
function escapeHTML(s=''){return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}
function normalizeDashes(s=''){return s.replace(/[\u2013\u2014]/g,'-')}
function stripEmojis(s=''){return s.replace(/[\p{Extended_Pictographic}\uFE0F]/gu,'')}
function paragraphsHTML(text=''){
  let t=text.replace(/\r\n/g,'\n'); t=normalizeDashes(t); t=stripEmojis(t);
  return t.split(/\n\s*\n/g).map(p=>`<p>${escapeHTML(p).replace(/\n/g,'<br>')}</p>`).join('')
}
function toast(msg){const el=$('toast');el.textContent=msg;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),1200)}
function nowISO(){return new Date().toISOString()}
function activeIsTyping(){const ae=document.activeElement; if(!ae) return false; const tag=ae.tagName.toLowerCase(); return tag==='textarea'||tag==='input'||ae.isContentEditable}
function wordCount(s=''){return (s.trim().match(/\b[\w'-]+\b/g)||[]).length}

/* clipboard fallback (HTTPS or file:// safe) */
async function copyTextSafe(txt){
  try{
    if(navigator.clipboard && window.isSecureContext!==false){
      await navigator.clipboard.writeText(txt);
      return true;
    }
  }catch(_){}
  const ta=document.createElement('textarea');
  ta.value=txt; ta.style.position='fixed'; ta.style.opacity='0';
  document.body.appendChild(ta); ta.focus(); ta.select();
  let ok=false; try{ ok=document.execCommand('copy'); }catch(_){}
  ta.remove(); return ok;
}

/* simple hash to skip redundant autosaves */
function hashString(s){ let h=5381; for(let i=0;i<s.length;i++){ h=((h<<5)+h) ^ s.charCodeAt(i); } return (h>>>0).toString(36); }

/* =============== STATE =============== */
let locked=false, currentCase=null, autosaveTimer=null, studiesCount=3;
let lastSavedHash='';
let randomBag=[];

/* =============== INIT =============== */
document.addEventListener('DOMContentLoaded',()=>{
  $('courseTag').textContent=CONFIG.COURSE_TAG;
  bind('btnRandom', onRandomize); bind('btnLock', onLockToggle); bind('btnNew', onNew);
  bind('btnSave', onSave); bind('btnLoad', onLoad);
  bind('btnCopyScenario', onCopyScenario); bind('btnCopyAll', onCopyAll);
  bind('btnExport', onExport); bind('btnPrint', ()=>window.print());
  bind('btnAddStudy', addStudy); bind('btnRemoveStudy', removeStudy);

  ['f_context','f_search','f_appraisal','f_application','f_assumptions'].forEach(id=>{
    $(id).addEventListener('input',()=>{updatePICO();});
  });
  ['picoP','picoI','picoC','picoO'].forEach(id=>{
    $(id).addEventListener('input',()=>{updatePICO();});
  });
  rebuildStudies(3); updatePICO();

  document.addEventListener('keydown', e=>{
    const modS=(e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='s'; if(modS){e.preventDefault();onSave();return;}
    if(activeIsTyping()) return;
    if(e.altKey&&/r/i.test(e.key)){e.preventDefault();onRandomize();}
    if(e.altKey&&/l/i.test(e.key)){e.preventDefault();onLockToggle();}
    if(e.altKey&&/e/i.test(e.key)){e.preventDefault();onExport();}
    if(e.altKey&&/p/i.test(e.key)){e.preventDefault();window.print();}
  });
});

/* =============== DOM UTIL =============== */
function bind(id,fn){const el=$(id); if(el) el.addEventListener('click',fn)}

/* =============== RANDOMIZE / RENDER =============== */
function nextRandomCase(){
  if(!CASES||!CASES.length) return null;
  if(!randomBag.length){
    randomBag=CASES.map((_,i)=>i);
    for(let i=randomBag.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [randomBag[i],randomBag[j]]=[randomBag[j],randomBag[i]];
    }
  }
  const idx=randomBag.pop();
  return CASES[idx]||null;
}
function onRandomize(){
  const next=nextRandomCase();
  if(!next){toast('No cases available');return;}
  currentCase=next;
  renderCase(currentCase);
  toast('Case selected');
  clearBuilder();
}
function renderCase(c){
  $('caseTitle').textContent=c?.title||'Untitled';
  const grid=$('intakeGrid'); grid.innerHTML='';
  const map={
    'Client Profile':c.client_profile,
    'Setting':c.setting,
    'Presenting Problem':c.presenting_problem,
    'Relevant History':c.relevant_history,
    'Goals and Preferences':c.goals_and_preferences,
    'Strengths and Resources':c.strengths_and_resources,
    'Contextual Factors and Barriers':c.contextual_factors_and_barriers,
    'EBP Decision Point':c.ebp_decision_point,
    'Target Outcomes':c.target_outcomes,
    'Risks and Ethics':c.risks_and_ethics,
    'Equity Signal':c.equity_signal
  };
  for(const k in map){
    grid.insertAdjacentHTML('beforeend',
      `<div class="row"><div class="key">${escapeHTML(k)}</div><div class="val">${paragraphsHTML(map[k]||'')}</div></div>`
    );
  }
  $('narrative').innerHTML=paragraphsHTML(c.narrative||'');
}

/* =============== LOCK / AUTOSAVE =============== */
function setLocked(v){
  locked=v;
  [...document.querySelectorAll('input[type="text"],textarea')].forEach(f=>f.disabled=!locked);
  $('btnLock').textContent=locked?'Unlock':'Lock';
  const chip=$('statusChip'); chip.textContent=locked?'Locked for writing':'Unlocked';
  chip.classList.toggle('locked',locked); chip.classList.toggle('unlocked',!locked);
  if(locked){startAutosave()} else {stopAutosave()}
  lastSavedHash=''; // reset autosave guard on state change
}
function onLockToggle(){ if(!currentCase){toast('Randomize a case first');return;} setLocked(!locked) }
function startAutosave(){ stopAutosave(); autosaveTimer=setInterval(onSave,4000) }
function stopAutosave(){ if(autosaveTimer){clearInterval(autosaveTimer); autosaveTimer=null} }

/* =============== BUILDER =============== */
function clearBuilder(){
  ['picoP','picoI','picoC','picoO','f_context','f_search','f_appraisal','f_application','f_assumptions'].forEach(id=>$(id).value='');
  rebuildStudies(3); updatePICO();
  lastSavedHash=''; // reset guard
}
function updatePICO(){
  const P=$('picoP').value.trim(), I=$('picoI').value.trim(),
        C=$('picoC').value.trim(), O=$('picoO').value.trim();
  let parts=[];
  if(P) parts.push(`For ${P},`);
  if(I) parts.push(`is ${I}`);
  if(C && C!=='-') parts.push(`compared to ${C}`);
  if(O) parts.push(`effective for ${O}?`);
  const s=parts.join(' ').replace(/\s+,/g,',').trim();
  $('picoPreview').textContent=s||'—';
}
function studyIds(){return [...document.querySelectorAll('[data-study]')].map(el=>el.id)}
function rebuildStudies(n){
  studiesCount=Math.max(3,Math.min(5,n|0||3));
  const list=$('studiesList'); list.innerHTML='';
  const shouldDisable = !locked; // mirror current lock state
  for(let i=1;i<=studiesCount;i++){
    const id=`study_${i}`;
    list.insertAdjacentHTML('beforeend',
      `<div><textarea id="${id}" data-study ${shouldDisable?'disabled':''}></textarea></div>`
    );
  }
}
function addStudy(){ if(studiesCount>=5){toast('Max 5 studies');return;} rebuildStudies(studiesCount+1) }
function removeStudy(){ if(studiesCount<=3){toast('Need at least 3 studies');return;} rebuildStudies(studiesCount-1) }

/* =============== SAVE / LOAD =============== */
function storageKey(){const title=(currentCase?.title||'UNTITLED').slice(0,50); return CONFIG.APPKEY_PREFIX+title}
function collectData(){
  const fields={
    context:$('f_context').value,search:$('f_search').value,appraisal:$('f_appraisal').value,
    application:$('f_application').value,assumptions:$('f_assumptions').value,
    studies:studyIds().map(id=>$(id).value)
  };
  const pico={P:$('picoP').value,I:$('picoI').value,C:$('picoC').value,O:$('picoO').value,preview:$('picoPreview').textContent};
  return {caseTitle:currentCase?.title||'',fields,pico,timestamp:nowISO()}
}
function onSave(){ if(!currentCase){toast('Nothing to save');return;}
  try{
    const payload = JSON.stringify(collectData());
    const h = hashString(payload);
    if(h===lastSavedHash){ return; } // skip redundant write
    localStorage.setItem(storageKey(), payload);
    lastSavedHash = h;
    toast('Saved');
  }catch(e){console.error(e);toast('Save failed')}
}
function onLoad(){ if(!currentCase){toast('Randomize a case first');return;} const raw=localStorage.getItem(storageKey()); if(!raw){toast('No saved draft');return;}
  try{
    const d=JSON.parse(raw);
    $('f_context').value=d.fields?.context||''; $('f_search').value=d.fields?.search||'';
    $('f_appraisal').value=d.fields?.appraisal||''; $('f_application').value=d.fields?.application||'';
    $('f_assumptions').value=d.fields?.assumptions||'';
    rebuildStudies(Math.max(3,Math.min(5,d.fields?.studies?.length||3)));
    (d.fields?.studies||[]).forEach((v,i)=>{const id=`study_${i+1}`; if($(id)) $(id).value=v});
    $('picoP').value=d.pico?.P||''; $('picoI').value=d.pico?.I||''; $('picoC').value=d.pico?.C||''; $('picoO').value=d.pico?.O||'';
    updatePICO(); toast('Loaded');
    lastSavedHash=''; // reset guard after load
  }catch(e){console.error(e);toast('Load failed')}
}

/* =============== COPY / EXPORT =============== */
function plainScenarioText(){
  if(!currentCase) return 'No case selected.';
  const c=currentCase;
  const kv=[
    ['Title',c.title],['Client Profile',c.client_profile],['Setting',c.setting],
    ['Presenting Problem',c.presenting_problem],['Relevant History',c.relevant_history],
    ['Goals and Preferences',c.goals_and_preferences],['Strengths and Resources',c.strengths_and_resources],
    ['Contextual Factors and Barriers',c.contextual_factors_and_barriers],['EBP Decision Point',c.ebp_decision_point],
    ['Target Outcomes',c.target_outcomes],['Risks and Ethics',c.risks_and_ethics],['Equity Signal',c.equity_signal],
    ['Narrative',c.narrative]
  ];
  return kv.map(([k,v])=>`${k}:\n${normalizeDashes(stripEmojis(v||''))}`).join('\n\n')
}
function plainAllText(){
  const d=collectData();
  const studies=(d.fields.studies||[]).map((s,i)=>`Study ${i+1}:\n${s}`).join('\n\n');
  return `${plainScenarioText()}

PICO:
P: ${d.pico.P}
I: ${d.pico.I}
C: ${d.pico.C}
O: ${d.pico.O}
Question: ${d.pico.preview}

Client & Practice Context:
${d.fields.context}

Search Strategy & Study Selection:
${d.fields.search}

${studies}

Critical Appraisal:
${d.fields.appraisal}

Application & Delivery Plan:
${d.fields.application}

Assumptions:
${d.fields.assumptions}

Saved: ${d.timestamp}`
}
async function onCopyScenario(){
  const ok = await copyTextSafe(plainScenarioText());
  toast(ok?'Scenario copied':'Copy failed');
}
async function onCopyAll(){
  const ok = await copyTextSafe(plainAllText());
  toast(ok?'All copied':'Copy failed');
}
function onExport(){
  if(!currentCase){toast('Randomize a case first');return;}
  const d=collectData(), c=currentCase;
  const gridHTML=`<table border="1" cellpadding="6" cellspacing="0" style="border-collapse:collapse;width:100%">
    ${Object.entries({
      'Client Profile':c.client_profile,'Setting':c.setting,'Presenting Problem':c.presenting_problem,
      'Relevant History':c.relevant_history,'Goals and Preferences':c.goals_and_preferences,
      'Strengths and Resources':c.strengths_and_resources,'Contextual Factors and Barriers':c.contextual_factors_and_barriers,
      'EBP Decision Point':c.ebp_decision_point,'Target Outcomes':c.target_outcomes,'Risks and Ethics':c.risks_and_ethics,'Equity Signal':c.equity_signal
    }).map(([k,v])=>`<tr><td style="width:230px;font-weight:bold;background:#f5f5f5">${escapeHTML(k)}</td><td>${paragraphsHTML(v||'')}</td></tr>`).join('')}
  </table>`;
  const studiesHTML=(d.fields.studies||[]).map((s,i)=>`<h3>Study ${i+1}</h3><p>${escapeHTML(s).replace(/\n/g,'<br>')}</p>`).join('');
  const html=`<h1>${escapeHTML(c.title||'Untitled')}</h1>
    <p><strong>${escapeHTML(CONFIG.COURSE_TAG)}</strong></p>
    <h2>Intake Sheet</h2>${gridHTML}
    <h2>Narrative</h2>${paragraphsHTML(c.narrative||'')}
    <h2>PICO</h2>
    <p><strong>P:</strong> ${escapeHTML(d.pico.P)}<br><strong>I:</strong> ${escapeHTML(d.pico.I)}<br><strong>C:</strong> ${escapeHTML(d.pico.C)}<br><strong>O:</strong> ${escapeHTML(d.pico.O)}<br><strong>Question:</strong> ${escapeHTML(d.pico.preview)}</p>
    <h2>Client & Practice Context</h2><p>${escapeHTML(d.fields.context).replace(/\n/g,'<br>')}</p>
    <h2>Search Strategy & Study Selection</h2><p>${escapeHTML(d.fields.search).replace(/\n/g,'<br>')}</p>
    <h2>Study Summaries</h2>${studiesHTML}
    <h2>Critical Appraisal (incl. equity/representation)</h2><p>${escapeHTML(d.fields.appraisal).replace(/\n/g,'<br>')}</p>
    <h2>Application & Delivery Plan</h2><p>${escapeHTML(d.fields.application).replace(/\n/g,'<br>')}</p>
    ${d.fields.assumptions?.trim()?`<h2>Assumptions</h2><p>${escapeHTML(d.fields.assumptions).replace(/\n/g,'<br>')}</p>`:''}
    <p><em>Exported: ${escapeHTML(d.timestamp)}</em></p>`;
  window.htmlDocx.asBlobAsync(html).then(function(blob){
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    const safe=(c.title||'EBP_Note').replace(/[^\w\-]+/g,'_').slice(0,80)+'.docx';
    a.download=safe||CONFIG.DEFAULT_EXPORT_NAME;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{URL.revokeObjectURL(a.href);a.remove();},0);
    toast('Exported .docx');
  }).catch(function(err){
    console.error(err); toast('Export failed');
  });
}
function onNew(){clearBuilder(); toast('Cleared')}
</script>


  <!-- ===== DOCX exporter shim (pure WordprocessingML, no warnings) ===== -->
<script>
/* --- tiny UTF-8 + ZIP (store) builder --- */
function utf8Bytes(str){str=String(str);const b=[];for(let i=0;i<str.length;i++){let c=str.charCodeAt(i);if(c>=0xD800&&c<=0xDBFF&&i+1<str.length){const c2=str.charCodeAt(++i);if((c2&0xFC00)===0xDC00){c=0x10000+((c-0xD800)<<10)+(c2-0xDC00)}else{i--}}if(c<=0x7F)b.push(c);else if(c<=0x7FF)b.push(0xC0|(c>>6),0x80|(c&0x3F));else if(c<=0xFFFF)b.push(0xE0|(c>>12),0x80|((c>>6)&0x3F),0x80|(c&0x3F));else b.push(0xF0|(c>>18),0x80|((c>>12)&0x3F),0x80|((c>>6)&0x3F),0x80|(c&0x3F))}return new Uint8Array(b)}
const CRC_TABLE=(()=>{let c,t=[];for(let n=0;n<256;n++){c=n;for(let k=0;k<8;k++){c=((c&1)?(0xEDB88320^(c>>>1)):(c>>>1))}t[n]=c>>>0}return t})();function crc32(u8){let c=0^(-1);for(let i=0;i<u8.length;i++){c=(c>>>8)^CRC_TABLE[(c^u8[i])&255]}return (c^(-1))>>>0}
function le16(n){return new Uint8Array([n&255,(n>>8)&255])}function le32(n){return new Uint8Array([n&255,(n>>8)&255,(n>>16)&255,(n>>24)&255])}
function cat(chunks){const L=chunks.reduce((a,b)=>a+b.length,0);const out=new Uint8Array(L);let o=0;for(const c of chunks){out.set(c,o);o+=c.length}return out}
function zipBlobSync(files,mime){const LFH=0x04034b50,CDH=0x02014b50,EOCD=0x06054b50,ver=20,gpbf=0x0800,method=0;const now=new Date();const dosTime=((now.getHours()<<11)|(now.getMinutes()<<5)|(Math.floor(now.getSeconds()/2)));const dosDate=(((now.getFullYear()-1980)<<9)|((now.getMonth()+1)<<5)|now.getDate());const lfhChunks=[];const centrals=[];let offset=0;const headers=[];for(const f of files){const name=utf8Bytes(f.name);const data=f.data;const sum=crc32(data);const lfh=cat([le32(LFH),le16(ver),le16(gpbf),le16(method),le16(dosTime),le16(dosDate),le32(sum),le32(data.length),le32(data.length),le16(name.length),le16(0),name,data]);lfhChunks.push(lfh);headers.push({name,sum,size:data.length,offset,dosTime,dosDate});offset+=lfh.length}const startCD=offset;for(const h of headers){const cdh=cat([le32(CDH),le16(0x033F),le16(0x003F),le16(gpbf),le16(method),le16(h.dosTime),le16(h.dosDate),le32(h.sum),le32(h.size),le32(h.size),le16(h.name.length),le16(0),le16(0),le16(0),le16(0),le32(0),le32(h.offset),h.name]);centrals.push(cdh);offset+=cdh.length}const centralDir=cat(centrals);const end=cat([le32(EOCD),le16(0),le16(0),le16(headers.length),le16(headers.length),le32(centralDir.length),le32(startCD),le16(0)]);const zip=cat([...lfhChunks,centralDir,end]);return new Blob([zip],{type:mime||'application/zip'})}

/* ---- Minimal HTML -> WordprocessingML mapper (headings, paragraphs, <br>, simple tables) ---- */
function sanitize(text){return String(text||"").replace(/[\u2013\u2014]/g,"-").replace(/[\p{Extended_Pictographic}\uFE0F]/gu,"")}
function esc(s){return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}
function runText(t){return `<w:r><w:t xml:space="preserve">${esc(t)}</w:t></w:r>`}
function p(children,style){return `<w:p>${style?`<w:pPr><w:pStyle w:val="${style}"/></w:pPr>`:""}${children||""}</w:p>`}
function heading(text,level){const map={1:"Heading1",2:"Heading2",3:"Heading3"};return p(runText(text),map[level]||"Heading2")}

/* FIXED: use <w:br/> for line breaks, never open/close <w:p> inside another <w:p> */
function paragraphFromHTML(node){
  let out = "";
  node.childNodes.forEach(ch => {
    if (ch.nodeType === 3) {
      out += runText(ch.nodeValue || "");
    } else if (ch.nodeName === "BR") {
      out += '<w:r><w:br/></w:r>';
    } else if (ch.nodeType === 1) {
      out += paragraphFromHTML(ch);
    }
  });
  return out;
}
function para(text){return p(runText(text),null)}
function parseHTMLtoDoc(xmlString){
  const dom=new DOMParser().parseFromString(`<div>${xmlString}</div>`,'text/html');
  const root=dom.body.firstChild||dom.body;
  const blocks=root.querySelectorAll('h1,h2,h3,p,table');
  let bodyParts=[];
  if(blocks.length===0){ bodyParts=[para(sanitize(root.textContent||''))] }
  else {
    blocks.forEach(el=>{
      const tag=el.tagName.toLowerCase();
      if(tag==='h1'){bodyParts.push(heading(el.textContent||'',1))}
      else if(tag==='h2'){bodyParts.push(heading(el.textContent||'',2))}
      else if(tag==='h3'){bodyParts.push(heading(el.textContent||'',3))}
      else if(tag==='p'){bodyParts.push(p(paragraphFromHTML(el),null))}
      else if(tag==='table'){
        const rows=[...el.querySelectorAll('tr')].map(tr=>{
          const cells=[...tr.children].map(td=>{
            const txt=td.textContent||'';
            return `<w:tc><w:tcPr/><w:p><w:r><w:t xml:space="preserve">${esc(txt)}</w:t></w:r></w:p></w:tc>`;
          }).join('');
          return `<w:tr>${cells}</w:tr>`;
        }).join('');
        bodyParts.push(`<w:tbl><w:tblPr/><w:tblGrid/>${rows}</w:tbl>`);
      }
    });
  }
  return bodyParts.join('');
}
function buildDocxFromHTML(htmlInput){
  const safe = sanitize(htmlInput);
  const docBody = parseHTMLtoDoc(safe);
  const styles=`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
  <w:styles xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
    <w:style w:type="paragraph" w:styleId="Heading1"><w:name w:val="heading 1"/><w:basedOn w:val="Normal"/><w:pPr><w:keepNext/><w:keepLines/></w:pPr><w:rPr><w:b/><w:sz w:val="32"/></w:rPr></w:style>
    <w:style w:type="paragraph" w:styleId="Heading2"><w:name w:val="heading 2"/><w:basedOn w:val="Normal"/><w:pPr><w:keepNext/><w:keepLines/></w:pPr><w:rPr><w:b/><w:sz w:val="28"/></w:rPr></w:style>
    <w:style w:type="paragraph" w:styleId="Heading3"><w:name w:val="heading 3"/><w:basedOn w:val="Normal"/><w:pPr><w:keepNext/><w:keepLines/></w:pPr><w:rPr><w:b/><w:sz w:val="24"/></w:rPr></w:style>
  </w:styles>`;
  const contentTypes=`<?xml version="1.0" encoding="UTF-8"?>
  <Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
    <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
    <Default Extension="xml" ContentType="application/xml"/>
    <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
    <Override PartName="/word/styles.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.styles+xml"/>
  </Types>`;
  const rootRels=`<?xml version="1.0" encoding="UTF-8"?>
  <Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
    <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
  </Relationships>`;
  const docRels=`<?xml version="1.0" encoding="UTF-8"?>
  <Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
    <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/>
  </Relationships>`;
  const documentXML=`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
  <w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
    <w:body>${docBody}<w:sectPr/></w:body>
  </w:document>`;
  const files=[
    {name:'[Content_Types].xml',data:utf8Bytes(contentTypes)},
    {name:'_rels/.rels',data:utf8Bytes(rootRels)},
    {name:'word/_rels/document.xml.rels',data:utf8Bytes(docRels)},
    {name:'word/document.xml',data:utf8Bytes(documentXML)},
    {name:'word/styles.xml',data:utf8Bytes(styles)}
  ];
  return zipBlobSync(files,'application/vnd.openxmlformats-officedocument.wordprocessingml.document');
}

/* Shim: keep your existing calls working */
(function(){
  const api=window.htmlDocx||{};
  api.asBlob=function(html){ return buildDocxFromHTML(html); };
  api.asBlobAsync=function(html){ return Promise.resolve(buildDocxFromHTML(html)); };
  window.htmlDocx=api;
  console.info('DOCX shim active: pure-WordprocessingML');
})();
</script>



</body>
</html>
