<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EBP Case Vignette Randomizer & Note Builder</title>
  <style>
    :root{ --bg:#f6f7fb;--card:#ffffff;--ink:#111827;--muted:#6b7280;--primary:#6d28d9;--primary-ink:#fff;--ring:#c4b5fd;--ok:#059669;--warn:#b45309; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";color:var(--ink);background:var(--bg)}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .title{font-weight:800;font-size:20px;letter-spacing:.2px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px}
    button{appearance:none;border:1px solid transparent;background:var(--primary);color:var(--primary-ink);padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
    button.ghost{background:transparent;color:var(--ink);border-color:#e5e7eb}
    button.secondary{background:#111827;color:#fff}
    button:disabled{opacity:.55;cursor:not-allowed}
    .grid{display:grid;grid-template-columns:1fr 1.3fr;gap:16px}
    @media (max-width: 960px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:16px}
    .card h2{margin:0 0 8px 0;font-size:18px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    label{font-size:12px;color:#374151;font-weight:700}
    .hint{font-size:11px;color:#6b7280}
    input, textarea, select{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;color:var(--ink);font:inherit}
    textarea{min-height:110px;resize:vertical}
    .kvs{display:grid;grid-template-columns:180px 1fr;gap:8px}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;font-size:12px}
    .list{display:flex;flex-direction:column;gap:10px}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px dashed #d1d5db;border-radius:999px;padding:6px 10px;font-size:12px}
    .hr{height:1px;background:#eef0f4;margin:12px 0}
    .monospace{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .right{margin-left:auto}
    .warn{color:var(--warn)}
    .ok{color:var(--ok)}
    .chip{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;font-size:12px}
    .study{border:1px solid #e5e7eb;border-radius:12px;padding:12px}
    .counter{font-size:12px;color:var(--muted)}
    .status{font-size:12px}
    .footer{margin-top:14px;font-size:12px;color:var(--muted);display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .focus-ring:focus{outline:3px solid var(--ring);outline-offset:2px}
    .spin{animation:spin 1s linear infinite;display:inline-block}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="row">
        <div class="title">EBP Case Vignette Randomizer & Note Builder</div>
        <span class="badge">No login ‚Ä¢ Works offline ‚Ä¢ Export Word / Copy Text</span>
      </div>
      <div class="toolbar" role="toolbar" aria-label="Main">
        <button id="btnRandom" class="focus-ring" title="Randomize a case (R)">üé≤ Randomize</button>
        <button id="btnLock" class="ghost focus-ring" title="Lock/unlock the current case (L)">üîí Lock</button>
        <button id="btnNew" class="ghost focus-ring" title="Start a fresh note (N)">üßº New</button>
        <button id="btnSave" class="ghost focus-ring" title="Save to this browser (S)">üíæ Save</button>
        <button id="btnLoad" class="ghost focus-ring" title="Load last (O)">üìÇ Load</button>
        <button id="btnExport" class="secondary focus-ring" title="Export to Word (E)">‚¨áÔ∏è Export Word</button>
        <button id="btnCopy" class="ghost focus-ring" title="Copy as plain text">üìã Copy Text</button>
        <button id="btnPrint" class="ghost focus-ring" title="Print (P)">üñ®Ô∏è Print</button>
      </div>
    </header>

    <div class="grid" id="app">
      <section class="card" aria-labelledby="caseTitle">
        <h2 id="caseTitle">Case Vignette</h2>
        <div id="caseEmpty" class="muted">Click <strong>Randomize</strong> to draw a client vignette. Lock to begin the EBP note.</div>
        <div id="caseWrap" hidden>
          <div class="row" style="justify-content:space-between;align-items:flex-start">
            <div class="row" style="gap:8px;align-items:center">
              <div class="badge" id="caseId">ID</div>
              <div class="chip" id="caseTitleChip"></div>
            </div>
            <div class="status" id="lockStatus"></div>
          </div>
          <div class="hr"></div>

          <div class="row"><div class="badge">INTAKE SHEET</div></div>
          <div class="kvs">
            <div class="muted">Title</div><div id="vTitle"></div>
            <div class="muted">Client Profile</div><div id="vClient"></div>
            <div class="muted">Setting</div><div id="vSetting"></div>
            <div class="muted">Presenting Problem</div><div id="vProblem"></div>
            <div class="muted">Relevant History</div><div id="vHistory"></div>
            <div class="muted">Goals & Preferences</div><div id="vGoals"></div>
            <div class="muted">Strengths & Resources</div><div id="vStrengths"></div>
            <div class="muted">Contextual Factors & Barriers</div><div id="vContextual"></div>
            <div class="muted">EBP Decision Point</div><div id="vDecision"></div>
            <div class="muted">Target Outcomes</div><div id="vOutcomes"></div>
            <div class="muted">Risks & Ethics</div><div id="vRisks"></div>
            <div class="muted">Equity Signal</div><div id="vEquity"></div>
          </div>

          <div class="hr"></div>
          <div class="row"><div class="badge">NARRATIVE</div></div>
          <div id="vNarrative" style="white-space:pre-wrap"></div>
        </div>
      </section>

      <section class="card" aria-labelledby="builderTitle">
        <h2 id="builderTitle">EBP Process Note Builder</h2>
        <div id="lockGate" class="muted">Lock a case to enable editing.</div>
        <div id="builder" hidden>
          <div class="field">
            <label for="fContext">Client & Practice Context</label>
            <div class="hint">Describe the client, identities, setting, constraints, goals, and why this matters for ethical practice.</div>
            <textarea id="fContext"></textarea>
            <div class="row"><span class="counter" id="cntContext">0 words</span></div>
          </div>

          <div class="field">
            <label>PICO-style EBP Question</label>
            <div class="hint">Fill in Population, Intervention, (optional) Comparison, Outcome, and Timeframe. Preview shows a full question you can refine.</div>
            <div class="row">
              <div class="field" style="flex:1;min-width:160px"><label for="pPop">Population</label><input id="pPop" placeholder="e.g., Latinx adolescents with mild depression"/></div>
              <div class="field" style="flex:1;min-width:160px"><label for="pInt">Intervention</label><input id="pInt" placeholder="e.g., culturally adapted CBT"/></div>
            </div>
            <div class="row">
              <div class="field" style="flex:1;min-width:160px"><label for="pComp">Comparison (optional)</label><input id="pComp" placeholder="e.g., treatment as usual"/></div>
              <div class="field" style="flex:1;min-width:160px"><label for="pOut">Outcome</label><input id="pOut" placeholder="e.g., reduction in PHQ-9"/></div>
              <div class="field" style="width:160px"><label for="pTime">Timeframe</label><input id="pTime" placeholder="e.g., 12 weeks"/></div>
            </div>
            <div class="badge monospace" id="picoPreview">PICO preview...</div>
          </div>

          <div class="field">
            <label for="fSearch">Search Strategy & Study Selection</label>
            <div class="hint">Databases, keywords/MeSH, filters, inclusion/exclusion, and equity/representation considerations.</div>
            <textarea id="fSearch"></textarea>
            <div class="row"><span class="counter" id="cntSearch">0 words</span></div>
          </div>

          <div class="field">
            <label>Study Summaries</label>
            <div class="hint">Goal is usually <strong>3-5</strong> relevant peer-reviewed studies. Summarize what they did and found in your own words.</div>
            <div class="row"><span class="counter" id="cntStudies">Studies added: 0 / 3-5</span></div>
            <div id="studyList" class="list"></div>
            <details>
              <summary class="badge">‚ûï Add a study</summary>
              <div class="study" style="margin-top:10px">
                <div class="row">
                  <div class="field" style="flex:2"><label for="sTitle">Title</label><input id="sTitle"/></div>
                  <div class="field" style="width:120px"><label for="sYear">Year</label><input id="sYear" inputmode="numeric"/></div>
                  <div class="field" style="flex:1"><label for="sDesign">Design</label><input id="sDesign" placeholder="RCT, cohort, qual, etc."/></div>
                </div>
                <div class="row">
                  <div class="field" style="flex:1"><label for="sSample">Population / sample</label><input id="sSample" placeholder="n, demographics, setting"/></div>
                  <div class="field" style="flex:1"><label for="sMethods">Methods</label><input id="sMethods" placeholder="measures, procedures"/></div>
                </div>
                <div class="field"><label for="sFindings">Key findings (your words)</label><textarea id="sFindings"></textarea></div>
                <div class="row">
                  <div class="field" style="flex:1"><label for="sLimits">Limitations</label><input id="sLimits"/></div>
                  <div class="field" style="flex:1"><label for="sEquity">Equity/representation</label><input id="sEquity" placeholder="representation, cultural fit"/></div>
                </div>
                <div class="row">
                  <div class="field" style="flex:1"><label for="sUrl">DOI/URL</label><input id="sUrl" placeholder="https://... or doi:..."/></div>
                  <button id="btnAddStudy" class="right">Add Study</button>
                </div>
              </div>
            </details>
          </div>

          <div class="field">
            <label for="fAppraise">Critical Appraisal (incl. equity/representation)</label>
            <div class="hint">Discuss strengths/limitations, bias risks, cultural responsiveness, harms/benefits, power/representation, funding/conflicts.</div>
            <textarea id="fAppraise"></textarea>
            <div class="row"><span class="counter" id="cntAppraise">0 words</span></div>
          </div>

          <div class="field">
            <label for="fApply">Application & Delivery Plan</label>
            <div class="hint">What the evidence suggests for this client, adaptations, shared decision-making language, monitoring, consent, and ethics.</div>
            <textarea id="fApply"></textarea>
            <div class="row"><span class="counter" id="cntApply">0 words</span></div>
          </div>

          <div class="field">
            <label for="fAssumptions">Assumptions I am Making (optional)</label>
            <div class="hint">Note any reasonable assumptions due to missing or ambiguous details.</div>
            <textarea id="fAssumptions"></textarea>
          </div>

          <div class="hr"></div>
          <div class="row" style="justify-content:space-between">
            <div class="badge">Rubric checklist</div>
            <div id="progress" class="status">0/6 sections with 100+ words</div>
          </div>
          <ul id="rubric" class="list" style="margin:8px 0 0 18px">
            <li>Client and context clearly described with equity/ethics lens</li>
            <li>Focused, researchable PICO(T) reflects client goals</li>
            <li>Transparent search and selection, includes equity considerations</li>
            <li>Accurate study summaries in your own words</li>
            <li>Critical appraisal of strength, bias, and representation</li>
            <li>Practice application and shared decision-making plan</li>
          </ul>
        </div>
      </section>
    </div>

    <div class="footer">
      <span>Autosave:</span><span id="saveStatus">idle</span>
      <span class="muted">‚Ä¢</span><span>Tip: R = Randomize, L = Lock, E = Export Word.</span>
    </div>
  </div>

  <script>
    // ---------- Data (raw) ----------
    const RAW_VIGNETTES = [
      { id: "case_01_school_anxiety", title: "Marisol: Balancing School, Work, and Panic on Transit", client_profile: { age: "17-year-old", pronouns: "she/her", race_ethnicity: "Mexican American, first-gen", gender_sexuality: "Cisgender, straight", primary_language: "Bilingual Spanish/English; prefers English with occasional Spanish", disability_health: "No formal diagnoses; reports episodic chest tightness and dizziness" }, setting: "Urban public high school‚Äîschool social work office; 20‚Äì30 minute consults.", presenting_problem: "Over the past month, Marisol has left two morning classes after experiencing sudden panic on a crowded bus. She was referred by a teacher after missing quizzes and crying in the hallway. She says she is embarrassed and worries staff think she is 'being dramatic.'", relevant_history: "Lives with her mother and two younger siblings; works evenings at a grocery store to help with bills. No child welfare or legal system involvement. Tried a lunchtime mindfulness club last year and liked it but stopped when her work schedule changed. Father recently moved out after parental conflict, which Marisol describes as 'loud and exhausting.'", goals_and_preferences: "Wants to graduate on time and keep her part-time job. Prefers brief, concrete strategies over long talk therapy. Wants a woman provider who understands Latinx family dynamics. Unsure if breathing exercises 'really work' and open to learning other options.", strengths_and_resources: "Honor-roll student in two subjects; helps siblings with homework; close relationship with her aunt; listens to music and journals; bilingual; strong work ethic; supportive teacher who offers a quiet space when needed.", contextual_factors_and_barriers: "Shared two-bedroom apartment; mother has irregular hours; Marisol pays part of rent. Long bus commute; often stands due to crowding. Experiences subtle stereotyping at school (e.g., 'You people are late' jokes). Limited time for appointments; cannot miss shifts.", ebp_decision_point: "You are deciding whether to focus first on exposure-based strategies for panic during transit versus a school-based skills group with between-session practice. The choice may affect feasibility and speed of relief.", target_outcomes: ["panic symptom frequency/severity (self-report)", "class attendance on first period days", "use of coping skills during transit"], risks_and_ethics: "No current self-harm or violence reported. Safety plan not indicated. Discussed privacy limits and the extent of school record sharing.", equity_signal: "Consider immigration-related stress, bilingual preferences, and how school discipline norms shape both the evidence and feasible options." },
      { id: "case_02_reentry_employment", title: "Devon: Reentering After Juvenile Detention", client_profile: { age: "19-year-old", pronouns: "he/him", race_ethnicity: "Black", gender_sexuality: "Cisgender, straight", primary_language: "English", disability_health: "Possible ADHD (never evaluated); no current meds" }, setting: "Community re-entry program partnering with a workforce agency; rolling weekly workshops and 1:1 coaching.", presenting_problem: "Devon was mandated to the program after a 6-month juvenile detention stay related to a property offense. He is punctual but guarded, saying he needs a job but 'doesn't do school stuff.' He reports conflicts with a supervisor at a short-lived warehouse placement.", relevant_history: "Lives with his grandmother; sporadic contact with father. School suspensions began in middle school for 'defiance.' No gang affiliation per client. Brief probation counseling previously felt judgmental. Enjoys music production and basketball.", goals_and_preferences: "Wants steady work to contribute at home and buy studio equipment. Prefers hands-on coaching over group classes. Ambivalent about disclosing record to employers; wants help deciding what to say.", strengths_and_resources: "On time to sessions; protects and helps grandmother with errands; learns quickly when shown; coaches younger cousins in basketball; music production hobby demonstrates persistence and problem solving.", contextual_factors_and_barriers: "Limited bus lines to industrial job sites; prior record triggers background checks; peers experiencing similar re-entry stressors; occasional neighborhood police stops that feel harassing.", ebp_decision_point: "Decide whether to prioritize a supported employment model with job development versus a time-limited job-readiness group plus peer mentor check-ins.", target_outcomes: ["employment acquisition and retention", "days worked per month", "self-efficacy about handling workplace conflict"], risks_and_ethics: "No current safety risks disclosed. Program has data-sharing agreements with probation; informed consent and boundaries should be clarified.", equity_signal: "Pay attention to how racialized policing and prior system involvement affect both evidence relevance and fairness in access to employment supports." },
      { id: "case_03_primarycare_chronic", title: "Asha: Managing Pain in Primary Care With Caregiving Duties", client_profile: { age: "46-year-old", pronouns: "she/her", race_ethnicity: "South Asian (Bangladeshi American)", gender_sexuality: "Cisgender, straight", primary_language: "Bilingual Bengali/English; prefers English in clinic, Bengali at home", disability_health: "Chronic low-back pain; prediabetes; no current opioids" }, setting: "Integrated primary care clinic co-located with behavioral health; 20‚Äì30 minute consults.", presenting_problem: "Asha reports worsening back pain after increasing hours at a sewing job and lifting her father during transfers. Sleep is fragmented. She is skeptical of 'pain classes' and worries about medication side effects.", relevant_history: "Married; two school-aged children; cares for her father with limited outside help. No psychiatric hospitalizations; one brief CBT course 5 years ago helpful for worry. Financial strain after husband's reduced hours.", goals_and_preferences: "Wants to reduce pain enough to work and sleep 6 hours. Prefers practical strategies that fit cultural routines; open to group only if women-only and time-limited. Values faith practices and modesty.", strengths_and_resources: "Strong family ties; active in mosque; skilled with routines; motivated to learn; supportive neighbor available occasionally.", contextual_factors_and_barriers: "Irregular shifts; limited transportation; caregiving burden; insurance requires prior authorization; cultural norms around modesty may affect PT options.", ebp_decision_point: "Choose between an individually delivered brief behavioral pain management protocol versus referral to a culturally tailored group program that includes pacing and movement.", target_outcomes: ["pain interference", "hours slept per night", "functional activity engagement"], risks_and_ethics: "No acute risk reported. Discussed confidentiality and the option to include spouse with consent.", equity_signal: "Consider language access, gendered group norms, and whether studies represent South Asian women in caregiving roles." }
    ];

    // ---------- Clean em dashes globally ----------
    function stripEmDashesDeep(v){
      if(Array.isArray(v)) return v.map(stripEmDashesDeep);
      if(v && typeof v === 'object'){ const o={}; for(const k in v) o[k]=stripEmDashesDeep(v[k]); return o; }
      if(typeof v === 'string') return v.replace(/‚Äî/g,'-');
      return v;
    }
    const VIGNETTES = RAW_VIGNETTES.map(stripEmDashesDeep);

    // ---------- State ----------
    const $ = (sel)=>document.querySelector(sel);
    let current = null, locked = false, studies = [];

    const F = { context: $('#fContext'), search: $('#fSearch'), appraise: $('#fAppraise'), apply: $('#fApply'), assumptions: $('#fAssumptions') };
    const PICO = { pop: $('#pPop'), int: $('#pInt'), comp: $('#pComp'), out: $('#pOut'), time: $('#pTime'), preview: $('#picoPreview') };

    const els = {
      caseEmpty: $('#caseEmpty'), caseWrap: $('#caseWrap'), caseId: $('#caseId'), caseTitleChip: $('#caseTitleChip'), lockStatus: $('#lockStatus'),
      vTitle: $('#vTitle'), vClient: $('#vClient'), vSetting: $('#vSetting'), vProblem: $('#vProblem'), vHistory: $('#vHistory'), vGoals: $('#vGoals'), vStrengths: $('#vStrengths'), vContextual: $('#vContextual'), vDecision: $('#vDecision'), vOutcomes: $('#vOutcomes'), vRisks: $('#vRisks'), vEquity: $('#vEquity'), vNarrative: $('#vNarrative'),
      lockGate: $('#lockGate'), builder: $('#builder'),
      studyList: $('#studyList'), saveStatus: $('#saveStatus'), progress: $('#progress'), cntStudies: $('#cntStudies')
    };

    // ---------- Utils ----------
    const uid = ()=>Math.random().toString(36).slice(2,9);
    const nowISO = ()=>new Date().toISOString();
    const wordCount = (s)=> (s||"").trim().split(/\s+/).filter(Boolean).length;
    const sanitize = (s)=> (s||"").toString().replace(/[\t\r]/g,' ').trim();
    const debounce = (fn, ms=800)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(null,a), ms); }; };
    const autoKey = ()=> current ? `EBP_NOTE_${current.id}` : 'EBP_NOTE_UNSET';

    const noEm = (s)=> (s||'').toString().replace(/‚Äî/g,'-');

    function renderClientProfile(cp){
      const bits = [];
      if(cp.age) bits.push(noEm(cp.age));
      if(cp.pronouns) bits.push(`(${noEm(cp.pronouns)})`);
      if(cp.race_ethnicity) bits.push(noEm(cp.race_ethnicity));
      if(cp.gender_sexuality) bits.push(noEm(cp.gender_sexuality));
      const lang = cp.primary_language?` ‚Ä¢ Language: ${noEm(cp.primary_language)}`:'';
      const health = cp.disability_health?` ‚Ä¢ Health: ${noEm(cp.disability_health)}`:'';
      return `${bits.join(' ‚Ä¢ ')}${lang}${health}`;
    }

    function buildNarrative(c){
      const who = renderClientProfile(c.client_profile);
      const p1 = `You are the clinician and your client. They meet with you in ${noEm(c.setting)}. ${noEm(c.presenting_problem)}`;
      const p2 = `They describe goals and preferences: ${noEm(c.goals_and_preferences)}. Strengths include ${noEm(c.strengths_and_resources)}.`;
      const p3 = `Context and barriers: ${noEm(c.contextual_factors_and_barriers)}.`;
      const p4 = `An explicit decision point is on the table: ${noEm(c.ebp_decision_point)}. Target outcomes include ${Array.isArray(c.target_outcomes)? noEm(c.target_outcomes.join('; ')) : noEm(c.target_outcomes)}.`;
      const p5 = `Risks and ethics noted: ${noEm(c.risks_and_ethics)}. Equity signal: ${noEm(c.equity_signal)}.`;
      return [who, p1, p2, p3, p4, p5].join('\n\n');
    }

    function picoPreview(){
      const p = [PICO.pop.value, PICO.int.value, PICO.comp.value, PICO.out.value, PICO.time.value].map(sanitize);
      const [pop,intv,comp,out,time] = p;
      let q = `In ${pop||'__'}, does ${intv||'__'}${comp?(' compared to '+comp):''} improve ${out||'__'}${time?(' over '+time):''}?`;
      PICO.preview.textContent = q;
    }

    function updateCounters(){
      $('#cntContext').textContent = `${wordCount(F.context.value)} words`;
      $('#cntSearch').textContent = `${wordCount(F.search.value)} words`;
      $('#cntAppraise').textContent = `${wordCount(F.appraise.value)} words`;
      $('#cntApply').textContent = `${wordCount(F.apply.value)} words`;
      els.cntStudies.textContent = `Studies added: ${studies.length} / 3-5`;
      const hits = [F.context,F.search,F.appraise,F.apply].filter(x=>wordCount(x.value)>=100).length;
      els.progress.textContent = `${hits}/6 sections with 100+ words`;
    }

    function renderCase(){
      if(!current){ els.caseWrap.hidden=true; els.caseEmpty.hidden=false; return; }
      els.caseEmpty.hidden=true; els.caseWrap.hidden=false;
      els.caseId.textContent = current.id;
      els.caseTitleChip.textContent = noEm(current.title);
      els.vTitle.textContent = noEm(current.title);
      els.vClient.textContent = renderClientProfile(current.client_profile);
      els.vSetting.textContent = noEm(current.setting);
      els.vProblem.textContent = noEm(current.presenting_problem);
      els.vHistory.textContent = noEm(current.relevant_history);
      els.vGoals.textContent = noEm(current.goals_and_preferences);
      els.vStrengths.textContent = noEm(current.strengths_and_resources);
      els.vContextual.textContent = noEm(current.contextual_factors_and_barriers);
      els.vDecision.textContent = noEm(current.ebp_decision_point);
      els.vOutcomes.textContent = Array.isArray(current.target_outcomes)? noEm(current.target_outcomes.join('; ')) : noEm(current.target_outcomes);
      els.vRisks.textContent = noEm(current.risks_and_ethics);
      els.vEquity.textContent = noEm(current.equity_signal);
      els.vNarrative.textContent = buildNarrative(current);
      updateLockUi();
    }

    function updateLockUi(){
      els.lockStatus.innerHTML = locked ? '<span class="ok">Locked for editing</span>' : '<span class="warn">Unlocked</span>';
      $('#btnLock').textContent = locked ? 'üîì Unlock' : 'üîí Lock';
      els.lockGate.hidden = locked;
      els.builder.hidden = !locked;
    }

    function randomize(){
      const b = $('#btnRandom');
      b.disabled = true; b.innerHTML = '<span class="spin">üé≤</span> Rolling...';
      setTimeout(()=>{
        current = VIGNETTES[Math.floor(Math.random()*VIGNETTES.length)];
        locked = false; studies = [];
        clearAllFields();
        renderCase(); renderStudies();
        b.disabled=false; b.textContent='üé≤ Randomize';
        toast('New case drawn. Review and lock to start.');
      }, 600);
    }

    function clearAllFields(){
      for(const el of Object.values(F)) el.value='';
      for(const el of [PICO.pop,PICO.int,PICO.comp,PICO.out,PICO.time]) el.value='';
      picoPreview(); updateCounters();
    }

    function toggleLock(){ if(!current){ toast('Draw a case first.'); return; } locked = !locked; updateLockUi(); if(locked){ loadDraft(); } }

    function addStudy(){
      const s = { id: uid(), title: sanitize($('#sTitle').value), year: sanitize($('#sYear').value), design: sanitize($('#sDesign').value), sample: sanitize($('#sSample').value), methods: sanitize($('#sMethods').value), findings: sanitize($('#sFindings').value), limits: sanitize($('#sLimits').value), equity: sanitize($('#sEquity').value), url: sanitize($('#sUrl').value) };
      if(!s.title || !s.findings){ toast('Title and findings are required.'); return; }
      if(s.year && !/^\d{4}$/.test(s.year)){ toast('Year must be 4 digits.'); return; }
      studies.push(s); renderStudies(); ['#sTitle','#sYear','#sDesign','#sSample','#sMethods','#sFindings','#sLimits','#sEquity','#sUrl'].forEach(sel=>$(sel).value=''); autosave();
    }

    function removeStudy(id){ studies = studies.filter(x=>x.id!==id); renderStudies(); autosave(); }

    function renderStudies(){
      const wrap = els.studyList; wrap.innerHTML = '';
      if(studies.length===0){ const p = document.createElement('div'); p.className='muted'; p.textContent='No studies yet. Aim for 3-5 relevant peer-reviewed sources.'; wrap.appendChild(p); updateCounters(); return; }
      for(const s of studies){
        const div = document.createElement('div'); div.className='study';
        div.innerHTML = `
          <div class="row"><strong>${escapeHtml(s.title)}</strong> <span class="chip">${s.design||'Design n/a'}</span> <span class="chip">${s.year||'Year n/a'}</span> <button class="ghost right" data-id="${s.id}">Remove</button></div>
          <div class="kvs" style="margin-top:6px">
            <div class="muted">Population</div><div>${escapeHtml(s.sample||'‚Äî').replace(/‚Äî/g,'-')}</div>
            <div class="muted">Methods</div><div>${escapeHtml(s.methods||'‚Äî').replace(/‚Äî/g,'-')}</div>
            <div class="muted">Findings</div><div>${escapeHtml(s.findings||'‚Äî').replace(/‚Äî/g,'-')}</div>
            <div class="muted">Limitations</div><div>${escapeHtml(s.limits||'‚Äî').replace(/‚Äî/g,'-')}</div>
            <div class="muted">Equity</div><div>${escapeHtml(s.equity||'‚Äî').replace(/‚Äî/g,'-')}</div>
            <div class="muted">DOI/URL</div><div>${(s.url?`<a href="${escapeHtml(s.url)}" target="_blank" rel="noopener">${escapeHtml(s.url)}</a>`:'‚Äî').replace(/‚Äî/g,'-')}</div>
          </div>`;
        div.querySelector('button[data-id]').addEventListener('click',()=>removeStudy(s.id));
        wrap.appendChild(div);
      }
      updateCounters();
    }

    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

    // ---------- Autosave ----------
    const autosave = debounce(()=>{
      if(!current || !locked) return;
      const data = { case: current, locked, studies, fields: { context:F.context.value, search:F.search.value, appraise:F.appraise.value, apply:F.apply.value, assumptions:F.assumptions.value }, pico: { pop:PICO.pop.value, int:PICO.int.value, comp:PICO.comp.value, out:PICO.out.value, time:PICO.time.value }, ts: nowISO() };
      try{ localStorage.setItem(autoKey(), JSON.stringify(data)); els.saveStatus.textContent = `saved ${new Date().toLocaleTimeString()}`; }
      catch(e){ els.saveStatus.textContent = 'save failed'; }
    }, 1200);

    function loadDraft(){
      const raw = localStorage.getItem(autoKey());
      if(!raw) { els.saveStatus.textContent='no draft'; return; }
      try{
        const d = JSON.parse(raw);
        studies = Array.isArray(d.studies)? d.studies : [];
        F.context.value = d.fields?.context||'';
        F.search.value = d.fields?.search||'';
        F.appraise.value = d.fields?.appraise||'';
        F.apply.value = d.fields?.apply||'';
        F.assumptions.value = d.fields?.assumptions||'';
        PICO.pop.value = d.pico?.pop||'';
        PICO.int.value = d.pico?.int||'';
        PICO.comp.value = d.pico?.comp||'';
        PICO.out.value = d.pico?.out||'';
        PICO.time.value = d.pico?.time||'';
        picoPreview(); updateCounters(); renderStudies();
        els.saveStatus.textContent = `loaded draft (${new Date(d.ts).toLocaleString()})`;
      }catch(e){ els.saveStatus.textContent='load failed'; }
    }

    // ---------- Export / Copy / Print ----------
    function buildDocHtml(){
      if(!current) return '<!doctype html><html><head><meta charset="utf-8"><title>EBP Note</title></head><body><p>No case selected.</p></body></html>';
      const esc = (s)=>escapeHtml(noEm((s||'').toString()));
      const p = PICO.preview.textContent;
      const h = [];
      h.push('<!doctype html><html><head><meta charset="utf-8"><title>EBP Note - '+esc(current.title)+'</title>');
      h.push('<style>body{font-family:Calibri,Arial,Helvetica,sans-serif;line-height:1.4;color:#111} h1,h2,h3{margin:0 0 6px} h1{font-size:22px} h2{font-size:18px;margin-top:16px} h3{font-size:15px;margin-top:12px} ul{margin:4px 0 8px 18px} .meta li{margin:2px 0} .k{color:#374151} .small{color:#555;font-size:12px} @page{margin:1in} </style></head><body>');
      h.push('<h1>EBP Process Note - '+esc(current.title)+' ('+esc(current.id)+')</h1>');
      h.push('<h2>Case Vignette</h2>');
      h.push('<ul class="meta">');
      h.push('<li><span class="k">Client Profile:</span> '+esc(renderClientProfile(current.client_profile))+'</li>');
      h.push('<li><span class="k">Setting:</span> '+esc(current.setting)+'</li>');
      h.push('<li><span class="k">Presenting Problem:</span> '+esc(current.presenting_problem)+'</li>');
      h.push('<li><span class="k">Relevant History:</span> '+esc(current.relevant_history)+'</li>');
      h.push('<li><span class="k">Goals & Preferences:</span> '+esc(current.goals_and_preferences)+'</li>');
      h.push('<li><span class="k">Strengths & Resources:</span> '+esc(current.strengths_and_resources)+'</li>');
      h.push('<li><span class="k">Contextual Factors & Barriers:</span> '+esc(current.contextual_factors_and_barriers)+'</li>');
      h.push('<li><span class="k">EBP Decision Point:</span> '+esc(current.ebp_decision_point)+'</li>');
      h.push('<li><span class="k">Target Outcomes:</span> '+esc(Array.isArray(current.target_outcomes)? current.target_outcomes.join('; ') : current.target_outcomes)+'</li>');
      h.push('<li><span class="k">Risks & Ethics:</span> '+esc(current.risks_and_ethics)+'</li>');
      h.push('<li><span class="k">Equity Signal:</span> '+esc(current.equity_signal)+'</li>');
      h.push('</ul>');
      h.push('<h2>Narrative</h2><p>'+esc(buildNarrative(current)).replace(/\n/g,'<br>')+'</p>');
      h.push('<h2>Client & Practice Context</h2><p>'+esc(F.context.value).replace(/\n/g,'<br>')+'</p>');
      h.push('<h2>PICO-style EBP Question</h2><p><strong>Question:</strong> '+esc(p)+'</p>');
      h.push('<h2>Search Strategy & Study Selection</h2><p>'+esc(F.search.value).replace(/\n/g,'<br>')+'</p>');
      h.push('<h2>Study Summaries</h2>');
      if(studies.length===0){ h.push('<p><em>No studies added yet.</em></p>'); }
      else{ studies.forEach((s,i)=>{ h.push('<h3>Study '+(i+1)+': '+esc(s.title)+(s.year?(' ('+esc(s.year)+')'):'')+'</h3><ul>'); if(s.design) h.push('<li><strong>Design:</strong> '+esc(s.design)+'</li>'); if(s.sample) h.push('<li><strong>Population/Sample:</strong> '+esc(s.sample)+'</li>'); if(s.methods) h.push('<li><strong>Methods:</strong> '+esc(s.methods)+'</li>'); if(s.findings) h.push('<li><strong>Key Findings (own words):</strong> '+esc(s.findings)+'</li>'); if(s.limits) h.push('<li><strong>Limitations:</strong> '+esc(s.limits)+'</li>'); if(s.equity) h.push('<li><strong>Equity/Representation:</strong> '+esc(s.equity)+'</li>'); if(s.url) h.push('<li><strong>DOI/URL:</strong> '+esc(s.url)+'</li>'); h.push('</ul>'); }); }
      h.push('<h2>Critical Appraisal (incl. equity/representation)</h2><p>'+esc(F.appraise.value).replace(/\n/g,'<br>')+'</p>');
      h.push('<h2>Application & Delivery Plan</h2><p>'+esc(F.apply.value).replace(/\n/g,'<br>')+'</p>');
      if(F.assumptions.value){ h.push('<h2>Assumptions</h2><p>'+esc(F.assumptions.value).replace(/\n/g,'<br>')+'</p>'); }
      h.push('<p class="small">Generated '+new Date().toLocaleString()+'</p>');
      h.push('</body></html>');
      return h.join('');
    }

    function buildPlainText(){
      if(!current) return 'No case selected.';
      const p = PICO.preview.textContent;
      const lines = [];
      lines.push(`EBP Process Note - ${noEm(current.title)} (${current.id})`);
      lines.push('');
      lines.push('Case Vignette');
      lines.push(`- Client Profile: ${renderClientProfile(current.client_profile)}`);
      lines.push(`- Setting: ${noEm(current.setting)}`);
      lines.push(`- Presenting Problem: ${noEm(current.presenting_problem)}`);
      lines.push(`- Relevant History: ${noEm(current.relevant_history)}`);
      lines.push(`- Goals & Preferences: ${noEm(current.goals_and_preferences)}`);
      lines.push(`- Strengths & Resources: ${noEm(current.strengths_and_resources)}`);
      lines.push(`- Contextual Factors & Barriers: ${noEm(current.contextual_factors_and_barriers)}`);
      lines.push(`- EBP Decision Point: ${noEm(current.ebp_decision_point)}`);
      lines.push(`- Target Outcomes: ${Array.isArray(current.target_outcomes)? noEm(current.target_outcomes.join('; ')): noEm(current.target_outcomes)}`);
      lines.push(`- Risks & Ethics: ${noEm(current.risks_and_ethics)}`);
      lines.push(`- Equity Signal: ${noEm(current.equity_signal)}`);
      lines.push('');
      lines.push('Narrative');
      lines.push(noEm(buildNarrative(current))); lines.push('');
      lines.push('Client & Practice Context');
      lines.push(F.context.value); lines.push('');
      lines.push('PICO-style EBP Question');
      lines.push(`Question: ${p}`); lines.push('');
      lines.push('Search Strategy & Study Selection');
      lines.push(F.search.value); lines.push('');
      lines.push('Study Summaries');
      if(studies.length===0){ lines.push('No studies added yet.'); }
      else{ studies.forEach((s,i)=>{ lines.push(`Study ${i+1}: ${noEm(s.title)}${s.year?` (${noEm(s.year)})`:''}`); if(s.design) lines.push(`  - Design: ${noEm(s.design)}`); if(s.sample) lines.push(`  - Population/Sample: ${noEm(s.sample)}`); if(s.methods) lines.push(`  - Methods: ${noEm(s.methods)}`); if(s.findings) lines.push(`  - Key Findings: ${noEm(s.findings)}`); if(s.limits) lines.push(`  - Limitations: ${noEm(s.limits)}`); if(s.equity) lines.push(`  - Equity/Representation: ${noEm(s.equity)}`); if(s.url) lines.push(`  - DOI/URL: ${noEm(s.url)}`); }); }
      lines.push('');
      lines.push('Critical Appraisal (incl. equity/representation)');
      lines.push(F.appraise.value); lines.push('');
      lines.push('Application & Delivery Plan');
      lines.push(F.apply.value); lines.push('');
      if(F.assumptions.value){ lines.push('Assumptions'); lines.push(F.assumptions.value); lines.push(''); }
      lines.push(`Generated ${new Date().toLocaleString()}`);
      return lines.join('\n');
    }

    function downloadWord(){
      const html = buildDocHtml();
      const blob = new Blob([html], {type:'application/msword'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const name = current?`EBP_Note_${current.id}.doc`:'EBP_Note.doc';
      a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url);
      toast('Word file downloaded.');
    }

    async function copyPlain(){
      try{ await navigator.clipboard.writeText(buildPlainText()); toast('Copied as plain text.'); }
      catch(e){ toast('Copy failed. Use Export Word instead.'); }
    }

    function printPage(){ window.print(); }

    // ---------- Save / Load buttons (manual) ----------
    function manualSave(){ autosave.flush?autosave.flush():autosave(); }
    function manualLoad(){ if(!current){ toast('Select and lock a case first.'); return;} loadDraft(); }
    autosave.flush = function(){
      const fn = autosave; fn();
      if(!current || !locked) return;
      const data = { case: current, locked, studies, fields: { context:F.context.value, search:F.search.value, appraise:F.appraise.value, apply:F.apply.value, assumptions:F.assumptions.value }, pico: { pop:PICO.pop.value, int:PICO.int.value, comp:PICO.comp.value, out:PICO.out.value, time:PICO.time.value }, ts: nowISO() };
      try{ localStorage.setItem(autoKey(), JSON.stringify(data)); els.saveStatus.textContent = `saved ${new Date().toLocaleTimeString()}`; }
      catch(e){ els.saveStatus.textContent = 'save failed'; }
    }

    // ---------- Toast ----------
    let toastTimer=null; const toastDiv = document.createElement('div');
    toastDiv.style.position='fixed'; toastDiv.style.bottom='16px'; toastDiv.style.left='50%'; toastDiv.style.transform='translateX(-50%)'; toastDiv.style.background='#111827'; toastDiv.style.color='#fff'; toastDiv.style.padding='10px 14px'; toastDiv.style.borderRadius='10px'; toastDiv.style.boxShadow='0 6px 20px rgba(0,0,0,.15)'; toastDiv.style.zIndex='9999'; toastDiv.style.display='none'; document.body.appendChild(toastDiv);
    function toast(msg){ clearTimeout(toastTimer); toastDiv.textContent=msg; toastDiv.style.display='block'; toastTimer=setTimeout(()=>toastDiv.style.display='none',1900); }

    // ---------- Events ----------
    $('#btnRandom').addEventListener('click', randomize);
    $('#btnLock').addEventListener('click', toggleLock);
    $('#btnNew').addEventListener('click', ()=>{ if(confirm('Clear current note?')){ clearAllFields(); studies=[]; renderStudies(); autosave(); }});
    $('#btnSave').addEventListener('click', manualSave);
    $('#btnLoad').addEventListener('click', manualLoad);
    $('#btnExport').addEventListener('click', downloadWord);
    $('#btnCopy').addEventListener('click', copyPlain);
    $('#btnPrint').addEventListener('click', printPage);

    $('#btnAddStudy').addEventListener('click', addStudy);

    ;[F.context,F.search,F.appraise,F.apply,F.assumptions].forEach(el=>{ el.addEventListener('input', ()=>{ updateCounters(); autosave(); }); });
    ;[PICO.pop,PICO.int,PICO.comp,PICO.out,PICO.time].forEach(el=>{ el.addEventListener('input', ()=>{ picoPreview(); autosave(); }); });

    // Shortcuts
    window.addEventListener('keydown', (e)=>{
      if(['INPUT','TEXTAREA'].includes(document.activeElement.tagName) && (e.ctrlKey||e.metaKey)) return;
      if(e.key==='r' || e.key==='R'){ e.preventDefault(); randomize(); }
      if(e.key==='l' || e.key==='L'){ e.preventDefault(); toggleLock(); }
      if(e.key==='p' || e.key==='P'){ e.preventDefault(); printPage(); }
      if((e.key==='e'||e.key==='E') && locked){ e.preventDefault(); downloadWord(); }
    });

    // Initial
    picoPreview(); updateCounters(); renderCase(); renderStudies();
  </script>
</body>
</html>
