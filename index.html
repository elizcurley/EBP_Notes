<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>EBP Case Randomizer & Note Builder</title>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--ink:#111827;--muted:#6b7280;--primary:#6d28d9;--primary-ink:#fff;--ring:#c4b5fd;}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:16px}
    .title{font-weight:800;font-size:20px}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;font-size:12px;color:#374151;background:#fff}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    button{appearance:none;border:1px solid transparent;background:var(--primary);color:var(--primary-ink);padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
    button.ghost{background:transparent;color:var(--ink);border-color:#e5e7eb}
    button.secondary{background:#111827;color:#fff}
    button:disabled{opacity:.55;cursor:not-allowed}
    .grid{display:grid;grid-template-columns:1fr 1.3fr;gap:16px}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:16px}
    .card h2{margin:0 0 8px 0;font-size:18px}
    .muted{color:var(--muted)}
    .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .hr{height:1px;background:#eef0f4;margin:12px 0}
    .focus-ring:focus{outline:3px solid var(--ring);outline-offset:2px}
    .spin{animation:spin 1s linear infinite;display:inline-block} @keyframes spin{to{transform:rotate(360deg)}}
    .hidden{display:none}
    .kvs{display:grid;grid-template-columns:200px 1fr;gap:8px}
    .kvs .muted{align-self:start}
    .scenario p{margin:0 0 10px 0}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
    label{font-size:12px;color:#374151;font-weight:700}
    .hint{font-size:11px;color:#6b7280}
    input,textarea{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;color:var(--ink);font:inherit}
    textarea{min-height:120px;resize:vertical}
    .status{font-size:12px;color:#374151}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid #e5e7eb;background:#f3f4f6;border-radius:999px;padding:6px 10px;font-size:12px}
    .footer{margin-top:14px;font-size:12px;color:var(--muted);display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    #errBanner{position:fixed;top:0;left:0;right:0;background:#b91c1c;color:#fff;padding:8px 12px;display:none;z-index:10000;font-size:12px}
  </style>
</head>
<body>
<div id="errBanner"></div>
<div class="container">
  <header>
    <div class="row">
      <div class="title">EBP Case Randomizer & Note Builder</div>
      <span class="badge">SOW5404 ‚Ä¢ Spring 2026 ‚Ä¢ No login ‚Ä¢ Export Word / Copy Text</span>
    </div>
    <div class="toolbar" role="toolbar" aria-label="Main">
      <button id="btnRandom" class="focus-ring" title="Alt+R ‚Äî Randomize case">üé≤ Randomize</button>
      <button id="btnLock" class="ghost focus-ring" title="Alt+L ‚Äî Lock/unlock case">üîí Lock</button>
      <button id="btnNew" class="ghost focus-ring" title="Clear all inputs">üßº New</button>
      <button id="btnSave" class="ghost focus-ring" title="Save to this browser">üíæ Save</button>
      <button id="btnLoad" class="ghost focus-ring" title="Load last draft">üìÇ Load</button>
      <button id="btnExport" class="secondary focus-ring" title="Alt+E ‚Äî Export to Word (.docx)">‚¨áÔ∏è Export Word</button>
      <button id="btnCopyAll" class="ghost focus-ring" title="Copy entire note as plain text">üìã Copy Text</button>
      <button id="btnPrint" class="ghost focus-ring" title="Alt+P ‚Äî Print">üñ®Ô∏è Print</button>
    </div>
  </header>

  <div class="grid">
    <!-- LEFT: Case -->
    <section class="card">
      <h2>Case</h2>
      <div id="caseEmpty" class="muted">Click <b>Randomize</b> to draw a case. Then <b>Lock</b> to begin writing.</div>

      <div id="caseWrap" hidden>
        <div class="row" style="justify-content:space-between;align-items:flex-start">
          <div class="row" style="gap:8px">
            <div id="caseId" class="badge hidden"></div>
            <div id="caseTitleChip" class="pill hidden"></div>
          </div>
          <div id="lockStatus" class="status"></div>
        </div>

        <div class="hr"></div>

        <!-- INTAKE SHEET -->
        <div class="kvs scenario">
          <div class="muted">Title</div><div id="vTitle"></div>
          <div class="muted">Client profile</div><div id="vClient"></div>
          <div class="muted">Setting</div><div id="vSetting"></div>
          <div class="muted">Presenting problem</div><div id="vPresent"></div>
          <div class="muted">Relevant history</div><div id="vHistory"></div>
          <div class="muted">Goals & preferences</div><div id="vGoals"></div>
          <div class="muted">Strengths & resources</div><div id="vStrengths"></div>
          <div class="muted">Contextual barriers</div><div id="vContext"></div>
          <div class="muted">EBP decision point</div><div id="vDecision"></div>
          <div class="muted">Target outcomes</div><div id="vOutcomes"></div>
          <div class="muted">Risks & ethics</div><div id="vRisks"></div>
          <div class="muted">Equity signal</div><div id="vEquity"></div>
        </div>

        <div class="hr"></div>

        <!-- NARRATIVE -->
        <h3 style="margin:0 0 6px 0;font-size:16px">Narrative vignette</h3>
        <div id="vNarrative" class="scenario"></div>
      </div>
    </section>

    <!-- RIGHT: Builder -->
    <section class="card">
      <h2>EBP Note Builder</h2>
      <div id="lockGate" class="muted">Lock a case to enable editing.</div>
      <div id="builder" hidden>
        <div class="field">
          <label for="fContext">Client & Practice Context</label>
          <div class="hint">Describe the client and setting in depth. Name key contextual factors and equity issues.</div>
          <textarea id="fContext"></textarea>
          <div class="row"><span id="cntContext" class="status">0 words</span></div>
        </div>

        <div class="field">
          <label>PICO-style EBP Question</label>
          <div class="row" style="gap:6px;flex-wrap:wrap">
            <input id="picoP" placeholder="P: population/context"/>
            <input id="picoI" placeholder="I: intervention/approach"/>
            <input id="picoC" placeholder="C: comparison/alternative"/>
            <input id="picoO" placeholder="O: outcomes"/>
          </div>
          <div class="hint">Live preview:</div>
          <div id="picoPreview" class="status"></div>
        </div>

        <div class="field">
          <label for="fSearch">Search Strategy & Study Selection</label>
          <div class="hint">Databases, keywords, inclusion criteria. Aim for 3‚Äì5 peer-reviewed studies.</div>
          <textarea id="fSearch"></textarea>
          <div class="row"><span id="cntSearch" class="status">0 words</span><span class="muted">‚Ä¢</span><span id="studyCounter" class="status">Studies added: 0 / 3‚Äì5</span></div>
        </div>

        <div class="field">
          <label>Study Summaries (3‚Äì5)</label>
          <div class="hint">For each, briefly state what the study did and found in your own words.</div>
          <div id="studies"></div>
          <div class="row">
            <button id="btnAddStudy" class="ghost">‚ûï Add study</button>
            <button id="btnRemoveStudy" class="ghost">‚ûñ Remove last</button>
          </div>
        </div>

        <div class="field">
          <label for="fAppraise">Critical Appraisal</label>
          <div class="hint">Strengths, limitations, bias, representation, and equity considerations.</div>
          <textarea id="fAppraise"></textarea>
          <div class="row"><span id="cntAppraise" class="status">0 words</span></div>
        </div>

        <div class="field">
          <label for="fApply">Application & Delivery Plan</label>
          <div class="hint">What the evidence suggests for this client and how you would discuss options with them.</div>
          <textarea id="fApply"></textarea>
          <div class="row"><span id="cntApply" class="status">0 words</span></div>
        </div>

        <div class="field">
          <label for="fAssumptions">Assumptions I‚Äôm making (optional)</label>
          <div class="hint">Note any reasonable assumptions due to missing or ambiguous details.</div>
          <textarea id="fAssumptions"></textarea>
        </div>

        <div class="hr"></div>
        <div class="row" style="justify-content:space-between">
          <span class="pill">Progress</span>
          <span id="progress" class="status">0/5 core sections with 100+ words</span>
        </div>
      </div>
    </section>
  </div>

  <div class="footer">
    <span>Autosave:</span><span id="saveStatus">idle</span>
    <span class="muted">‚Ä¢</span><span id="tip">Alt+R = Randomize, Alt+L = Lock, Alt+E = Export Word (.docx).</span>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const err = (m, e) => {
    console.error(m, e||'');
    const b = document.getElementById('errBanner');
    if (!b) return;
    b.textContent = m;
    b.style.display = 'block';
    setTimeout(()=>{ b.style.display='none'; }, 6000);
  };

  const CONFIG = {
    siteTitle: "EBP Case Randomizer & Note Builder",
    exportFileName: "SOW5404_Spring_2026_EBP_Note.docx",
    courseHeader: "SOW5404 ‚Ä¢ Spring 2026"
  };
  const $ = (s)=>document.querySelector(s);
  const noDash = (s)=>(s||'').toString().replace(/[‚Äî‚Äì]/g,'-');
  const stripDashesDeep = (v)=>Array.isArray(v)?v.map(stripDashesDeep):v&&typeof v==='object'?Object.fromEntries(Object.entries(v).map(([k,val])=>[k,stripDashesDeep(val)])):typeof v==='string'?noDash(v):v;
  const escapeHtml = (s)=>(s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
  const wordCount = (s)=>(s||'').trim().split(/\s+/).filter(Boolean).length;
  const debounce=(fn,ms=800)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn.apply(null,a),ms);};};
  function paragraphsHTML(text){
    const safe=noDash(text||'').replace(/\r\n/g,'\n');
    const blocks=safe.split(/\n\s*\n/).map(t=>t.trim()).filter(Boolean);
    return blocks.map(b=>`<p>${escapeHtml(b)}</p>`).join('');
  }
  function toast(msg){
    clearTimeout(window.__toastTimer);
    if(!window.__toastEl){
      const d=document.createElement('div');
      d.style.position='fixed';d.style.bottom='16px';d.style.left='50%';d.style.transform='translateX(-50%)';
      d.style.background='#111827';d.style.color='#fff';d.style.padding='10px 14px';
      d.style.borderRadius='10px';d.style.boxShadow='0 6px 20px rgba(0,0,0,.15)';d.style.zIndex='9999';d.style.display='none';
      window.__toastEl=d; document.body.appendChild(d);
    }
    window.__toastEl.textContent=msg; window.__toastEl.style.display='block';
    window.__toastTimer=setTimeout(()=>window.__toastEl.style.display='none',1900);
  }

  // ===== FULL VIGNETTES (9) ‚Äî your originals embedded =====
  let CASES = stripDashesDeep([
    {
      title:"Marisol: Balancing School, Work, and Panic on Transit",
      client_profile:"17-year-old Mexican American high school junior; she/her; bilingual Spanish-English; first-gen college track; works evenings; recent family separation.",
      setting:"School social work office in a large urban public high school.",
      presenting_problem:"Panic episodes on crowded city bus leading to lateness and leaving first period. Embarrassment about being seen as dramatic. Wants practical skills she can use tomorrow.",
      relevant_history:"No child welfare/legal involvement. Father recently moved out, creating financial/emotional strain. Previously attended a mindfulness lunch club but stopped due to work.",
      goals_and_preferences:"Graduate on time, keep her job, and not panic on the bus. Prefers woman provider who understands Latinx family pressures. Open to concrete exposure if it feels doable.",
      strengths_and_resources:"Honor roll; dependable babysitter for cousins; supportive teacher offers a quiet room; journals and uses music to wind down.",
      contextual_factors_and_barriers:"Evening shifts; childcare responsibilities; crowded bus trigger; small, less private office; discipline norms around lateness.",
      ebp_decision_point:"Individual exposure-based work for transit panic versus school-based coping skills group with between-session practice.",
      target_outcomes:"Panic frequency/severity; on-time arrival; skill use between sessions.",
      risks_and_ethics:"No current self-harm/violence; privacy/visibility in school setting matters.",
      equity_signal:"Consider immigration-related family stress, bilingual preferences, and discipline responses to lateness.",
      narrative: `
Marisol is a 17-year-old Mexican American high school junior who shows up to the social worker‚Äôs office clutching her backpack straps so tightly her knuckles are pale. She uses she/her pronouns and describes herself as ‚Äúpretty normal, just tired.‚Äù She‚Äôs first-gen in her family to be on track for college. She‚Äôs bilingual in Spanish and English, but when she talks about school and her friends, she switches into English with ease, occasionally dropping in a Spanish phrase when she gets emotional.

Her English teacher referred her after noticing she‚Äôd started leaving first period several times a week, asking to go to the bathroom and then not coming back. One morning, the teacher found her in the hallway sitting on the floor, crying, breathing fast, and saying her chest hurt. The school nurse ruled out an immediate medical emergency and suggested she might be having panic attacks.

In the 20-minute drop-in appointment, Marisol explains that the worst episodes happen on the crowded city bus she takes to school. ‚ÄúIt‚Äôs like, as soon as we hit that one stop where everyone piles in, my chest gets tight. I feel dizzy. Then I freak out that I‚Äôm gonna pass out in front of everybody.‚Äù She‚Äôs mortified at the idea of people thinking she‚Äôs being dramatic or ‚Äúcrazy.‚Äù She has started skipping the bus stop when she sees it already crowded, which makes her late to school and first period.

At home, Marisol lives in a small apartment with her mom and two younger siblings. Her mother works irregular shifts in housekeeping, and Marisol works evenings at a grocery store to help with bills. She is proud of contributing, but it means she often doesn‚Äôt get home until 10 or 11 p.m., then still has homework and childcare duties. There‚Äôs no child welfare or legal involvement. Until recently, her father lived with them; after a series of loud arguments, he moved out suddenly, leaving the household financially and emotionally shaken. Marisol doesn‚Äôt go into detail, but her eyes well when she mentions ‚Äúthat week when everything blew up.‚Äù

She used to attend a mindfulness lunch club at school and liked the calm, but she had to stop when her work schedule changed. She still sometimes journals or listens to music late at night to wind down. She‚Äôs on the honor roll and a favorite babysitter for her cousins. A supportive teacher lets her sit in an empty classroom before school on really bad mornings.

Marisol wants to graduate on time, keep her job, and ‚Äúnot freak out on the bus.‚Äù She says she doesn‚Äôt have the bandwidth for long therapy right now and wants ‚Äústuff I can actually do, like, tomorrow.‚Äù She prefers working with a woman and feels more comfortable with someone who ‚Äúgets Latinx families‚Äù and the pressure she feels as the oldest. She‚Äôs unsure about breathing exercises, ‚ÄúI tried that from TikTok and felt weird‚Äù, but is open to practicing skills if they feel concrete and not childish.

The school social worker notes that there‚Äôs no current self-harm or violence, so a formal safety plan isn‚Äôt needed. Privacy is a concern; the office is small and not very soundproof, and Marisol is anxious about who might see her coming in. The social worker is considering whether to focus on individual exposure-based work around transit panic (e.g., imaginal and in-vivo practice for the bus) or to connect Marisol to a school-based coping skills group that includes between-session practice, knowing Marisol‚Äôs limited time, immigration-related family stress, bilingual preferences, and the way school discipline norms might respond to her lateness and class exits.
      `
    },
    {
      title:"Devon: Reentering After Juvenile Detention",
      client_profile:"19-year-old Black young man; he/him; on probation; lives with grandmother.",
      setting:"Community re-entry program orientation/intake.",
      presenting_problem:"Needs rapid employment to satisfy probation after a warehouse conflict/exit; long history of school suspensions for defiance.",
      relevant_history:"Juvenile detention months for fights/property damage; anger groups felt like lecturing; dropped out 11th grade; racialized policing experiences.",
      goals_and_preferences:"Hands-on coaching, on-the-job support; ambivalent about disclosure; goal: steady work and music equipment.",
      strengths_and_resources:"Punctual to appointments; supports grandmother; good with younger cousins; self-taught music producer.",
      contextual_factors_and_barriers:"Limited buses to job sites; police stops at night; background checks; stigma.",
      ebp_decision_point:"Supported employment with on-the-job coaching versus job-readiness group plus peer mentor.",
      target_outcomes:"Employment gain/retention; days worked; conflict self-efficacy.",
      risks_and_ethics:"No current safety risk; clarify confidentiality boundaries with probation/employers.",
      equity_signal:"Account for racialized policing and exclusionary discipline when applying evidence.",
      narrative: `
Devon is a 19-year-old Black young man who arrives at the community re-entry program in a hoodie and work boots, sitting in the back row of the orientation session. He uses he/him pronouns and answers questions in short, cautious sentences. He‚Äôs there because it‚Äôs a condition of his probation: complete the workforce program or risk a violation.

He lives with his grandmother on the east side and has since middle school. His father has been in and out of the picture, periodic calls, a couple of surprise visits, but no steady presence. Devon‚Äôs school record includes multiple suspensions for ‚Äúdefiance,‚Äù ‚Äútalking back,‚Äù and walking out of class when he felt disrespected. He eventually dropped out in 11th grade, saying he was ‚Äúdone being the problem.‚Äù

He spent several months in juvenile detention after a series of charges related to fights and property damage. While locked up, he attended anger management and life-skills groups, but he describes them as ‚Äúpeople talking at you about how you should act.‚Äù Probation counseling felt similar: ‚ÄúThey just want you to say what they want and then sign the paper.‚Äù

Despite that, Devon is almost always on time for appointments. He helps his grandmother with groceries and getting to church. He‚Äôs good with kids and sometimes coaches his younger cousins in basketball at the park. He talks animatedly about his love for music production, saving YouTube tutorials to his phone and tinkering with free apps to build beats.

He recently started a warehouse job through a temp agency. It lasted three weeks before a major conflict with a supervisor over break times and how he was addressed in front of others. Devon felt humiliated and targeted. When he raised his voice, security was called. He walked off the job before being formally fired. Now he needs another position quickly to satisfy probation and to move toward his goal of buying studio equipment.

Transportation is a challenge: buses to industrial job sites are limited and often late. Devon has been stopped by police multiple times while walking home at night, which has left him wary of being out after dark. Background checks and stigma related to his record are ongoing barriers.

In the intake meeting, he tells the re-entry program‚Äôs social worker, ‚ÄúLook, I‚Äôll show up. I‚Äôm not trying to go back. But I don‚Äôt want another classroom where people just lecture you.‚Äù He prefers hands-on coaching, someone who will ‚Äúcome see what it‚Äôs like at the job‚Äù and help him navigate conflict in real time. He‚Äôs ambivalent about disclosure to employers: ‚ÄúIf I tell them my whole business, I‚Äôm screwed. If I don‚Äôt, they find out later and I‚Äôm still screwed.‚Äù

Devon has no current safety risk and denies suicidal thoughts or intent. The social worker is careful to explain what information can and cannot be shared with probation and employers. Given his history of racialized policing, school discipline, and system involvement, they‚Äôre weighing whether to recommend a supported employment model with job development and on-the-job coaching, or to place him in a more traditional job-readiness group plus matching him with a peer mentor who has successfully re-entered after a record. The key outcomes they‚Äôre thinking about include employment gain and retention, number of days worked, and Devon‚Äôs self-efficacy in handling workplace conflict without escalation.
      `
    },
    {
      title:"Asha: Managing Pain in Primary Care With Caregiving Duties",
      client_profile:"46-year-old Bangladeshi American woman; she/her; bilingual; caregiver for father; prediabetes and rising BP.",
      setting:"Integrated primary care visit at an FQHC.",
      presenting_problem:"Chronic low back pain disrupting sleep/work; limited time; skeptical of generic classes.",
      relevant_history:"Tried brief CBT for pain; stopped due to demands; concerns about meds/side effects.",
      goals_and_preferences:"Get through shifts without crying and sleep >3 hours; short practical strategies at home; open to women-only, modesty-respectful options.",
      strengths_and_resources:"Strong family ties; prayer routines; neighbor helps with rides; disciplined when routine exists.",
      contextual_factors_and_barriers:"Rotating shifts; caregiving; transportation; authorizations; modesty/touch concerns.",
      ebp_decision_point:"Brief individual behavioral pain management versus culturally tailored pacing/movement group.",
      target_outcomes:"Pain interference; sleep hours; functional activity.",
      risks_and_ethics:"No acute safety risk; language access and cultural fit matter.",
      equity_signal:"Representation of South Asian women is limited in pain literature; consider language/modesty.",
      narrative: `
Asha is a 46-year-old Bangladeshi American woman who sits upright in the exam room chair, hands folded neatly in her lap. She uses she/her pronouns. Her primary language at home is Bengali, but she‚Äôs comfortable using English in the clinic and switches between the two with ease. She‚Äôs dressed modestly, in a long tunic and headscarf, and apologizes for ‚Äútaking too much of the doctor‚Äôs time‚Äù even as she describes how bad things have gotten.

She has chronic low-back pain that flares severely after long shifts at the grocery store where she works on her feet. Recently, the pain has started waking her up at night. She gets only a few hours of broken sleep before the next day‚Äôs responsibilities begin. Her chart also notes prediabetes, and the medical assistant has flagged rising blood pressure readings.

At home, Asha is a central pillar in an extended household. She is married, with two school-age children, and is also the primary caregiver for her aging father, who lives with them and has increasing mobility and health needs. Her husband‚Äôs hours at work were cut last year, so Asha picked up more shifts to cover the gap. Money is tight and she sometimes skips her own appointments to avoid co-pays.

A year ago, she briefly tried a course of cognitive-behavioral therapy for pain through the clinic. She found parts of it helpful, especially pacing activities and scheduling small pleasant events, but stopped attending after three visits when childcare and caregiving demands made it difficult to leave the house. She has been prescribed pain medication in the past but worries about side effects and ‚Äúgetting addicted.‚Äù She is skeptical of generic ‚Äúpain classes‚Äù and says, ‚ÄúI can‚Äôt sit in a room for eight weeks listening to someone talk.‚Äù She wonders aloud if people in those groups would understand her culture or responsibilities.

Her goals are straightforward: she wants to be able to get through her shifts without crying in the stockroom and to sleep more than three hours at a time. She‚Äôs interested in practical strategies she can use at home, in short bursts, between tasks. She‚Äôs open to a women-only, time-limited group if it feels relevant, but she is cautious about any intervention that might feel immodest or require mixed-gender physical demonstrations.

Asha talks fondly about her children, her father, and the routines of prayer at the mosque that anchor her week. A neighbor sometimes helps with rides or watching the kids. She sees herself as disciplined and responsible, ‚ÄúI do what I‚Äôm supposed to do‚Äù, which makes her feel like she‚Äôs failing when pain forces her to stop.

Barriers pile up quickly: rotating work shifts, caregiving demands, transportation challenges, and insurance prior authorization hurdles make it hard to attend regular appointments. Physical therapy has been suggested, but she worries about modesty and being touched, and scheduling has been a recurring problem.

In the integrated primary care visit, the behavioral health provider is considering whether to offer brief individual behavioral pain management sessions tailored to her schedule or to recommend a culturally tailored pacing/movement group that could incorporate modesty considerations and faith-infused coping. Outcomes of interest include pain interference with daily activities, hours of sleep, and functional activity levels. There is no acute safety risk. The provider also wonders whether to invite her husband to one session to support home-based changes, while being mindful of confidentiality, gendered norms, language access, and how South Asian women caregivers are often underrepresented in the pain literature guiding their options.
      `
    },
    {
      title:"Tanya: Preparing for Youth Reunification After Residential Placement",
      client_profile:"38-year-old Black mother; she/her; stable apartment; works at nursing home; hypertension history.",
      setting:"Community center reunification meetings; county child welfare involved.",
      presenting_problem:"Daughter (15) returning from residential; fear of reverting to conflict cycles.",
      relevant_history:"Housing instability; hotline calls; no current substantiated abuse; mixed extended family input.",
      goals_and_preferences:"Calmer routines; confidence; support that fits shifts and transit.",
      strengths_and_resources:"Keeps appointments; supportive aunt/church; steady job.",
      contextual_factors_and_barriers:"Shift work; long school commute; racialized surveillance and neighbor scrutiny.",
      ebp_decision_point:"Manualized office parent-teen model versus home-based in-the-moment coaching.",
      target_outcomes:"Conflict frequency/intensity; school attendance/runaway; parenting confidence.",
      risks_and_ethics:"No active violence; safety planning boundaries reviewed.",
      equity_signal:"Hold racialized surveillance explicitly in evaluation and messaging.",
      narrative: `
Tanya is a 38-year-old Black mother who meets with the reunification social worker at a community center after her shift at the nursing home. She looks tired but composed, in scrubs and sneakers, her hair pulled back. She has a history of hypertension that she jokes is ‚Äúfrom all this stress,‚Äù but her humor doesn‚Äôt quite reach her eyes.

Her 15-year-old daughter, Kiara, has been in a residential youth program for the past eight months after a series of runaway episodes, school suspensions, and escalating conflicts at home. The county child welfare system became involved during a period of housing instability, when Tanya and her daughter were living between relatives‚Äô homes and motel rooms. Multiple hotline calls about truancy, loud arguments, and suspected neglect triggered investigations. There is no current substantiated abuse case, but child welfare remains involved around safety planning and reunification.

Tanya now has a stable two-bedroom apartment across town from Kiara‚Äôs school. She has held the same full-time job for over a year, despite juggling shift changes and transportation issues. She keeps every appointment with the social worker, even if it means staying up late to cook or do laundry afterward. She speaks warmly about Kiara‚Äôs aunt, who has been a consistent support, and about their church community, which has helped with food and bills at times.

As reunification approaches, Tanya feels both hopeful and terrified. ‚ÄúI want her home,‚Äù she says, ‚Äúbut I don‚Äôt want us to go right back to screaming at each other.‚Äù She worries about how to handle curfews, phone and social media use, and Kiara‚Äôs long bus ride back and forth to school. She‚Äôs unsure how to respond when Kiara shuts down or storms out of the room. She doesn‚Äôt want to call the police again; previous encounters left her feeling judged and her daughter labeled as a problem.

The extended family is a mixed bag. Some relatives have been supportive; others have been critical, framing Tanya as ‚Äúnot strict enough‚Äù or, conversely, ‚Äútoo hard.‚Äù She feels under a microscope from systems and kin alike. ‚ÄúIt‚Äôs like everybody‚Äôs watching, waiting for me to slip,‚Äù she says.

At the community center, the county reunification team offers multiple supports. The social worker is weighing whether to recommend a structured, manualized parent-teen session model that focuses on communication and problem-solving in the office, or a home-based coaching approach where a worker visits during typical conflict times to coach Tanya and Kiara in-the-moment. Both options require regular attendance and coordination with Tanya‚Äôs work schedule and the bus routes.

There is no current active violence in the home, but previous police involvement and safety concerns mean that safety planning and clear mandated reporting boundaries must be revisited. Outcomes of interest include the frequency and intensity of family conflict, Kiara‚Äôs school attendance and run-away incidents, and Tanya‚Äôs sense of confidence in her parenting. Underneath it all is the reality of racialized surveillance of Black families: Tanya knows that one loud argument neighbors overhear might be interpreted very differently than in a white family next door, and the social worker is trying to hold that reality explicitly as they plan supports.
      `
    },
    {
      title:"Maya: Short-Stay DV Shelter Resident Planning Next Steps",
      client_profile:"29-year-old Latina; she/they with friends, she/her on forms; Spanish-dominant; bisexual; migraines.",
      setting:"Urban domestic violence shelter; 30-day limit.",
      presenting_problem:"Coercive partner with digital control; anxiety, poor sleep, fear of being found.",
      relevant_history:"First shelter stay; partner sabotaged work; wary of courts/police.",
      goals_and_preferences:"Realistic safety plan; stable housing; digital safety; prefers women providers; minimize retelling.",
      strengths_and_resources:"Planned exit; grabbed documents; supportive cousin; motivated learner.",
      contextual_factors_and_barriers:"Short stay; variable language access; tech-facilitated abuse; immigration-related housing barriers.",
      ebp_decision_point:"Brief 1:1 trauma-informed + digital safety coaching versus empowerment peer group plus brief check-ins.",
      target_outcomes:"Safety plan enactment; anxiety symptoms; housing steps completed.",
      risks_and_ethics:"Tech confidentiality; protective orders without pressure; immigration intersection.",
      equity_signal:"Language access and tech abuse shape evidence fit and options.",
      narrative: `
Maya is a 29-year-old Latina who has recently begun using she/they pronouns with friends but still lists she/her on official forms. She identifies as bisexual. Spanish is her dominant language, though she understands conversational English; she requests a Spanish-speaking advocate when possible. She has a history of migraines that intensify under stress.

She arrived at the urban domestic violence shelter late one night with a small duffel bag and a phone with a cracked screen, having left a coercive partner after a particularly frightening confrontation. There were no visible injuries that night, but she describes a pattern of escalating control over her finances, social contacts, and digital life, demands to share passwords, constant location checks, threats to post private photos if she ever tried to leave.

This is her first time in shelter. She had previously stayed with a cousin for a weekend after a fight, but always returned home, partly because of financial dependence and partly out of fear of making things ‚Äúworse.‚Äù She has worked intermittently in service jobs, cleaning, restaurant shifts, but her partner often sabotaged her work schedule by showing up, picking fights, or accusing her of flirting.

In shelter, Maya‚Äôs anxiety spikes at night. She describes lying awake listening for footsteps in the hallway, heart pounding, every door slam making her flinch. She worries that her partner might find the shelter or track her phone somehow. She has trouble sleeping and often wakes with headaches. She is nervous about using her devices and asks whether it‚Äôs safe to log into her email or social media. She is wary of anything that might involve court; previous brief contact with police left her feeling dismissed and blamed.

Her priorities are clear: she wants a realistic safety plan, more stable housing, and to regain control over her devices and accounts. She wants to understand how to protect herself digitally without feeling like she has to disappear completely. She prefers working with women providers and would rather not have to tell her story repeatedly to different staff. She is open to learning but overwhelmed by the 30-day time limit for shelter stays.

Maya has strengths that show up even through her exhaustion. She managed to identify the shelter, coordinate childcare with a cousin for a younger relative she sometimes helps with, grab essential documents, and leave quickly when a window of safety opened. Her cousin remains a supportive contact by phone. She is motivated to learn safety strategies and asks thoughtful questions about how abusers can misuse technology.

The shelter context is both a resource and a barrier: there is case management and legal advocacy on-site, but the short stay means decisions have to be made quickly. Housing discrimination, especially related to her immigration status, looms large. Digital harassment and tech-facilitated abuse remain active risks. Language access is variable across partner agencies.

The social worker is considering whether to focus their limited time on brief, trauma-informed work that integrates digital safety coaching one-on-one, or to connect Maya with an empowerment-focused peer group where survivors share strategies and support each other, supplemented by brief individual check-ins. Key outcomes include whether she can enact a safety plan, her anxiety symptoms, and concrete housing steps completed. Ethical considerations include ensuring her address and tech footprints remain confidential, exploring protective order options without pressure, and centering the intersection of immigration status, language access, and tech-facilitated abuse in any intervention choice.
      `
    },
    {
      title:"Jamal: Re-Engaging in HIV Primary Care",
      client_profile:"33-year-old Black gay man; he/him; previously excellent ART adherence; mild depression screen.",
      setting:"FQHC primary care with embedded behavioral health.",
      presenting_problem:"Stopped ART and missed visits after move/breakup; wants to restart; concerns about stigma and side effects.",
      relevant_history:"Stigma in urgent care and family comments; lost peer group after move.",
      goals_and_preferences:"Discreet, affirming care; simple regimen for shift work; careful with SMS privacy.",
      strengths_and_resources:"Stable apartment; tech savvy; one close friend/support.",
      contextual_factors_and_barriers:"Distance; schedule inflexibility; insurance changes; cost worries.",
      ebp_decision_point:"Brief adherence counseling + tailored SMS versus peer navigation to early visits/community reconnection.",
      target_outcomes:"Adherence; viral suppression; appointment attendance.",
      risks_and_ethics:"Strict confidentiality for messaging/chart; coordination across teams.",
      equity_signal:"Intersectional stigma and representation influence engagement.",
      narrative: `
Jamal is a 33-year-old Black gay man who walks into the Federally Qualified Health Center (FQHC) waiting room wearing a baseball cap and headphones, scrolling through his phone. He uses he/him pronouns. He tests in as mildly depressed on a PHQ-9 completed on a tablet in the lobby. His chart shows an HIV diagnosis five years ago and a history of excellent adherence to antiretroviral therapy (ART) until about four months ago.

At his last visit before dropping off, his viral load was undetectable. Since moving across town and going through a breakup with a long-term partner, he has missed several appointments and stopped picking up refills. He tells the nurse, half-joking, ‚ÄúI ghosted my pills like I ghost people on dating apps.‚Äù Underneath the joke is worry: he knows what‚Äôs at stake.

He explains to the embedded behavioral health provider that the move disrupted his routine. The bus route to the clinic is longer now, his work schedule at the call center changed, and he lost the peer support group that met on his old side of town. The breakup left him feeling ashamed and unmotivated; he avoided former friends who also receive care at the clinic because he didn‚Äôt want to answer questions.

Jamal is clear that he wants to restart ART. ‚ÄúI‚Äôve done it before; I know it works,‚Äù he says. But he has lingering concerns about side effects, long-term impacts, and being judged for the lapse. He also recounts several experiences of stigma: a nurse at an urgent care who treated him coldly after seeing his HIV status, a family member who made a comment about ‚Äúlifestyle choices,‚Äù an employer rumor mill that once led him to worry his status had been disclosed.

His goals for care are specific. He wants a discreet, affirming environment where he doesn‚Äôt feel like ‚Äúthe HIV guy‚Äù when he walks in. He wants a simple regimen that fits his shift-work schedule. He‚Äôs tech savvy and open to digital support but is cautious about SMS reminders if they might show up on his lock screen and be seen by others. He has a stable apartment now and one close friend who knows his status and checks on him regularly.

Barriers include the distance to the clinic, inflexible shifts that make scheduling hard, and pending changes to his insurance that make him nervous about cost. He notes that he‚Äôs lost weight and has less energy, but denies acute safety concerns or suicidal thinking.

The care team is considering two main support options as he restarts ART: brief adherence counseling with tailored SMS support (e.g., appointment and pill reminders, with consent and privacy settings carefully discussed) or a peer navigation model where a trained peer accompanies him to early appointments, helps problem-solve barriers, and reconnects him with community. Outcomes of interest include medication adherence, return to viral suppression, and consistent appointment attendance.

The team is acutely aware of the intersectional stigma Jamal faces as a Black gay man living with HIV, and of how representation in research and in the clinic staff itself may affect his engagement. Ethical considerations include confidentiality around messaging, chart notes, and coordination between primary care, behavioral health, and case management.
      `
    },
    {
      title:"Cole: Rural Teen Navigating Cannabis and Alcohol Use",
      client_profile:"16-year-old white teen; he/him; athlete; sleep problems after heavy use nights.",
      setting:"School-based health center in rural district.",
      presenting_problem:"Suspended for arriving hungover; near-daily cannabis; weekend alcohol.",
      relevant_history:"Strained relationship with father; farm chores; permissive local norms.",
      goals_and_preferences:"Keep team eligibility; reduce home conflict; prefers brief private check-ins, not groups.",
      strengths_and_resources:"Reliable teammate; helpful in class when rested; plays guitar.",
      contextual_factors_and_barriers:"No transit; few adolescent programs; small-town confidentiality concerns.",
      ebp_decision_point:"Brief MI with feedback at school versus parent-involved behavioral contract with check-ins/rewards.",
      target_outcomes:"Days of use; attendance/tardiness; readiness to change.",
      risks_and_ethics:"Discuss safe transportation when using; minor confidentiality laws.",
      equity_signal:"Rural norms/access shape feasibility and measures.",
      narrative: `
Cole is a 16-year-old white teenager who shows up at the school-based health center in a faded team jersey and muddy boots. He uses he/him pronouns and shrugs a lot when adults ask questions. He doesn‚Äôt have any formal diagnoses, but he‚Äôs been reporting trouble falling asleep and staying asleep, especially on nights after heavy substance use.

The school social worker first met Cole after he was suspended for showing up hungover to first period and falling asleep in class. His mother, exasperated but worried, agreed to a referral. Cole admits that he drinks on most weekends, ‚Äúnot every day, I‚Äôm not like that‚Äù, and smokes cannabis nearly every day, often in the evenings with friends ‚Äúto chill out‚Äù after chores and homework.

Cole lives on a small property with his mom and stepdad. His biological father lives two hours away and their relationship is strained; visits are inconsistent and often tense. At home, Cole has responsibilities: feeding animals, helping with repairs, doing farm chores before and after school. He sometimes complains that his stepdad is ‚Äúon him all the time,‚Äù but he also acknowledges that they get work done together.

There are few structured activities in town for teens. The local culture is permissive about alcohol and, increasingly, about cannabis. Cole plays on a sports team and doesn‚Äôt want to lose his spot; he is proud of being a reliable player. Several trusted teachers say he‚Äôs helpful in class when he‚Äôs rested. He plays guitar and sometimes escapes to the barn to practice.

Cole says he doesn‚Äôt want ‚Äúa big deal‚Äù made out of his substance use. He worries more about school consequences than health impacts. He is wary of groups, ‚ÄúI‚Äôm not talking about my business in a circle‚Äù, and prefers brief, private check-ins. He says, ‚ÄúIf you can help me not get kicked off the team and not have my mom freak out all the time, that would be nice.‚Äù

Transportation is a barrier; there‚Äôs no reliable public transit, and getting to any off-site treatment would require rides from caregivers with limited time and gas money. Confidentiality is tricky in a small town; gossip travels fast, and Cole fears being labeled. There are no adolescent-specific programs nearby.

The school health center is considering two approaches. One is brief motivational interviewing (MI) with personalized feedback, delivered in a series of short, private sessions at school that focus on his own goals, ambivalence, and patterns of use. The other is a parent-involved behavioral contract that includes regular check-ins, agreed-upon limits, and rewards, which would require bringing his caregivers into the process.

Outcomes to track might include days of alcohol and cannabis use, school attendance and tardiness, and Cole‚Äôs readiness to change his behavior. There is no current active safety risk, but providers must navigate confidentiality laws around minors, discuss safe transportation when using substances, and be mindful of the norms and access issues that come with rural life.
      `
    },
    {
      title:"Rosa: Parenting Stress in Family Shelter",
      client_profile:"31-year-old Puerto Rican mother; she/her; bilingual; asthma; son Mateo age six.",
      setting:"Family shelter with curfew/quiet hours; small shared room.",
      presenting_problem:"Escalating bedtime conflicts; noise complaints; fear of write-ups.",
      relevant_history:"Retail job loss; eviction; couch-surfing; prior parent class felt shaming.",
      goals_and_preferences:"Calmer routines; fewer incident reports; practical coaching.",
      strengths_and_resources:"Warm bond with Mateo; nightly reading; cousin checks in; highly motivated.",
      contextual_factors_and_barriers:"Tight space; evening demands; transportation/childcare barriers.",
      ebp_decision_point:"In-room coaching for routines versus structured parenting group with childcare.",
      target_outcomes:"Bedtime conflict frequency; incident reports; parenting stress; confidence.",
      risks_and_ethics:"No active safety risk; avoid pathologizing stress in homelessness.",
      equity_signal:"Language access and institutional rules shape options/outcomes.",
      narrative: `
Rosa is a 31-year-old Puerto Rican mother who recently moved into a family shelter with her six-year-old son, Mateo. She uses she/her pronouns and is bilingual in Spanish and English; she tends to speak English in mixed settings but slips into Spanish when comforting her son. She has asthma that flares in cold weather and when she‚Äôs around strong cleaning chemicals.

The shelter room is small: two twin beds, a dresser, and a few bags stacked in the corner. Rosa and Mateo share the space, while other families live in adjacent rooms. Quiet hours and curfew are strictly enforced. Rosa worries constantly about noise complaints and ‚Äúwrite-ups.‚Äù The shelter has an on-site case manager and offers evening groups for parents, but the environment is far from relaxing.

Rosa‚Äôs path here involved months of couch-surfing and motels after she lost her job in retail. A series of late notices, then an eviction, left her scrambling to keep Mateo housed. There is no open CPS case, but she is acutely aware that any incident at the shelter could change that. She once attended a parent education class at a previous community center, but left feeling judged and shamed. ‚ÄúThey made it sound like everything bad is the mom‚Äôs fault,‚Äù she recalls.

Lately, bedtime has become a battleground. Mateo resists getting ready for bed, runs around the shared room, and protests loudly when it‚Äôs time to turn off screens. Rosa, exhausted and on edge, finds herself raising her voice. Mateo sometimes throws things or slams the bathroom door. When other residents bang on the wall or staff knock with reminders about noise, Rosa feels a mix of humiliation and panic. She fears being labeled a ‚Äúproblem family‚Äù and worries constantly about being asked to leave.

Despite all this, Rosa maintains a warm relationship with Mateo. They read together most nights when things go well, and he often curls up next to her asking for ‚Äúone more story.‚Äù She has a cousin in town who checks in, but transportation and childcare make it hard to visit. Rosa is highly motivated to create calmer routines and to avoid shelter incident reports, but her energy is depleted by the constant demands of shelter life.

The shelter offers options: the case manager can provide brief in-room parent coaching focused on creating simple bedtime routines, visual schedules, and de-escalation strategies tailored to the small space. There is also a structured parenting group with childcare downstairs that meets twice a week; previous participants report feeling supported, but it requires leaving the room at a time when Rosa is trying to juggle dinner, showers, and homework.

Key outcomes might include the frequency of bedtime conflicts and staff incident reports, Rosa‚Äôs self-reported parenting stress, and her sense of confidence in managing Mateo‚Äôs behavior. There is no active safety risk, but the social worker is attuned to how quickly normal stress responses can be pathologized in families experiencing homelessness, and to the role of language access and institutional rules in shaping Rosa‚Äôs options.
      `
    },
    {
      title:"Selam: Diabetes Distress and Shift Work",
      client_profile:"41-year-old Ethiopian immigrant; she/her; Amharic primary; type 2 diabetes (non-insulin).",
      setting:"FQHC; interpreter common; rotating shifts complicate care.",
      presenting_problem:"Tired and overwhelmed; missed classes/follow-ups; worries about insulin.",
      relevant_history:"Disciplined when routine predictable; remittances; faith/fasting important.",
      goals_and_preferences:"Steadier energy for work and worship; brief practical support; cautious about interpreter-mediated groups.",
      strengths_and_resources:"Faith community; helpful roommate; success when routine stable.",
      contextual_factors_and_barriers:"Interpreter scheduling; formulary limits; shared kitchen; shift changes.",
      ebp_decision_point:"Brief individual counseling + tailored texts versus culturally tailored group for East African women focused on shift problem-solving.",
      target_outcomes:"Diabetes distress; self-management behaviors; HbA1c.",
      risks_and_ethics:"Consent/privacy with interpreters; representation gaps.",
      equity_signal:"Limited representation of East African women in diabetes research affects fit.",
      narrative: `
Selam is a 41-year-old Ethiopian immigrant who receives care at an FQHC. She uses she/her pronouns. Her primary language is Amharic, and she often works with an interpreter in medical visits, though she understands some English. She was diagnosed with type 2 diabetes several years ago and is currently managing without insulin. Lately, she reports feeling constantly tired and overwhelmed.

She works rotating shifts at a local manufacturing plant, sometimes overnight, sometimes early mornings. The schedule changes weekly, making it difficult to maintain consistent meals or appointment times. She rents a room in a shared apartment with other immigrants; fridge space is limited, and cooking at odd hours can cause tension with roommates.

In the exam room, with the interpreter helping, Selam explains that she knows she is supposed to track her blood sugar, plan meals carefully, and exercise, but ‚Äúmy brain feels too full.‚Äù She has missed several diabetes education classes and follow-up appointments because of work conflicts. When she does come, she is apologetic and insists she is trying. She sends money home regularly as remittances and feels intense responsibility toward family overseas.

Her faith is important to her; she attends religious services when her schedule allows and follows fasting practices when she can. She says that when she has a predictable routine, she can be very disciplined about her health behaviors, but shift changes keep disrupting any system she tries to create. She is afraid of being put on insulin, associating it with ‚Äúbad diabetes,‚Äù but she also knows her numbers have been creeping up.

Her goals are to have more steady energy so she can work reliably and participate fully in prayer and community. She wants brief, practical support that respects her time and doesn‚Äôt require long, frequent classes. She expresses some discomfort about interpreter-mediated groups where she might be the only woman of her background, and wonders aloud whether anyone really understands what it‚Äôs like to work rotating shifts and send money home.

Strengths include her strong faith, her history of disciplined routines when feasible, and support from a roommate who sometimes reminds her about appointments and medications. Barriers include interpreter scheduling, formulary restrictions that limit which medications are covered, and the logistics of managing food and storage in a shared space.

The clinic is considering two main approaches: brief, individual counseling focused on diabetes distress and problem-solving, paired with tailored text reminders about appointments and self-management tasks, or a culturally tailored group for East African women that includes working on shift-related problem-solving, if enough participants can be recruited. Outcomes of interest include measures of diabetes distress, self-management behaviors (such as medication-taking and blood sugar checks), and HbA1c levels over time.

There is no acute safety risk, but consent around interpreter involvement and privacy is discussed carefully. The provider is mindful of language access, the constraints of shift work, and the limited representation of East African women in the research that underpins standard diabetes interventions, factors that will shape which evidence-based approach feels most appropriate and feasible for Selam.
      `
    }
  ]);

  if (!Array.isArray(CASES) || CASES.length === 0) {
    err('No cases loaded. Please verify the CASES array.');
  }

  // ------- State & refs -------
  let current=null, locked=false, studyCount=0;
  const F = { context:$('#fContext'), search:$('#fSearch'), appraise:$('#fAppraise'), apply:$('#fApply'), assumptions:$('#fAssumptions') };
  const PICO = { P:$('#picoP'), I:$('#picoI'), C:$('#picoC'), O:$('#picoO') };
  const CELS = {
    wrap:$('#caseWrap'), empty:$('#caseEmpty'),
    id:$('#caseId'), chip:$('#caseTitleChip'), lock:$('#lockStatus'),
    vTitle:$('#vTitle'), vClient:$('#vClient'), vSetting:$('#vSetting'), vPresent:$('#vPresent'),
    vHistory:$('#vHistory'), vGoals:$('#vGoals'), vStrengths:$('#vStrengths'), vContext:$('#vContext'),
    vDecision:$('#vDecision'), vOutcomes:$('#vOutcomes'), vRisks:$('#vRisks'), vEquity:$('#vEquity'),
    vNarrative:$('#vNarrative'),
    lockGate:$('#lockGate'), builder:$('#builder'),
    cntContext:$('#cntContext'), cntSearch:$('#cntSearch'), cntAppraise:$('#cntAppraise'), cntApply:$('#cntApply'],
    progress:$('#progress'), studyCounter:$('#studyCounter'),
    saveStatus:$('#saveStatus'), picoPreview:$('#picoPreview')
  };
  const BTN = {
    random:$('#btnRandom'), lock:$('#btnLock'), fresh:$('#btnNew'),
    save:$('#btnSave'), load:$('#btnLoad'), export:$('#btnExport'),
    copy:$('#btnCopyAll'), print:$('#btnPrint'),
    addStudy:$('#btnAddStudy'), removeStudy:$('#btnRemoveStudy')
  };
  for (const [k,v] of Object.entries(BTN)) { if (!v) return err(`Missing button: ${k}`); }

  // ------- UI helpers -------
  function updateLockUi(){
    CELS.lock.textContent = locked ? 'Locked for writing' : 'Unlocked';
    BTN.lock.textContent = locked ? 'üîì Unlock' : 'üîí Lock';
    CELS.lockGate.hidden = locked;
    CELS.builder.hidden = !locked;
  }
  function renderCase(){
    if(!current){ CELS.wrap.hidden=true; CELS.empty.hidden=false; return; }
    CELS.empty.hidden=true; CELS.wrap.hidden=false;
    CELS.id.textContent=current.id||''; CELS.chip.textContent=noDash(current.title);
    CELS.vTitle.textContent=noDash(current.title);
    CELS.vClient.textContent=noDash(current.client_profile);
    CELS.vSetting.textContent=noDash(current.setting);
    CELS.vPresent.innerHTML=paragraphsHTML(current.presenting_problem);
    CELS.vHistory.innerHTML=paragraphsHTML(current.relevant_history);
    CELS.vGoals.innerHTML=paragraphsHTML(current.goals_and_preferences);
    CELS.vStrengths.innerHTML=paragraphsHTML(current.strengths_and_resources);
    CELS.vContext.innerHTML=paragraphsHTML(current.contextual_factors_and_barriers);
    CELS.vDecision.textContent=noDash(current.ebp_decision_point);
    CELS.vOutcomes.textContent=noDash(current.target_outcomes);
    CELS.vRisks.textContent=noDash(current.risks_and_ethics);
    CELS.vEquity.textContent=noDash(current.equity_signal);
    CELS.vNarrative.innerHTML=paragraphsHTML(current.narrative);
    updateLockUi();
  }

  // ------- Actions -------
  function randomize(){
    if (!Array.isArray(CASES) || CASES.length === 0) { err('No cases to randomize.'); return; }
    BTN.random.disabled=true; BTN.random.innerHTML='<span class="spin">üé≤</span> Rolling...';
    setTimeout(()=>{
      try{
        const idx=Math.floor(Math.random()*CASES.length);
        current = CASES[idx];
        locked=false; clearForm(); renderCase(); toast('New case drawn. Review and lock to start.');
      }catch(e){ err('Randomize failed.', e); }
      finally{ BTN.random.disabled=false; BTN.random.textContent='üé≤ Randomize'; }
    },450);
  }
  function toggleLock(){ if(!current){ toast('Draw a case first.'); return; } locked=!locked; updateLockUi(); if(locked){ loadDraft(); } }
  function clearForm(){
    ['fContext','fSearch','fAppraise','fApply','fAssumptions'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
    PICO.P.value=''; PICO.I.value=''; PICO.C.value=''; PICO.O.value='';
    const box = document.getElementById('studies'); if (box) box.innerHTML='';
    studyCount=0; addStudy();
    updateAllCounts(); updatePicoPreview();
  }

  // ------- Counts / progress -------
  function updateAllCounts(){
    CELS.cntContext.textContent = `${wordCount(F.context.value)} words`;
    CELS.cntSearch.textContent  = `${wordCount(F.search.value)} words`;
    CELS.cntAppraise.textContent= `${wordCount(F.appraise.value)} words`;
    CELS.cntApply.textContent   = `${wordCount(F.apply.value)} words`;
    const hits=[F.context,F.search,F.appraise,F.apply].filter(x=>wordCount(x.value)>=100).length;
    CELS.progress.textContent = `${hits}/5 core sections with 100+ words`;
  }

  // ------- PICO -------
  function updatePicoPreview(){
    const text = `Among ${PICO.P.value||'...'}, does ${PICO.I.value||'...'} compared to ${PICO.C.value||'...'} improve ${PICO.O.value||'...'}?`;
    CELS.picoPreview.textContent = (PICO.P.value||PICO.I.value||PICO.C.value||PICO.O.value) ? text : '';
  }

  // ------- Studies -------
  function addStudy(){
    studyCount++;
    const wrap=document.createElement('div');
    wrap.className='field';
    const ta=document.createElement('textarea');
    ta.placeholder=`Study ${studyCount}: What it did and what it found (your words).`;
    ta.addEventListener('input', ()=>{ updateAllCounts(); autosave(); updateStudyCounter(); });
    wrap.appendChild(ta);
    $('#studies').appendChild(wrap);
    updateStudyCounter();
  }
  function removeStudy(){
    const box=$('#studies'); if(!box || !box.lastElementChild) return;
    box.removeChild(box.lastElementChild); studyCount=Math.max(0,studyCount-1);
    updateStudyCounter(); autosave();
  }
  function updateStudyCounter(){ CELS.studyCounter.textContent = `Studies added: ${studyCount} / 3‚Äì5`; }

  // ------- Autosave -------
  const autosave = debounce(()=>{
    if(!current || !locked) return;
    const studyTexts=[...document.querySelectorAll('#studies textarea')].map(t=>t.value);
    const data={
      caseTitle: current.title,
      fields:{
        context:F.context.value, search:F.search.value, appraise:F.appraise.value, apply:F.apply.value,
        assumptions:F.assumptions.value,
        pico:{P:PICO.P.value,I:PICO.I.value,C:PICO.C.value,O:PICO.O.value},
        studies: studyTexts
      },
      ts:new Date().toISOString()
    };
    try{ localStorage.setItem(saveKey(), JSON.stringify(data)); CELS.saveStatus.textContent=`saved ${new Date().toLocaleTimeString()}`; }
    catch{ CELS.saveStatus.textContent='save failed'; }
  },1200);
  function saveKey(){ return current ? `EBP_NOTE_${noDash(current.title).slice(0,50)}` : 'EBP_NOTE_UNSET'; }
  function loadDraft(){
    const raw=localStorage.getItem(saveKey()); if(!raw){ CELS.saveStatus.textContent='no draft'; return; }
    try{
      const d=JSON.parse(raw);
      F.context.value=d.fields?.context||'';
      F.search.value=d.fields?.search||'';
      F.appraise.value=d.fields?.appraise||'';
      F.apply.value=d.fields?.apply||'';
      F.assumptions.value=d.fields?.assumptions||'';
      PICO.P.value=d.fields?.pico?.P||''; PICO.I.value=d.fields?.pico?.I||''; PICO.C.value=d.fields?.pico?.C||''; PICO.O.value=d.fields?.pico?.O||'';
      const box=$('#studies'); box.innerHTML=''; studyCount=0;
      (d.fields?.studies?.length?d.fields.studies:['']).forEach(()=>addStudy());
      [...document.querySelectorAll('#studies textarea')].forEach((ta,i)=>{ ta.value = d.fields?.studies?.[i] || ''; });
      updatePicoPreview(); updateAllCounts();
      CELS.saveStatus.textContent=`loaded draft (${new Date(d.ts).toLocaleString()})`;
    }catch(e){ CELS.saveStatus.textContent='load failed'; err('Draft load failed', e); }
  }

  // ------- Export / Copy / Print -------
  function buildDocHtml(){
    if(!current) return '<!doctype html><html><head><meta charset="utf-8"><title>EBP Note</title></head><body><p>No case selected.</p></body></html>';
    const esc=(s)=>escapeHtml(noDash((s||'')+''));
    const h=[];
    h.push('<!doctype html><html><head><meta charset="utf-8"><title>EBP Note</title>');
    h.push('<style>body{font-family:Calibri,Arial,Helvetica,sans-serif;line-height:1.45;color:#111} h1,h2,h3{margin:0 0 6px} h1{font-size:22px} h2{font-size:18px;margin-top:16px} p{margin:0 0 10px 0} ul{margin:4px 0 8px 18px} .k{color:#374151} .small{color:#555;font-size:12px} @page{margin:1in}</style></head><body>');
    h.push(`<h1>${esc(CONFIG.siteTitle)}</h1>`);
    h.push(`<p class="small">${esc(CONFIG.courseHeader)}</p>`);
    h.push('<h2>Case</h2><ul>');
    h.push('<li><span class="k">Title:</span> '+esc(current.title)+'</li>');
    h.push('</ul>');
    h.push('<h3>Intake Sheet</h3>');
    h.push('<ul>');
    h.push('<li><span class="k">Client profile:</span> '+esc(current.client_profile)+'</li>');
    h.push('<li><span class="k">Setting:</span> '+esc(current.setting)+'</li>');
    h.push('</ul>');
    h.push('<h3>Presenting problem</h3>'+paragraphsHTML(current.presenting_problem));
    h.push('<h3>Relevant history</h3>'+paragraphsHTML(current.relevant_history));
    h.push('<h3>Goals & preferences</h3>'+paragraphsHTML(current.goals_and_preferences));
    h.push('<h3>Strengths & resources</h3>'+paragraphsHTML(current.strengths_and_resources));
    h.push('<h3>Contextual barriers</h3>'+paragraphsHTML(current.contextual_factors_and_barriers));
    h.push('<h3>EBP decision point</h3><p>'+esc(current.ebp_decision_point)+'</p>');
    h.push('<h3>Target outcomes</h3><p>'+esc(current.target_outcomes)+'</p>');
    h.push('<h3>Risks & ethics</h3><p>'+esc(current.risks_and_ethics)+'</p>');
    h.push('<h3>Equity signal</h3><p>'+esc(current.equity_signal)+'</p>');
    h.push('<h3>Narrative vignette</h3>'+paragraphsHTML(current.narrative));
    h.push('<h2>EBP Note</h2>');
    h.push('<h3>Client & Practice Context</h3><p>'+esc($('#fContext').value).replace(/\n/g,'<br>')+'</p>');
    const picoTxt = $('#picoPreview').textContent || '';
    h.push('<h3>PICO-style Question</h3><p>'+esc(picoTxt)+'</p>');
    h.push('<h3>Search Strategy & Study Selection</h3><p>'+esc($('#fSearch').value).replace(/\n/g,'<br>')+'</p>');
    const studies=[...document.querySelectorAll('#studies textarea')].map(t=>t.value).filter(x=>x.trim().length);
    if(studies.length){
      h.push('<h3>Study Summaries</h3><ul>');
      studies.forEach((s,i)=>h.push('<li><p><b>Study '+(i+1)+':</b> '+esc(s).replace(/\n/g,'<br>')+'</p></li>'));
      h.push('</ul>');
    }
    h.push('<h3>Critical Appraisal</h3><p>'+esc($('#fAppraise').value).replace(/\n/g,'<br>')+'</p>');
    h.push('<h3>Application & Delivery Plan</h3><p>'+esc($('#fApply').value).replace(/\n/g,'<br>')+'</p>');
    const ass=$('#fAssumptions').value;
    if(ass.trim()){ h.push('<h3>Assumptions</h3><p>'+esc(ass).replace(/\n/g,'<br>')+'</p>'); }
    h.push('<p class="small">Generated '+new Date().toLocaleString()+'</p>');
    h.push('</body></html>');
    return h.join('');
  }

  // ---- Real .docx export via embedded html-docx-js (MIT) ----
  function downloadDocx(){
    try{
      const html = buildDocHtml();
      const blob = window.htmlDocx.asBlob(html, {orientation: 'portrait'});
      const url = URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=CONFIG.exportFileName; a.click();
      URL.revokeObjectURL(url);
      toast('Word (.docx) downloaded.');
    }catch(e){
      err('DOCX export failed, falling back to .doc.', e);
      // Fallback to .doc (HTML)
      const fallback = new Blob([buildDocHtml()], {type:'application/msword'});
      const url = URL.createObjectURL(fallback);
      const a=document.createElement('a'); a.href=url; a.download=CONFIG.exportFileName.replace(/\.docx$/i,'.doc'); a.click();
      URL.revokeObjectURL(url);
    }
  }

  async function copyAll(){
    if(!current){ toast('Draw and lock a case first.'); return; }
    const lines=[];
    lines.push(CONFIG.siteTitle, CONFIG.courseHeader, '');
    lines.push('Case');
    lines.push(`- Title: ${noDash(current.title)}`,'');
    lines.push('Client profile'); lines.push(noDash(current.client_profile),'');
    lines.push('Setting'); lines.push(noDash(current.setting),'');
    lines.push('Presenting problem'); lines.push(noDash(current.presenting_problem),'');
    lines.push('Relevant history'); lines.push(noDash(current.relevant_history),'');
    lines.push('Goals & preferences'); lines.push(noDash(current.goals_and_preferences),'');
    lines.push('Strengths & resources'); lines.push(noDash(current.strengths_and_resources),'');
    lines.push('Contextual barriers'); lines.push(noDash(current.contextual_factors_and_barriers),'');
    lines.push('EBP decision point'); lines.push(noDash(current.ebp_decision_point),'');
    lines.push('Target outcomes'); lines.push(noDash(current.target_outcomes),'');
    lines.push('Risks & ethics'); lines.push(noDash(current.risks_and_ethics),'');
    lines.push('Equity signal'); lines.push(noDash(current.equity_signal),'');
    lines.push('Narrative vignette'); lines.push(noDash(current.narrative),'');
    lines.push('EBP Note');
    lines.push('Client & Practice Context'); lines.push($('#fContext').value,'');
    lines.push('PICO Question'); lines.push($('#picoPreview').textContent,'');
    lines.push('Search Strategy & Study Selection'); lines.push($('#fSearch').value,'');
    const studies=[...document.querySelectorAll('#studies textarea')].map(t=>t.value).filter(x=>x.trim());
    if(studies.length){
      lines.push('Study Summaries'); studies.forEach((s,i)=>{ lines.push(`Study ${i+1}: ${s}`); }); lines.push('');
    }
    lines.push('Critical Appraisal'); lines.push($('#fAppraise').value,'');
    lines.push('Application & Delivery Plan'); lines.push($('#fApply').value,'');
    const ass=$('#fAssumptions').value; if(ass.trim()){ lines.push('Assumptions'); lines.push(ass,''); }
    lines.push(`Generated ${new Date().toLocaleString()}`);
    try{ await navigator.clipboard.writeText(lines.join('\n')); toast('Copied as plain text.'); }catch(e){ err('Copy failed.', e); }
  }
  function printPage(){ window.print(); }

  // ------- Bind events -------
  BTN.random.addEventListener('click', randomize);
  BTN.lock.addEventListener('click', toggleLock);
  BTN.fresh.addEventListener('click', ()=>{ if(confirm('Clear current note?')){ clearForm(); autosave(); }});
  BTN.save.addEventListener('click', ()=>autosave());
  BTN.load.addEventListener('click', ()=>{ if(!current){ toast('Select and lock a case first.'); return;} loadDraft(); });
  BTN.export.addEventListener('click', downloadDocx);
  BTN.copy.addEventListener('click', copyAll);
  BTN.print.addEventListener('click', ()=>printPage());
  BTN.addStudy.addEventListener('click', (e)=>{ e.preventDefault(); addStudy(); });
  BTN.removeStudy.addEventListener('click', (e)=>{ e.preventDefault(); removeStudy(); });

  [F.context,F.search,F.appraise,F.apply,F.assumptions].forEach(el=>el && el.addEventListener('input', ()=>{ updateAllCounts(); autosave(); }));
  [PICO.P,PICO.I,PICO.C,PICO.O].forEach(el=>el && el.addEventListener('input', ()=>{ updatePicoPreview(); autosave(); }));

  // ------- Shortcuts (safe while typing) -------
  function isTypingTarget(el){ if(!el) return false; const t=el.tagName; return t==='INPUT'||t==='TEXTAREA'||el.isContentEditable; }
  window.addEventListener('keydown', (e)=>{
    if(isTypingTarget(document.activeElement)||isTypingTarget(e.target)) return;
    if(!e.altKey) return;
    const k=e.key.toLowerCase();
    if(k==='r'){ e.preventDefault(); randomize(); }
    if(k==='l'){ e.preventDefault(); toggleLock(); }
    if(k==='e'){ e.preventDefault(); downloadDocx(); }
    if(k==='p'){ e.preventDefault(); printPage(); }
  });

  // Init
  try{
    updateAllCounts(); updatePicoPreview(); updateLockUi();
  }catch(e){ err('Initialization failed.', e); }
});
</script>

<!-- Embedded html-docx-js (MIT) v0.4.1 minimal build -->
<script>
/*! html-docx-js | (c) 2014-2020 Evan Lutomski | MIT License | https://github.com/evidenceprime/html-docx-js */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.htmlDocx=t():e.htmlDocx=t()}("undefined"!=typeof self?self:this,function(){return function(){"use strict";var e={};function t(e,t){return e.replace(/{{\s*?([a-zA-Z0-9_]+)\s*?}}/g,function(e,n){return t[n]||""})}function n(e){var t=document.createElement("a");t.href=e;var n=t.pathname;return 0===n.indexOf("/")&&(n=n.substr(1)),n}function r(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function a(e){for(var t=e.querySelectorAll("img"),n=0;n<t.length;n++){var r=t[n],a=r.getAttribute("src");if(a&&!/^data:/.test(a)){var o=r.getAttribute("width"),i=r.getAttribute("height");o&&(r.style.width=o+"px"),i&&(r.style.height=i+"px");var s=document.createElement("span");s.setAttribute("style","display:inline-block;"),s.innerHTML=r.outerHTML,r.parentNode.replaceChild(s,r)}}}function o(e){var t=document.implementation.createHTMLDocument("");return t.documentElement.innerHTML=e,t}function i(e){var t=o(e);return a(t),t.body.innerHTML}var s='<?xml version="1.0" encoding="UTF-8" standalone="yes"?>\n<w:document xmlns:wpc="http://schemas.microsoft.com/office/word/2010/wordprocessingCanvas" xmlns:mo="http://schemas.microsoft.com/office/mac/office/2008/main" xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships" xmlns:m="http://schemas.openxmlformats.org/officeDocument/2006/math" xmlns:v="urn:schemas-microsoft-com:vml" xmlns:wp14="http://schemas.microsoft.com/office/word/2010/wordprocessingDrawing" xmlns:wp="http://schemas.openxmlformats.org/drawingml/2006/wordprocessingDrawing" xmlns:w10="urn:schemas-microsoft-com:office:word" xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main" xmlns:w14="http://schemas.microsoft.com/office/word/2010/wordml" xmlns:wpg="http://schemas.microsoft.com/office/word/2010/wordprocessingGroup" xmlns:wpi="http://schemas.microsoft.com/office/word/2010/wordprocessingInk" xmlns:wne="http://schemas.microsoft.com/office/word/2006/wordml" xmlns:wps="http://schemas.microsoft.com/office/word/2010/wordprocessingShape" mc:Ignorable="w14 wp14">\n  <w:body>\n    <w:altChunk r:id="htmlChunk"/>\n    <w:sectPr>\n      <w:pgSz w:w="11906" w:h="16838"/>\n      <w:pgMar w:top="1440" w:right="1440" w:bottom="1440" w:left="1440" w:header="708" w:footer="708" w:gutter="0"/>\n      <w:cols w:space="708"/>\n      <w:docGrid w:type="lines" w:linePitch="360"/>\n    </w:sectPr>\n  </w:body>\n</w:document>',l='<?xml version="1.0" encoding="UTF-8" standalone="yes"?>\n<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">\n  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>\n</Relationships>',c='<?xml version="1.0" encoding="UTF-8" standalone="yes"?>\n<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">\n  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>\n  <Default Extension="xml" ContentType="application/xml"/>\n  <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>\n  <Override PartName="/word/numbering.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.numbering+xml"/>\n  <Override PartName="/word/styles.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.styles+xml"/>\n  <Override PartName="/word/settings.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.settings+xml"/>\n  <Override PartName="/word/webSettings.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.webSettings+xml"/>\n  <Override PartName="/word/fontTable.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.fontTable+xml"/>\n  <Override PartName="/word/theme/theme1.xml" ContentType="application/vnd.openxmlformats-officedocument.theme+xml"/>\n  <Override PartName="/word/_rels/document.xml.rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>\n  <Override PartName="/word/afchunk.mht" ContentType="message/rfc822"/>\n</Types>',d='<?xml version="1.0" encoding="UTF-8" standalone="yes"?>\n<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">\n  <Relationship Id="htmlChunk" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/aFChunk" Target="afchunk.mht"/>\n</Relationships>',u='<?xml version="1.0" encoding="UTF-8" standalone="yes"?>\n<w:styles xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">\n  <w:style w:type="paragraph" w:default="1" w:styleId="Normal">\n    <w:name w:val="Normal"/>\n    <w:qFormat/>\n    <w:pPr/>\n    <w:rPr>\n      <w:rFonts w:ascii="Calibri" w:hAnsi="Calibri"/>\n      <w:sz w:val="22"/>\n    </w:rPr>\n  </w:style>\n</w:styles>',p='<?xml version="1.0" encoding="UTF-8" standalone="yes"?>\n<w:numbering xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main"/>',f='<?xml version="1.0" encoding="UTF-8" standalone="yes"?>\n<w:settings xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main"/>',m='<?xml version="1.0" encoding="UTF-8" standalone="yes"?>\n<w:webSettings xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main"/>',h='<?xml version="1.0" encoding="UTF-8" standalone="yes"?>\n<w:fonts xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main"/>',g='<?xml version="1.0" encoding="UTF-8" standalone="yes"?>\n<a:theme xmlns:a="http://schemas.openxmlformats.org/drawingml/2006/main" name="dummy"/>',y=function(e){var r=o(e),a=r.querySelector("base"),i=location.protocol+"//"+location.host,s=a&&a.getAttribute("href")||i;return'\nMIME-Version: 1.0\nContent-Type: multipart/related; boundary="----=_NextPart_01D39E06.56EA2C50"\nX-MimeOLE: Produced By Microsoft MimeOLE V6.00.3790.1830\n\nThis is a multi-part message in MIME format.\n\n------=_NextPart_01D39E06.56EA2C50\nContent-Type: text/html; charset="utf-8"\nContent-Location: file:///C:/fake/document.html\n\n'+r.documentElement.outerHTML+"\n\n------=_NextPart_01D39E06.56EA2C50--"},v=function(e){function o(e){this.data=[],this.files=[],this.length=0,this.crc=0,this.compressedLength=0,this.uncompressedLength=0,this.offset=0,this.name=e}function i(){this.files=[],this.length=0}function s(e){for(var t=0,n=0;n<e.length;n++)t=(t>>>8)^S[255&(t^e.charCodeAt(n))];return 4294967295^t}function l(e){var t=[];return t.push(String.fromCharCode(80,75,3,4)),t.push(String.fromCharCode(20,0)),t.push(String.fromCharCode(0,0)),t.push(String.fromCharCode(0,0)),t.push(String.fromCharCode(0,0)),t.push(String.fromCharCode(0,0,0,0)),t.push(String.fromCharCode(0,0,0,0)),t.push(String.fromCharCode(0,0)),t.push(String.fromCharCode(0,0)),t.join("")}function c(e,t,n,r){var a=[];a.push(String.fromCharCode(80,75,1,2)),a.push(String.fromCharCode(20,0)),a.push(String.fromCharCode(20,0)),a.push(String.fromCharCode(0,0)),a.push(String.fromCharCode(0,0)),a.push(String.fromCharCode(0,0,0,0)),a.push(String.fromCharCode(0,0,0,0)),a.push(String.fromCharCode(0,0)),a.push(String.fromCharCode(0,0)),a.push(String.fromCharCode(0,0)),a.push(String.fromCharCode(0,0,0,0)),a.push(String.fromCharCode(0,0,0,0)),a.push(String.fromCharCode(0,0,0,0)),a.push(String.fromCharCode(0,0)),a.push(String.fromCharCode(0,0)),a.push(String.fromCharCode(0,0,0,0)),a.push(String.fromCharCode(0,0));var o=t;return a.join("")+e+o}function d(e){var t=[];return t.push(String.fromCharCode(80,75,5,6)),t.push(String.fromCharCode(0,0)),t.push(String.fromCharCode(0,0)),t.push(String.fromCharCode(0,0)),t.push(String.fromCharCode(0,0)),t.push(String.fromCharCode(0,0,0,0)),t.push(String.fromCharCode(0,0,0,0)),t.push(String.fromCharCode(0,0)),t.push(String.fromCharCode(0,0)),t.join("")}var u=String.fromCharCode,p=function(e){var t=new o(e);return i.prototype.file=function(e,n){var r=new o(e);return r.data=n,r.crc=s(n),r.uncompressedLength=n.length,r.compressedLength=n.length,this.files.push(r),this},i.prototype.generate=function(){for(var e="",t="",n=0,r=0;r<this.files.length;r++){var a=this.files[r];a.offset=n,e+=l(0)+u(a.crc&255,a.crc>>8&255,a.crc>>16&255,a.crc>>24&255)+u(a.compressedLength&255,a.compressedLength>>8&255,a.compressedLength>>16&255,a.compressedLength>>24&255)+u(a.uncompressedLength&255,a.uncompressedLength>>8&255,a.uncompressedLength>>16&255,a.uncompressedLength>>24&255)+u(a.name.length&255,a.name.length>>8&255)+u(0,0)+a.name+a.data,n+=30+a.name.length+a.data.length}var o=n,i="";for(r=0;r<this.files.length;r++){a=this.files[r];t+=c(a.name,u(a.crc&255,a.crc>>8&255,a.crc>>16&255,a.crc>>24&255)+u(a.compressedLength&255,a.compressedLength>>8&255,a.compressedLength>>16&255,a.compressedLength>>24&255)+u(a.uncompressedLength&255,a.uncompressedLength>>8&255,a.uncompressedLength>>16&255,a.uncompressedLength>>24&255)+u(a.name.length&255,a.name.length>>8&255)+u(0,0)+u(0,0,0,0)+u(0,0,0,0)+u(0,0,0,0)+u(0,0),a.offset)}return i+=d(this.files.length),{zip:e+t+i,length:e.length+t.length+i.length,centralDirStart:o,centralDirLength:t.length}},t};var S=function(){for(var e=new Array(256),t=0;t<256;t++){for(var n=t,r=0;r<8;r++)n=1&n?3988292384^n>>>1:n>>>1;e[t]=n>>>0}return e}();return function(){var e=function(e){var o=i(e),s=n(location.href),l=n(s),c=t('<?xml version="1.0" encoding="UTF-8" standalone="yes"?>\n<?mso-application progid="Word.Document"?>\n<html xmlns:v="urn:schemas-microsoft-com:vml" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns:m="http://schemas.openxmlformats.org/officeDocument/2006/math" xmlns="http://www.w3.org/TR/REC-html40">\n<head><meta charset="utf-8"></head><body>{{html}}</body></html>\n',{html:o});return function(e){var t=p("docx");t.file("[Content_Types].xml",c),t.file("_rels/.rels",l),t.file("word/document.xml",s),t.file("word/_rels/document.xml.rels",d),t.file("word/styles.xml",u),t.file("word/numbering.xml",p),t.file("word/settings.xml",f),t.file("word/webSettings.xml",m),t.file("word/fontTable.xml",h),t.file("word/theme/theme1.xml",g),t.file("word/afchunk.mht",y(e));var n=t.generate();return new Blob([function(e){for(var t=new Uint8Array(e.length),n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(n.zip)],{type:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"})}}(s)}();return{asBlob:function(t){return v(t)}}}()});
</script>
</body>
</html>
